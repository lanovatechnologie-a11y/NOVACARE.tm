<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Système de Gestion Hospitalier</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Styles CSS inchangés */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f0f7ff; color: #333; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        .header { background: linear-gradient(135deg, #1a6bca 0%, #0d4d9c 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        .logo { display: flex; align-items: center; gap: 15px; }
        .logo i { font-size: 2.2rem; }
        .logo h1 { font-size: 1.8rem; font-weight: 700; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .logout-btn { background-color: #ff6b6b; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 600; }
        
        /* Navigation */
        .nav-tabs { display: flex; background-color: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); margin-bottom: 25px; flex-wrap: wrap; }
        .nav-tab { flex: 1; text-align: center; padding: 15px 10px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; color: #555; border-bottom: 3px solid transparent; min-width: 100px; }
        .nav-tab:hover { background-color: #f5f9ff; }
        .nav-tab.active { color: #1a6bca; border-bottom: 3px solid #1a6bca; background-color: #f0f7ff; }
        
        /* Content */
        .content { background-color: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 25px; min-height: 500px; display: none; }
        .content.active { display: block; }
        .section-title { color: #1a6bca; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #eef5ff; font-size: 1.5rem; }
        
        /* Forms & Buttons */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #444; }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; transition: border 0.3s; }
        .form-control:focus { outline: none; border-color: #1a6bca; }
        .btn { padding: 12px 25px; background-color: #1a6bca; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.3s ease; }
        .btn:hover { background-color: #0d4d9c; transform: translateY(-2px); }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #218838; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #e0a800; }
        
        /* Cards & Layouts */
        .card { background-color: #f8fbff; border-radius: 8px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #1a6bca; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); }
        .card h3 { color: #1a6bca; margin-bottom: 10px; }
        .d-flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .hidden { display: none !important; }
        .mt-2 { margin-top: 10px; }
        .mt-3 { margin-top: 15px; }
        .mb-2 { margin-bottom: 10px; }
        .mb-3 { margin-bottom: 15px; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        
        /* Tables */
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eef5ff; }
        th { background-color: #f0f7ff; color: #1a6bca; font-weight: 600; }
        tr:hover { background-color: #f8fbff; }
        
        /* Dashboard Stats */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); display: flex; align-items: center; gap: 15px; }
        .stat-icon { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; }
        .stat-info h3 { font-size: 1.8rem; margin-bottom: 5px; color: #333; }
        .stat-info p { color: #777; font-weight: 600; }

        /* Login */
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #1a6bca 0%, #0d4d9c 100%); }
        .login-box { background-color: white; width: 100%; max-width: 450px; padding: 40px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
        .login-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px; }
        .login-role-btn { padding: 15px; background-color: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .login-role-btn.active { background-color: #1a6bca; color: white; border-color: #1a6bca; }
        
        /* Alerts */
        .alert { padding: 12px 15px; border-radius: 5px; margin-bottom: 20px; position: relative; }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .alert-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .alert-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Specific Elements */
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eef5ff; }
        .setting-actions { display: flex; gap: 10px; }
        .service-price { display: inline-block; background-color: #e7f3ff; color: #1a6bca; padding: 3px 8px; border-radius: 4px; font-weight: 600; margin-left: 10px; font-size: 0.9rem; }
        .emergency-patient-tag { background-color: #dc3545; color: white; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .pediatric-tag { background-color: #17a2b8; color: white; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        
        /* New Styles */
        .payment-method-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .payment-method { border: 2px solid #ddd; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; }
        .payment-method.active { border-color: #1a6bca; background-color: #f0f7ff; }
        .service-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #eef5ff; border-radius: 5px; margin-bottom: 5px; }
        .service-item.selected { background-color: #e7f3ff; border-color: #1a6bca; }
        .check-availability-btn { margin-left: 10px; padding: 5px 10px; background-color: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .admin-stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .admin-stat-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cashier-total { background-color: #e7f3ff; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center; }
        
        /* Signes vitaux grid */
        .vitals-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
        .vital-item { border: 1px solid #eef5ff; padding: 15px; border-radius: 8px; }
        
        /* Patient card */
        .patient-card { width: 350px; border: 2px solid #1a6bca; border-radius: 10px; padding: 20px; background: white; }
        .patient-card-header { background: #1a6bca; color: white; padding: 15px; margin: -20px -20px 20px -20px; border-radius: 8px 8px 0 0; }
        .patient-photo { width: 100px; height: 100px; background: #ddd; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; }
        
        /* Print */
        @media print {
            body * { visibility: hidden; }
            .printable, .printable * { visibility: visible; }
            .printable { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            .print-receipt { width: 80mm; font-size: 12px; }
        }
        
        /* Nouvelles classes */
        .small-input { width: 80px; }
        .vitals-form { background: #f8fbff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .employee-form { background: #f8fbff; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .hospital-info-form { background: #f8fbff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .print-controls { margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; }
        .medication-out-stock { background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .receipt-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ddd; }
        .receipt-total { font-weight: bold; font-size: 1.2rem; margin-top: 10px; }
        
        /* Nouveaux styles pour les modifications demandées */
        .appointment-form { background: #f8fbff; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .appointment-list { max-height: 400px; overflow-y: auto; }
        .appointment-item { border: 1px solid #eef5ff; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white; }
        .appointment-status { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .status-pending { background-color: #ffc107; color: #212529; }
        .status-confirmed { background-color: #28a745; color: white; }
        .status-cancelled { background-color: #dc3545; color: white; }
        .status-completed { background-color: #17a2b8; color: white; }
        
        /* Messagerie */
        .messages-container { display: flex; gap: 20px; }
        .message-list { flex: 1; max-height: 500px; overflow-y: auto; border: 1px solid #eef5ff; border-radius: 8px; padding: 15px; }
        .message-details { flex: 2; border: 1px solid #eef5ff; border-radius: 8px; padding: 15px; }
        .message-item { padding: 10px; border-bottom: 1px solid #eef5ff; cursor: pointer; }
        .message-item:hover { background-color: #f8fbff; }
        .message-item.unread { background-color: #e7f3ff; font-weight: bold; }
        .message-sender { color: #1a6bca; font-weight: 600; }
        .message-time { color: #777; font-size: 0.9rem; }
        .message-content { margin-top: 10px; padding: 10px; background-color: #f8fbff; border-radius: 5px; }
        .new-message-form { margin-top: 20px; }
        
        /* Résultats images */
        .image-preview { max-width: 300px; max-height: 300px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .upload-btn-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .result-type-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 10px; }
        .result-type-text { background-color: #17a2b8; color: white; }
        .result-type-image { background-color: #28a745; color: white; }
        
        /* Service selection */
        .service-category { margin-bottom: 20px; }
        .service-category h4 { color: #1a6bca; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #eef5ff; }
    </style>
</head>
<body>
    <div id="login-screen" class="login-container">
        <div class="login-box">
            <div class="text-center mb-3">
                <i class="fas fa-hospital-alt fa-3x" style="color: #1a6bca;"></i>
                <h2 style="color: #1a6bca;" id="hospital-name-login">Hôpital Saint-Luc</h2>
            </div>
            
            <div class="login-buttons">
                <div class="login-role-btn active" data-role="admin"><i class="fas fa-user-shield"></i><p>Admin</p></div>
                <div class="login-role-btn" data-role="doctor"><i class="fas fa-user-md"></i><p>Docteur</p></div>
                <div class="login-role-btn" data-role="lab"><i class="fas fa-flask"></i><p>Labo</p></div>
                <div class="login-role-btn" data-role="pharmacy"><i class="fas fa-pills"></i><p>Pharmacie</p></div>
                <div class="login-role-btn" data-role="reception"><i class="fas fa-user-tie"></i><p>Réception</p></div>
                <div class="login-role-btn" data-role="cashier"><i class="fas fa-cash-register"></i><p>Caisse</p></div>
            </div>
            
            <form id="login-form">
                <div class="form-group">
                    <label class="form-label">Nom d'utilisateur</label>
                    <input type="text" id="username" class="form-control" placeholder="admin" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Mot de passe</label>
                    <input type="password" id="password" class="form-control" placeholder="1234" required>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Se Connecter</button>
            </form>
        </div>
    </div>
    
    <div id="main-app" class="hidden">
        <div class="container">
            <header class="header">
                <div class="logo">
                    <i class="fas fa-hospital-alt"></i>
                    <div><h1 id="hospital-name-header">Hôpital Saint-Luc</h1><p id="hospital-address-header">Système de Gestion</p></div>
                </div>
                <div class="user-info">
                    <div>
                        <p id="current-user-role">Administrateur</p>
                        <p><strong id="current-username">User</strong></p>
                    </div>
                    <button id="logout-btn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Déconnexion</button>
                </div>
            </header>
            
            <nav class="nav-tabs no-print">
                <div class="nav-tab active" data-target="dashboard"><i class="fas fa-tachometer-alt"></i> Accueil</div>
                <div class="nav-tab" data-target="patients"><i class="fas fa-user-injured"></i> Patients</div>
                <div class="nav-tab" data-target="consultation"><i class="fas fa-stethoscope"></i> Consultation</div>
                <div class="nav-tab" data-target="appointments"><i class="fas fa-calendar-check"></i> RDV</div>
                <div class="nav-tab" data-target="laboratory"><i class="fas fa-flask"></i> Laboratoire</div>
                <div class="nav-tab" data-target="pharmacy"><i class="fas fa-pills"></i> Pharmacie</div>
                <div class="nav-tab" data-target="cashier"><i class="fas fa-cash-register"></i> Caisse</div>
                <div class="nav-tab" data-target="administration"><i class="fas fa-chart-bar"></i> Admin</div>
                <div class="nav-tab" data-target="settings"><i class="fas fa-cog"></i> Paramètres</div>
                <div class="nav-tab" data-target="messages" id="messages-tab"><i class="fas fa-envelope"></i> Messages</div>
            </nav>
            
            <section id="dashboard" class="content active">
                <h2 class="section-title">Tableau de Bord</h2>
                <div class="stats-container">
                    <div class="stat-card"><div class="stat-icon" style="background:#1a6bca"><i class="fas fa-user-injured"></i></div><div class="stat-info"><h3 id="stat-patients">0</h3><p>Patients</p></div></div>
                    <div class="stat-card"><div class="stat-icon" style="background:#28a745"><i class="fas fa-stethoscope"></i></div><div class="stat-info"><h3 id="stat-consultations">0</h3><p>Consultations</p></div></div>
                    <div class="stat-card"><div class="stat-icon" style="background:#dc3545"><i class="fas fa-flask"></i></div><div class="stat-info"><h3 id="stat-analyses">0</h3><p>Analyses</p></div></div>
                </div>
                <div id="notifications-list"></div>
            </section>
            
            <section id="patients" class="content">
                <h2 class="section-title">Gestion des Patients</h2>
                <div class="card">
                    <h3>Nouveau Patient</h3>
                    <form id="patient-form">
                        <div class="d-flex" style="gap:20px">
                            <div style="flex:1"><label class="form-label">Nom complet</label><input type="text" id="patient-name" class="form-control" required></div>
                            <div style="flex:1"><label class="form-label">Date naissance</label><input type="date" id="patient-dob" class="form-control" required></div>
                        </div>
                        <div class="mt-2"><label class="form-label">Téléphone</label><input type="text" id="patient-phone" class="form-control"></div>
                        <div class="mt-2">
                            <label><input type="checkbox" id="patient-emergency"> Urgence</label>
                            <label style="margin-left:20px"><input type="checkbox" id="patient-pediatric"> Pédiatrie</label>
                        </div>
                        <button type="submit" class="btn mt-3">Enregistrer</button>
                        <button type="button" id="generate-patient-card-btn" class="btn btn-secondary mt-3 hidden">Générer Carte Patient</button>
                    </form>
                </div>
                <div class="card">
                    <h3>Liste des Patients</h3>
                    <div class="table-container">
                        <table id="patients-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nom</th>
                                    <th>Date Naissance</th>
                                    <th>Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="patients-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Carte patient (masquée par défaut) -->
                <div id="patient-card-container" class="hidden printable">
                    <div class="patient-card">
                        <div class="patient-card-header text-center">
                            <h3 id="card-hospital-name">Hôpital Saint-Luc</h3>
                            <p id="card-hospital-address">Port-au-Prince, Haïti</p>
                        </div>
                        <div class="patient-photo">
                            <i class="fas fa-user fa-3x" style="color:#666;"></i>
                        </div>
                        <div class="text-center">
                            <h4 id="card-patient-name">Jean Dupont</h4>
                            <p><strong>ID:</strong> <span id="card-patient-id">PA0001</span></p>
                            <p><strong>Date Naissance:</strong> <span id="card-patient-dob">01/01/1980</span></p>
                            <p><strong>Téléphone:</strong> <span id="card-patient-phone">12345678</span></p>
                            <p><strong>Date d'émission:</strong> <span id="card-issue-date">01/01/2024</span></p>
                            <div class="mt-3">
                                <span id="card-patient-type" class="emergency-patient-tag">URGENCE</span>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <p><small>Cette carte doit être présentée à chaque visite</small></p>
                            <p><small>Valable pour 1 an à partir de la date d'émission</small></p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="consultation" class="content">
                <h2 class="section-title">Consultation</h2>
                <div class="card">
                    <div class="d-flex" style="gap:15px">
                        <input type="text" id="search-patient-id" class="form-control" placeholder="ID ou Nom du patient">
                        <button id="search-patient-btn" class="btn"><i class="fas fa-search"></i></button>
                    </div>
                </div>
                
                <!-- Section Signes Vitaux -->
                <div id="vitals-form-container" class="hidden vitals-form">
                    <h3>Signes Vitaux</h3>
                    <div class="vitals-grid">
                        <div><label class="form-label">Tension Artérielle</label><input type="text" id="vital-bp" class="form-control small-input" placeholder="120/80"></div>
                        <div><label class="form-label">Température (°C)</label><input type="number" id="vital-temp" class="form-control small-input" placeholder="37.0" step="0.1"></div>
                        <div><label class="form-label">Pouls (bpm)</label><input type="number" id="vital-pulse" class="form-control small-input" placeholder="72"></div>
                        <div><label class="form-label">Fréquence Resp. (rpm)</label><input type="number" id="vital-resp" class="form-control small-input" placeholder="16"></div>
                        <div><label class="form-label">Saturation O2 (%)</label><input type="number" id="vital-oxygen" class="form-control small-input" placeholder="98" min="0" max="100"></div>
                        <div><label class="form-label">Glycémie (mg/dL)</label><input type="number" id="vital-glucose" class="form-control small-input" placeholder="100"></div>
                    </div>
                    <div class="mt-2">
                        <label class="form-label">Notes</label>
                        <textarea id="vital-notes" class="form-control" rows="2" placeholder="Observations additionnelles..."></textarea>
                    </div>
                    <button type="button" id="save-vitals-btn" class="btn btn-secondary mt-2">Enregistrer Signes Vitaux</button>
                </div>
                
                <div id="consultation-form-container" class="hidden card">
                    <h3 id="cons-patient-name">Patient</h3>
                    <div id="vitals-display" class="mb-3"></div>
                    <form id="consultation-form">
                        <div class="form-group">
                            <label class="form-label">Type de Consultation</label>
                            <select id="consultation-type" class="form-control">
                                <option value="">Sélectionner un type</option>
                            </select>
                        </div>
                        
                        <label class="form-label">Diagnostic</label>
                        <textarea id="consultation-diagnosis" class="form-control" rows="3"></textarea>
                        
                        <label class="form-label mt-2">Médicaments (Format: Nom - Dosage)
                            <button type="button" id="check-medication-btn" class="check-availability-btn"><i class="fas fa-search"></i> Vérifier disponibilité</button>
                        </label>
                        <textarea id="consultation-meds" class="form-control" placeholder="Ex: Paracétamol - 500mg" rows="2"></textarea>
                        
                        <label class="form-label mt-2">Analyses demandées</label>
                        <div id="lab-analyses-selection" style="display:grid; grid-template-columns: repeat(2,1fr); gap:10px;"></div>
                        
                        <button type="submit" class="btn mt-3">Enregistrer Consultation</button>
                    </form>
                </div>
            </section>

            <section id="appointments" class="content">
                <h2 class="section-title">Gestion des Rendez-vous</h2>
                
                <div class="card appointment-form">
                    <h3>Nouveau Rendez-vous</h3>
                    <form id="appointment-form">
                        <div class="d-flex" style="gap:20px">
                            <div style="flex:1">
                                <label class="form-label">Patient</label>
                                <input type="text" id="appointment-patient-search" class="form-control" placeholder="ID ou Nom du patient">
                                <div id="patient-suggestions" class="hidden" style="border:1px solid #ddd; max-height:200px; overflow-y:auto; position:absolute; background:white; width:100%; z-index:1000;"></div>
                            </div>
                            <div style="flex:1">
                                <label class="form-label">Docteur</label>
                                <select id="appointment-doctor" class="form-control">
                                    <option value="">Sélectionner un docteur</option>
                                </select>
                            </div>
                        </div>
                        <div class="d-flex mt-2" style="gap:20px">
                            <div style="flex:1">
                                <label class="form-label">Date</label>
                                <input type="date" id="appointment-date" class="form-control" required>
                            </div>
                            <div style="flex:1">
                                <label class="form-label">Heure</label>
                                <input type="time" id="appointment-time" class="form-control" required>
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="form-label">Type de consultation</label>
                            <select id="appointment-type" class="form-control">
                                <option value="">Sélectionner un type</option>
                            </select>
                        </div>
                        <div class="mt-2">
                            <label class="form-label">Notes</label>
                            <textarea id="appointment-notes" class="form-control" rows="2" placeholder="Notes additionnelles..."></textarea>
                        </div>
                        <button type="submit" class="btn mt-3">Enregistrer RDV</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3>Liste des Rendez-vous</h3>
                    <div class="appointment-list">
                        <div id="appointments-list"></div>
                    </div>
                </div>
            </section>

            <section id="laboratory" class="content">
                <h2 class="section-title">Laboratoire</h2>
                <div class="card">
                    <h3>Recherche Patient</h3>
                    <div class="d-flex" style="gap:15px">
                        <input type="text" id="lab-patient-id" class="form-control" placeholder="Entrez ID ou Nom du patient">
                        <button type="button" id="lab-search-btn" class="btn"><i class="fas fa-search"></i> Rechercher</button>
                    </div>
                </div>
                <div id="lab-results-container" class="hidden"></div>
            </section>

            <section id="pharmacy" class="content">
                <h2 class="section-title">Pharmacie</h2>
                <div class="card">
                    <h3>Délivrance Médicaments</h3>
                    <div class="d-flex" style="gap:15px">
                        <input type="text" id="pharmacy-patient-id" class="form-control" placeholder="Entrez ID ou Nom du patient">
                        <button type="button" id="pharmacy-search-btn" class="btn"><i class="fas fa-search"></i> Rechercher</button>
                    </div>
                </div>
                <div id="pharmacy-results-container" class="hidden"></div>
                
                <div class="card mt-3">
                    <h3>Stock</h3>
                    <div class="table-container">
                        <table id="stock-table"><thead><tr><th>Médicament</th><th>Quantité</th><th>Prix</th><th>Actions</th></tr></thead><tbody id="stock-table-body"></tbody></table>
                    </div>
                    
                    <div id="add-medication-form" class="hidden mt-3">
                        <h4>Ajouter un médicament</h4>
                        <div class="d-flex" style="gap:15px">
                            <input type="text" id="new-medication-name" class="form-control" placeholder="Nom du médicament">
                            <input type="number" id="new-medication-quantity" class="form-control" placeholder="Quantité" min="1">
                            <input type="number" id="new-medication-price" class="form-control" placeholder="Prix" min="0">
                            <button type="button" id="add-medication-btn" class="btn btn-success">Ajouter</button>
                        </div>
                    </div>
                    
                    <button id="toggle-add-medication-btn" class="btn btn-secondary mt-2"><i class="fas fa-plus"></i> Ajouter Médicament</button>
                </div>
            </section>
            
            <section id="cashier" class="content">
                 <h2 class="section-title">Caisse</h2>
                 <div class="card">
                     <h3>Recherche Patient pour Paiement</h3>
                     <div class="d-flex" style="gap:15px">
                         <input type="text" id="cashier-patient-id" class="form-control" placeholder="ID ou Nom du patient">
                         <button type="button" id="cashier-search-btn" class="btn"><i class="fas fa-search"></i> Rechercher</button>
                     </div>
                 </div>
                 
                 <div id="cashier-results-container" class="hidden"></div>
                 
                 <!-- Médicaments hors stock -->
                 <div id="out-of-stock-container" class="hidden card mt-3">
                     <h3>Médicaments Hors Stock</h3>
                     <div id="out-of-stock-list"></div>
                     <div class="print-controls">
                         <button id="print-out-of-stock-btn" class="btn btn-warning"><i class="fas fa-print"></i> Imprimer Liste</button>
                     </div>
                 </div>
                 
                 <!-- Reçu global -->
                 <div id="global-receipt-container" class="hidden printable">
                     <div class="print-receipt">
                         <div class="text-center">
                             <h3 id="receipt-hospital-name">Hôpital Saint-Luc</h3>
                             <p id="receipt-hospital-address">Port-au-Prince, Haïti</p>
                             <p id="receipt-hospital-phone">Tél: (509) 1234-5678</p>
                         </div>
                         <hr>
                         <div>
                             <p><strong>Patient:</strong> <span id="receipt-patient-name">Jean Dupont</span></p>
                             <p><strong>ID Patient:</strong> <span id="receipt-patient-id">PA0001</span></p>
                             <p><strong>Date:</strong> <span id="receipt-date">01/01/2024</span></p>
                             <p><strong>Heure:</strong> <span id="receipt-time">10:30</span></p>
                         </div>
                         <hr>
                         <div id="receipt-services-list">
                             <!-- Services ajoutés dynamiquement -->
                         </div>
                         <hr>
                         <div class="receipt-item">
                             <span><strong>TOTAL:</strong></span>
                             <span><strong id="receipt-total-amount">0</strong> Gdes</span>
                         </div>
                         <div id="receipt-unpaid-section" class="hidden">
                             <hr>
                             <p><strong>Services Non Payés:</strong></p>
                             <div id="receipt-unpaid-list"></div>
                         </div>
                         <hr>
                         <div class="text-center">
                             <p><strong>Moyen de Paiement:</strong> <span id="receipt-payment-method">Cash</span></p>
                             <p>Merci pour votre confiance!</p>
                             <p><small>Reçu #<span id="receipt-number">TR001</span></small></p>
                         </div>
                     </div>
                 </div>
            </section>
            
            <section id="administration" class="content">
                <h2 class="section-title">Administration - Statistiques</h2>
                <div class="admin-stats-grid">
                    <div class="admin-stat-card">
                        <h3><i class="fas fa-money-bill-wave"></i> Revenus Totaux</h3>
                        <h2 id="total-revenue">0 Gdes</h2>
                    </div>
                    <div class="admin-stat-card">
                        <h3><i class="fas fa-stethoscope"></i> Consultations</h3>
                        <h2 id="admin-consultations">0</h2>
                        <p>Montant: <span id="consultations-amount">0 Gdes</span></p>
                    </div>
                    <div class="admin-stat-card">
                        <h3><i class="fas fa-flask"></i> Analyses</h3>
                        <h2 id="admin-analyses">0</h2>
                        <p>Montant: <span id="analyses-amount">0 Gdes</span></p>
                    </div>
                    <div class="admin-stat-card">
                        <h3><i class="fas fa-pills"></i> Médicaments</h3>
                        <h2 id="admin-medications">0</h2>
                        <p>Montant: <span id="medications-amount">0 Gdes</span></p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Statistiques par Service</h3>
                    <div class="table-container">
                        <table id="admin-services-table">
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Nombre</th>
                                    <th>Montant Total</th>
                                    <th>Moyenne par Service</th>
                                </tr>
                            </thead>
                            <tbody id="admin-services-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Transactions Récentes</h3>
                    <div class="table-container">
                        <table id="transactions-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Patient</th>
                                    <th>Services</th>
                                    <th>Montant</th>
                                    <th>Moyen de Paiement</th>
                                    <th>Agent</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="settings" class="content">
                <h2 class="section-title"><i class="fas fa-cog"></i> Paramètres du Système</h2>
                
                <div class="card">
                    <h3>Informations de l'Hôpital</h3>
                    <div class="hospital-info-form">
                        <div class="form-group">
                            <label class="form-label">Nom de l'Hôpital</label>
                            <input type="text" id="hospital-name" class="form-control" value="Hôpital Saint-Luc">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Adresse</label>
                            <input type="text" id="hospital-address" class="form-control" value="Port-au-Prince, Haïti">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Téléphone</label>
                            <input type="text" id="hospital-phone" class="form-control" value="(509) 1234-5678">
                        </div>
                        <button type="button" id="save-hospital-info-btn" class="btn btn-success">Enregistrer</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Gestion des Employés</h3>
                    <div class="table-container">
                        <table id="employees-table">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Rôle</th>
                                    <th>Identifiant</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="employees-table-body"></tbody>
                        </table>
                    </div>
                    
                    <div class="employee-form">
                        <h4>Ajouter un Employé</h4>
                        <div class="d-flex" style="gap:15px">
                            <input type="text" id="new-employee-name" class="form-control" placeholder="Nom complet">
                            <select id="new-employee-role" class="form-control">
                                <option value="">Sélectionner un rôle</option>
                                <option value="admin">Administrateur</option>
                                <option value="doctor">Docteur</option>
                                <option value="lab">Technicien Labo</option>
                                <option value="pharmacy">Pharmacien</option>
                                <option value="reception">Réceptionniste</option>
                                <option value="cashier">Caissier</option>
                            </select>
                            <input type="text" id="new-employee-id" class="form-control" placeholder="Identifiant">
                            <input type="password" id="new-employee-password" class="form-control" placeholder="Mot de passe">
                            <button type="button" id="add-employee-btn" class="btn btn-success">Ajouter</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Gestion des Services</h3>
                    
                    <div class="setting-card" style="margin-bottom:20px; border:1px solid #ddd; padding:15px; border-radius:5px;">
                        <h4>Types de Consultation</h4>
                        <div id="consultation-types-list"></div>
                        <div class="d-flex" style="gap: 15px; margin-top: 15px;">
                            <input type="text" id="new-consultation-type" class="form-control" placeholder="Nouveau type">
                            <input type="number" id="new-consultation-price" class="form-control" placeholder="Prix (Gdes)">
                            <button type="button" id="add-consultation-type-btn" class="btn btn-success"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    
                    <div class="setting-card" style="margin-bottom:20px; border:1px solid #ddd; padding:15px; border-radius:5px;">
                        <h4>Services Externes</h4>
                        <div id="external-services-list-settings"></div>
                        <div class="d-flex" style="gap: 15px; margin-top: 15px;">
                            <input type="text" id="new-external-service" class="form-control" placeholder="Nouveau service">
                            <input type="number" id="new-external-service-price" class="form-control" placeholder="Prix (Gdes)">
                            <button type="button" id="add-external-service-settings-btn" class="btn btn-success"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    
                    <div class="setting-card" style="border:1px solid #ddd; padding:15px; border-radius:5px;">
                        <h4>Analyses de Laboratoire</h4>
                        <div id="lab-analyses-list-settings"></div>
                        <div class="d-flex" style="gap: 15px; margin-top: 15px;">
                            <input type="text" id="new-lab-analysis" class="form-control" placeholder="Nouvelle analyse">
                            <input type="number" id="new-lab-analysis-price" class="form-control" placeholder="Prix (Gdes)">
                            <select id="new-lab-analysis-type" class="form-control">
                                <option value="text">Type Texte</option>
                                <option value="image">Type Image</option>
                            </select>
                            <button type="button" id="add-lab-analysis-settings-btn" class="btn btn-success"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="messages" class="content">
                <h2 class="section-title">Messagerie</h2>
                <div class="messages-container">
                    <div class="message-list">
                        <h4>Messages Reçus</h4>
                        <div id="messages-list"></div>
                    </div>
                    <div class="message-details">
                        <div id="message-detail">
                            <p class="text-center">Sélectionnez un message pour afficher son contenu</p>
                        </div>
                        <div class="new-message-form hidden">
                            <h4>Nouveau Message</h4>
                            <form id="new-message-form">
                                <div class="form-group">
                                    <label class="form-label">Destinataire</label>
                                    <select id="message-recipient" class="form-control">
                                        <option value="">Sélectionner un destinataire</option>
                                        <option value="reception">Secrétariat</option>
                                        <option value="doctor">Docteur</option>
                                        <option value="lab">Laboratoire</option>
                                        <option value="pharmacy">Pharmacie</option>
                                        <option value="cashier">Caisse</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Sujet</label>
                                    <input type="text" id="message-subject" class="form-control" placeholder="Sujet du message">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Message</label>
                                    <textarea id="message-content" class="form-control" rows="5" placeholder="Contenu du message"></textarea>
                                </div>
                                <button type="submit" class="btn">Envoyer</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button id="new-message-btn" class="btn btn-success"><i class="fas fa-plus"></i> Nouveau Message</button>
                </div>
            </section>
        </div>
    </div>
    
    <div id="print-container"></div>

<script>
// --- STATE MANAGEMENT ---
const state = {
    currentUser: null,
    currentRole: null,
    patients: [],
    consultations: [],
    analyses: [],
    prescriptions: [],
    payments: [],
    transactions: [],
    appointments: [],
    stock: [
        {id: 'MED001', medication: 'Paracétamol 500mg', quantity: 100, price: 50},
        {id: 'MED002', medication: 'Amoxicilline', quantity: 50, price: 150}
    ],
    consultationTypes: [
        { id: 1, name: 'Générale', price: 500, active: true },
        { id: 2, name: 'Pédiatrique', price: 300, active: true }
    ],
    labAnalyses: [
        { id: 1, name: 'Hémogramme', price: 300, active: true, resultType: 'text' },
        { id: 2, name: 'Malaria', price: 200, active: true, resultType: 'image' }
    ],
    externalServices: [
        { id: 1, name: 'Injection', price: 100, active: true }
    ],
    employees: [
        { id: 'EMP001', name: 'Admin Principal', role: 'admin', username: 'admin', password: '1234' },
        { id: 'EMP002', name: 'Dr. Jean Smith', role: 'doctor', username: 'doctor', password: '1234' }
    ],
    hospitalInfo: {
        name: 'Hôpital Saint-Luc',
        address: 'Port-au-Prince, Haïti',
        phone: '(509) 1234-5678'
    },
    messages: [],
    counter: 1,
    patientVitals: {}, // Stocke les signes vitaux par patientId
    outOfStockMeds: {} // Stocke les médicaments hors stock par patientId
};

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    initApp();
});

function initApp() {
    setupLogin();
    setupNavigation();
    setupPatients();
    setupConsultation();
    setupAppointments();
    setupPharmacy();
    setupLaboratory();
    setupCashier();
    setupSettings();
    setupMessages();
    loadDemoData();
    updateDashboard();
    updateAdminStats();
    updateHospitalInfoDisplay();
}

// --- LOGIN & NAVIGATION ---
function setupLogin() {
    const roleBtns = document.querySelectorAll('.login-role-btn');
    roleBtns.forEach(btn => btn.addEventListener('click', function() {
        roleBtns.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
    }));

    document.getElementById('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const selectedRole = document.querySelector('.login-role-btn.active').dataset.role;
        
        // Vérifier les identifiants
        const employee = state.employees.find(emp => 
            emp.username === username && emp.password === password && emp.role === selectedRole
        );
        
        if (!employee && !(username === 'admin' && password === '1234' && selectedRole === 'admin')) {
            showAlert("Nom d'utilisateur ou mot de passe incorrect", 'danger');
            return;
        }
        
        state.currentUser = username;
        state.currentRole = selectedRole;
        document.getElementById('current-username').textContent = employee ? employee.name : username;
        document.getElementById('current-user-role').textContent = selectedRole.toUpperCase();
        
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        
        // Hide/show tabs based on role
        const tabs = document.querySelectorAll('.nav-tab');
        tabs.forEach(tab => {
            const target = tab.dataset.target;
            
            if (state.currentRole === 'admin') {
                // Admin voit tout
                tab.style.display = 'flex';
            } else {
                // Masquer tous les onglets sauf ceux du rôle
                const roleTabs = getTabsForRole(state.currentRole);
                if (roleTabs.includes(target)) {
                    tab.style.display = 'flex';
                } else {
                    tab.style.display = 'none';
                }
                
                // Masquer aussi le dashboard si ce n'est pas admin
                if (target === 'dashboard') {
                    tab.style.display = 'flex'; // Chaque rôle voit son dashboard
                }
            }
        });
        
        // Activer le premier onglet visible
        const visibleTabs = document.querySelectorAll('.nav-tab[style="display: flex"], .nav-tab:not([style])');
        if (visibleTabs.length > 0) {
            visibleTabs.forEach(t => t.classList.remove('active'));
            visibleTabs[0].classList.add('active');
            
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById(visibleTabs[0].dataset.target).classList.add('active');
        }
        
        // Mettre à jour le dashboard selon le rôle
        updateRoleBasedDashboard();
        
        // Mettre à jour l'affichage des paramètres
        updateSettingsDisplay();
        
        // Mettre à jour les messages si l'utilisateur est réception
        if (state.currentRole === 'reception') {
            updateMessagesDisplay();
        }
    });

    document.getElementById('logout-btn').addEventListener('click', () => {
        location.reload();
    });
}

function getTabsForRole(role) {
    const roleTabs = {
        'admin': ['dashboard', 'patients', 'consultation', 'appointments', 'laboratory', 'pharmacy', 'cashier', 'administration', 'settings', 'messages'],
        'doctor': ['dashboard', 'patients', 'consultation', 'appointments', 'messages'],
        'lab': ['dashboard', 'laboratory', 'messages'],
        'pharmacy': ['dashboard', 'pharmacy', 'messages'],
        'reception': ['dashboard', 'patients', 'appointments', 'messages'],
        'cashier': ['dashboard', 'cashier', 'messages']
    };
    
    return roleTabs[role] || ['dashboard'];
}

function setupNavigation() {
    const tabs = document.querySelectorAll('.nav-tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById(this.dataset.target).classList.add('active');
            
            // Mettre à jour les statistiques admin si on accède à cette section
            if (this.dataset.target === 'administration' && state.currentRole === 'admin') {
                updateAdminStats();
            }
            
            // Mettre à jour les messages si on accède à cette section
            if (this.dataset.target === 'messages') {
                updateMessagesDisplay();
            }
            
            // Mettre à jour les rendez-vous si on accède à cette section
            if (this.dataset.target === 'appointments' && (state.currentRole === 'doctor' || state.currentRole === 'reception' || state.currentRole === 'admin')) {
                updateAppointmentsList();
                loadDoctorsForAppointments();
                loadConsultationTypesForAppointments();
            }
        });
    });
}

function updateRoleBasedDashboard() {
    const dashboardSection = document.getElementById('dashboard');
    const statsContainer = document.querySelector('.stats-container');
    
    // Masquer le contenu générique et afficher le contenu spécifique au rôle
    dashboardSection.innerHTML = `<h2 class="section-title">Tableau de Bord - ${state.currentRole.toUpperCase()}</h2>`;
    
    // Ajouter des statistiques spécifiques au rôle
    if (state.currentRole === 'admin') {
        dashboardSection.innerHTML += `
            <div class="stats-container">
                <div class="stat-card"><div class="stat-icon" style="background:#1a6bca"><i class="fas fa-user-injured"></i></div><div class="stat-info"><h3 id="stat-patients">0</h3><p>Patients</p></div></div>
                <div class="stat-card"><div class="stat-icon" style="background:#28a745"><i class="fas fa-stethoscope"></i></div><div class="stat-info"><h3 id="stat-consultations">0</h3><p>Consultations</p></div></div>
                <div class="stat-card"><div class="stat-icon" style="background:#dc3545"><i class="fas fa-flask"></i></div><div class="stat-info"><h3 id="stat-analyses">0</h3><p>Analyses</p></div></div>
                <div class="stat-card"><div class="stat-icon" style="background:#ffc107"><i class="fas fa-money-bill-wave"></i></div><div class="stat-info"><h3 id="stat-revenue">0 Gdes</h3><p>Revenus</p></div></div>
            </div>
        `;
        updateDashboard();
    } else if (state.currentRole === 'doctor') {
        dashboardSection.innerHTML += `
            <div class="stats-container">
                <div class="stat-card"><div class="stat-icon" style="background:#1a6bca"><i class="fas fa-user-injured"></i></div><div class="stat-info"><h3 id="stat-my-patients">0</h3><p>Mes Patients Aujourd'hui</p></div></div>
                <div class="stat-card"><div class="stat-icon" style="background:#28a745"><i class="fas fa-stethoscope"></i></div><div class="stat-info"><h3 id="stat-my-consultations">0</h3><p>Consultations</p></div></div>
                <div class="stat-card"><div class="stat-icon" style="background:#17a2b8"><i class="fas fa-calendar-check"></i></div><div class="stat-info"><h3 id="stat-my-appointments">0</h3><p>RDV Aujourd'hui</p></div></div>
            </div>
            <div class="card mt-3">
                <h3>Mes Consultations Récentes</h3>
                <div id="my-recent-consultations"></div>
            </div>
        `;
        updateDoctorDashboard();
    } else if (state.currentRole === 'lab') {
        dashboardSection.innerHTML += `
            <div class="stats-container">
                <div class="stat-card"><div class="stat-icon" style="background:#dc3545"><i class="fas fa-flask"></i></div><div class="stat-info"><h3 id="stat-lab-pending">0</h3><p>Analyses en Attente</p></div></div>
                <div class="stat-card"><div class="stat-icon" style="background:#28a745"><i class="fas fa-check-circle"></i></div><div class="stat-info"><h3 id="stat-lab-completed">0</h3><p>Analyses Complétées</p></div></div>
            </div>
        `;
        updateLabDashboard();
    } else if (state.currentRole === 'pharmacy') {
        dashboardSection.innerHTML += `
            <div class="stats-container">
                <div class="stat-card"><div class="stat-icon" style="background:#17a2b8"><i class="fas fa-pills"></i></div><div class="stat-info"><h3 id="stat-pharm-pending">0</h3><p>Ordonnances en Attente</p></div></div>
                <div class="stat-card"><div class="stat-icon" style="background:#28a745"><i class="fas fa-check-circle"></i></div><div class="stat-info"><h3 id="stat-pharm-delivered">0</h3><p>Médicaments Délivrés</p></div></div>
            </div>
        `;
        updatePharmacyDashboard();
    } else if (state.currentRole === 'cashier') {
        dashboardSection.innerHTML += `
            <div class="stats-container">
                <div class="stat-card"><div class="stat-icon" style="background:#28a745"><i class="fas fa-money-bill-wave"></i></div><div class="stat-info"><h3 id="stat-cashier-today">0 Gdes</h3><p>Encaissements Aujourd'hui</p></div></div>
                <div class="stat-card"><div class="stat-icon" style="background:#1a6bca"><i class="fas fa-users"></i></div><div class="stat-info"><h3 id="stat-cashier-patients">0</h3><p>Patients Servis</p></div></div>
            </div>
        `;
        updateCashierDashboard();
    } else if (state.currentRole === 'reception') {
        dashboardSection.innerHTML += `
            <div class="stats-container">
                <div class="stat-card"><div class="stat-icon" style="background:#1a6bca"><i class="fas fa-calendar-check"></i></div><div class="stat-info"><h3 id="stat-reception-appointments">0</h3><p>RDV Aujourd'hui</p></div></div>
                <div class="stat-card"><div class="stat-icon" style="background:#28a745"><i class="fas fa-user-injured"></i></div><div class="stat-info"><h3 id="stat-reception-patients">0</h3><p>Nouveaux Patients</p></div></div>
                <div class="stat-card"><div class="stat-icon" style="background:#17a2b8"><i class="fas fa-envelope"></i></div><div class="stat-info"><h3 id="stat-reception-messages">0</h3><p>Messages Non Lus</p></div></div>
            </div>
            <div class="card mt-3">
                <h3>Prochains RDV</h3>
                <div id="reception-next-appointments"></div>
            </div>
        `;
        updateReceptionDashboard();
    }
}

function updateDoctorDashboard() {
    const today = new Date().toLocaleDateString('fr-FR');
    const myConsultations = state.consultations.filter(c => c.doctor === state.currentUser && c.date === today);
    const myPatients = [...new Set(myConsultations.map(c => c.patientId))];
    const myAppointments = state.appointments.filter(a => a.doctor === state.currentUser && a.date === today && a.status !== 'cancelled');
    
    document.getElementById('stat-my-patients').textContent = myPatients.length;
    document.getElementById('stat-my-consultations').textContent = myConsultations.length;
    document.getElementById('stat-my-appointments').textContent = myAppointments.length;
    
    const recentContainer = document.getElementById('my-recent-consultations');
    recentContainer.innerHTML = '';
    
    myConsultations.slice(0, 5).forEach(consult => {
        const patient = state.patients.find(p => p.id === consult.patientId);
        recentContainer.innerHTML += `
            <div class="service-item">
                <div>
                    <strong>${patient ? patient.name : 'Patient inconnu'}</strong><br>
                    <small>Diagnostic: ${consult.diagnosis || 'Non spécifié'}</small>
                </div>
                <div>${consult.date}</div>
            </div>
        `;
    });
}

function updateLabDashboard() {
    const pendingAnalyses = state.analyses.filter(a => !a.results && (a.status === 'paid' || a.status === 'pending-payment'));
    const completedAnalyses = state.analyses.filter(a => a.results);
    
    document.getElementById('stat-lab-pending').textContent = pendingAnalyses.length;
    document.getElementById('stat-lab-completed').textContent = completedAnalyses.length;
}

function updatePharmacyDashboard() {
    const pendingPrescriptions = state.prescriptions.filter(p => p.status === 'pending-payment' || p.status === 'paid');
    const deliveredPrescriptions = state.prescriptions.filter(p => p.status === 'delivered');
    
    document.getElementById('stat-pharm-pending').textContent = pendingPrescriptions.length;
    document.getElementById('stat-pharm-delivered').textContent = deliveredPrescriptions.length;
}

function updateCashierDashboard() {
    const today = new Date().toLocaleDateString('fr-FR');
    const todayTransactions = state.transactions.filter(t => t.date === today);
    const totalToday = todayTransactions.reduce((sum, t) => sum + t.amount, 0);
    const patientsServed = [...new Set(todayTransactions.map(t => t.patientId))].length;
    
    document.getElementById('stat-cashier-today').textContent = totalToday + ' Gdes';
    document.getElementById('stat-cashier-patients').textContent = patientsServed;
}

function updateReceptionDashboard() {
    const today = new Date().toLocaleDateString('fr-FR');
    const todayAppointments = state.appointments.filter(a => a.date === today && a.status !== 'cancelled');
    const newPatients = state.patients.filter(p => p.registrationDate === today);
    const unreadMessages = state.messages.filter(m => m.recipient === 'reception' && !m.read).length;
    
    document.getElementById('stat-reception-appointments').textContent = todayAppointments.length;
    document.getElementById('stat-reception-patients').textContent = newPatients.length;
    document.getElementById('stat-reception-messages').textContent = unreadMessages;
    
    const appointmentsContainer = document.getElementById('reception-next-appointments');
    appointmentsContainer.innerHTML = '';
    
    todayAppointments.slice(0, 5).forEach(appointment => {
        const patient = state.patients.find(p => p.id === appointment.patientId);
        appointmentsContainer.innerHTML += `
            <div class="service-item">
                <div>
                    <strong>${patient ? patient.name : 'Patient inconnu'}</strong><br>
                    <small>Heure: ${appointment.time} - Docteur: ${appointment.doctor}</small>
                </div>
                <div>
                    <span class="appointment-status status-${appointment.status}">${appointment.status}</span>
                </div>
            </div>
        `;
    });
}

// --- UTILITIES ---
function showAlert(msg, type='info') {
    alert(msg);
}

function findPatient(inputId) {
    if (!inputId) return null;
    const search = inputId.trim().toLowerCase();
    
    return state.patients.find(p => 
        p.id.toLowerCase() === search || 
        p.name.toLowerCase().includes(search)
    );
}

// --- PATIENTS ---
function setupPatients() {
    document.getElementById('patient-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = (document.getElementById('patient-emergency').checked ? 'URG' : 'PA') + 
                   state.counter.toString().padStart(4, '0');
        state.counter++;
        
        const newPatient = {
            id: id,
            name: document.getElementById('patient-name').value,
            dob: document.getElementById('patient-dob').value,
            phone: document.getElementById('patient-phone').value,
            emergency: document.getElementById('patient-emergency').checked,
            pediatric: document.getElementById('patient-pediatric').checked,
            registrationDate: new Date().toLocaleDateString('fr-FR')
        };
        state.patients.push(newPatient);
        updatePatientTable();
        showAlert(`Patient enregistré: ${id}`, 'success');
        
        // Activer le bouton pour générer la carte
        document.getElementById('generate-patient-card-btn').classList.remove('hidden');
        document.getElementById('generate-patient-card-btn').dataset.patientId = id;
        
        e.target.reset();
    });
    
    // Bouton pour générer la carte patient
    document.getElementById('generate-patient-card-btn').addEventListener('click', function() {
        const patientId = this.dataset.patientId;
        const patient = state.patients.find(p => p.id === patientId);
        
        if (patient) {
            generatePatientCard(patient);
        }
    });
}

function updatePatientTable() {
    const tbody = document.getElementById('patients-table-body');
    tbody.innerHTML = '';
    state.patients.forEach(p => {
        tbody.innerHTML += `
            <tr>
                <td>${p.id}</td>
                <td>${p.name}</td>
                <td>${p.dob}</td>
                <td>${p.emergency ? 'URGENCE' : 'Normal'}</td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="generatePatientCardById('${p.id}')">
                        <i class="fas fa-id-card"></i> Carte
                    </button>
                </td>
            </tr>`;
    });
    document.getElementById('stat-patients').textContent = state.patients.length;
}

function generatePatientCardById(patientId) {
    const patient = state.patients.find(p => p.id === patientId);
    if (patient) {
        generatePatientCard(patient);
    }
}

function generatePatientCard(patient) {
    // Mettre à jour les informations de la carte
    document.getElementById('card-hospital-name').textContent = state.hospitalInfo.name;
    document.getElementById('card-hospital-address').textContent = state.hospitalInfo.address;
    document.getElementById('card-patient-name').textContent = patient.name;
    document.getElementById('card-patient-id').textContent = patient.id;
    document.getElementById('card-patient-dob').textContent = patient.dob;
    document.getElementById('card-patient-phone').textContent = patient.phone || 'Non renseigné';
    document.getElementById('card-issue-date').textContent = new Date().toLocaleDateString('fr-FR');
    
    const typeElement = document.getElementById('card-patient-type');
    typeElement.textContent = patient.emergency ? 'URGENCE' : (patient.pediatric ? 'PÉDIATRIE' : 'STANDARD');
    typeElement.className = patient.emergency ? 'emergency-patient-tag' : (patient.pediatric ? 'pediatric-tag' : '');
    
    // Afficher la carte et l'imprimer
    const container = document.getElementById('patient-card-container');
    container.classList.remove('hidden');
    
    // Imprimer la carte
    setTimeout(() => {
        window.print();
        container.classList.add('hidden');
    }, 500);
}

// --- RENDEZ-VOUS ---
function setupAppointments() {
    document.getElementById('appointment-form').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const patientSearch = document.getElementById('appointment-patient-search').value;
        const patient = findPatient(patientSearch);
        
        if (!patient) {
            showAlert("Patient non trouvé. Veuillez entrer un ID ou nom valide.", 'danger');
            return;
        }
        
        const doctor = document.getElementById('appointment-doctor').value;
        const date = document.getElementById('appointment-date').value;
        const time = document.getElementById('appointment-time').value;
        const type = document.getElementById('appointment-type').value;
        const notes = document.getElementById('appointment-notes').value;
        
        if (!doctor || !date || !time || !type) {
            showAlert("Veuillez remplir tous les champs obligatoires.", 'warning');
            return;
        }
        
        const appointmentId = 'RDV' + Date.now();
        const newAppointment = {
            id: appointmentId,
            patientId: patient.id,
            patientName: patient.name,
            doctor: doctor,
            date: date,
            time: time,
            type: type,
            notes: notes,
            status: 'pending',
            createdBy: state.currentUser,
            createdAt: new Date().toLocaleString('fr-FR')
        };
        
        state.appointments.push(newAppointment);
        updateAppointmentsList();
        showAlert("Rendez-vous créé avec succès", 'success');
        
        // Réinitialiser le formulaire
        e.target.reset();
    });
    
    // Recherche de patient avec suggestions
    const patientSearchInput = document.getElementById('appointment-patient-search');
    patientSearchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const suggestionsDiv = document.getElementById('patient-suggestions');
        
        if (searchTerm.length < 2) {
            suggestionsDiv.classList.add('hidden');
            return;
        }
        
        const filteredPatients = state.patients.filter(p => 
            p.name.toLowerCase().includes(searchTerm) || 
            p.id.toLowerCase().includes(searchTerm)
        ).slice(0, 5);
        
        if (filteredPatients.length > 0) {
            suggestionsDiv.innerHTML = '';
            filteredPatients.forEach(p => {
                suggestionsDiv.innerHTML += `
                    <div class="suggestion-item" style="padding:5px 10px; cursor:pointer;" 
                         onclick="selectPatientForAppointment('${p.id}', '${p.name}')">
                        ${p.name} (${p.id})
                    </div>
                `;
            });
            suggestionsDiv.classList.remove('hidden');
        } else {
            suggestionsDiv.classList.add('hidden');
        }
    });
}

function selectPatientForAppointment(patientId, patientName) {
    document.getElementById('appointment-patient-search').value = `${patientName} (${patientId})`;
    document.getElementById('patient-suggestions').classList.add('hidden');
}

function loadDoctorsForAppointments() {
    const doctorSelect = document.getElementById('appointment-doctor');
    doctorSelect.innerHTML = '<option value="">Sélectionner un docteur</option>';
    
    // Filtrer les employés avec rôle docteur
    const doctors = state.employees.filter(emp => emp.role === 'doctor');
    doctors.forEach(doctor => {
        doctorSelect.innerHTML += `<option value="${doctor.name}">${doctor.name}</option>`;
    });
}

function loadConsultationTypesForAppointments() {
    const typeSelect = document.getElementById('appointment-type');
    typeSelect.innerHTML = '<option value="">Sélectionner un type</option>';
    
    state.consultationTypes.forEach(type => {
        if (type.active) {
            typeSelect.innerHTML += `<option value="${type.name}">${type.name}</option>`;
        }
    });
}

function updateAppointmentsList() {
    const appointmentsList = document.getElementById('appointments-list');
    appointmentsList.innerHTML = '';
    
    // Filtrer les rendez-vous selon le rôle
    let filteredAppointments = [];
    
    if (state.currentRole === 'doctor') {
        filteredAppointments = state.appointments.filter(a => a.doctor === state.currentUser);
    } else if (state.currentRole === 'reception' || state.currentRole === 'admin') {
        filteredAppointments = state.appointments;
    }
    
    if (filteredAppointments.length === 0) {
        appointmentsList.innerHTML = '<p class="text-center">Aucun rendez-vous trouvé</p>';
        return;
    }
    
    // Trier par date et heure
    filteredAppointments.sort((a, b) => {
        const dateA = new Date(a.date + ' ' + a.time);
        const dateB = new Date(b.date + ' ' + b.time);
        return dateA - dateB;
    });
    
    filteredAppointments.forEach(appointment => {
        const statusClass = `status-${appointment.status}`;
        const statusText = appointment.status === 'pending' ? 'En attente' : 
                          appointment.status === 'confirmed' ? 'Confirmé' : 
                          appointment.status === 'cancelled' ? 'Annulé' : 
                          appointment.status === 'completed' ? 'Terminé' : appointment.status;
        
        appointmentsList.innerHTML += `
            <div class="appointment-item">
                <div class="d-flex justify-between">
                    <div>
                        <h4>${appointment.patientName} (${appointment.patientId})</h4>
                        <p><strong>Docteur:</strong> ${appointment.doctor}</p>
                        <p><strong>Date:</strong> ${appointment.date} à ${appointment.time}</p>
                        <p><strong>Type:</strong> ${appointment.type}</p>
                        ${appointment.notes ? `<p><strong>Notes:</strong> ${appointment.notes}</p>` : ''}
                    </div>
                    <div>
                        <span class="appointment-status ${statusClass}">${statusText}</span>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-success" onclick="updateAppointmentStatus('${appointment.id}', 'confirmed')">
                                Confirmer
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="updateAppointmentStatus('${appointment.id}', 'cancelled')">
                                Annuler
                            </button>
                            <button class="btn btn-sm btn-info" onclick="updateAppointmentStatus('${appointment.id}', 'completed')">
                                Terminer
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <small>Créé par ${appointment.createdBy} le ${appointment.createdAt}</small>
                </div>
            </div>
        `;
    });
}

function updateAppointmentStatus(appointmentId, status) {
    const appointment = state.appointments.find(a => a.id === appointmentId);
    if (appointment) {
        appointment.status = status;
        updateAppointmentsList();
        showAlert(`Statut du rendez-vous mis à jour: ${status}`, 'success');
    }
}

// --- SETTINGS ---
function setupSettings() {
    // Sauvegarde des informations de l'hôpital
    document.getElementById('save-hospital-info-btn').addEventListener('click', function() {
        state.hospitalInfo.name = document.getElementById('hospital-name').value;
        state.hospitalInfo.address = document.getElementById('hospital-address').value;
        state.hospitalInfo.phone = document.getElementById('hospital-phone').value;
        
        updateHospitalInfoDisplay();
        showAlert("Informations de l'hôpital mises à jour", 'success');
    });
    
    // Gestion des employés
    document.getElementById('add-employee-btn').addEventListener('click', function() {
        const name = document.getElementById('new-employee-name').value;
        const role = document.getElementById('new-employee-role').value;
        const empId = document.getElementById('new-employee-id').value;
        const password = document.getElementById('new-employee-password').value;
        
        if (!name || !role || !empId || !password) {
            showAlert("Veuillez remplir tous les champs", 'warning');
            return;
        }
        
        state.employees.push({
            id: empId,
            name: name,
            role: role,
            username: empId.toLowerCase(),
            password: password
        });
        
        updateEmployeesTable();
        showAlert("Employé ajouté avec succès", 'success');
        
        // Réinitialiser le formulaire
        document.getElementById('new-employee-name').value = '';
        document.getElementById('new-employee-role').value = '';
        document.getElementById('new-employee-id').value = '';
        document.getElementById('new-employee-password').value = '';
    });
    
    // Types de consultation
    const btnConsult = document.getElementById('add-consultation-type-btn');
    if(btnConsult) {
        btnConsult.addEventListener('click', function(e) {
            e.preventDefault();
            const nameInput = document.getElementById('new-consultation-type');
            const priceInput = document.getElementById('new-consultation-price');
            
            const name = nameInput.value;
            const priceVal = priceInput.value.replace(',', '.');
            const price = parseFloat(priceVal);
            
            if(!name || isNaN(price)) {
                showAlert("Veuillez entrer un nom valide et un prix numérique.", 'warning');
                return;
            }
            
            state.consultationTypes.push({
                id: Date.now(),
                name: name,
                price: price,
                active: true
            });
            
            nameInput.value = '';
            priceInput.value = '';
            updateSettingsDisplay();
            updateConsultationTypeSelect();
            loadConsultationTypesForAppointments();
            showAlert("Type de consultation ajouté !", 'success');
        });
    }

    const btnExt = document.getElementById('add-external-service-settings-btn');
    if(btnExt) {
        btnExt.addEventListener('click', function(e) {
            e.preventDefault();
            const nameInput = document.getElementById('new-external-service');
            const priceInput = document.getElementById('new-external-service-price');
            
            const name = nameInput.value;
            const price = parseFloat(priceInput.value.replace(',', '.'));
            
            if(!name || isNaN(price)) {
                showAlert("Erreur de saisie.", 'warning');
                return;
            }
            
            state.externalServices.push({ id: Date.now(), name: name, price: price, active: true });
            nameInput.value = '';
            priceInput.value = '';
            updateSettingsDisplay();
            showAlert("Service ajouté !", 'success');
        });
    }

    const btnLab = document.getElementById('add-lab-analysis-settings-btn');
    if(btnLab) {
        btnLab.addEventListener('click', function(e) {
            e.preventDefault();
            const nameInput = document.getElementById('new-lab-analysis');
            const priceInput = document.getElementById('new-lab-analysis-price');
            const typeSelect = document.getElementById('new-lab-analysis-type');
            
            const name = nameInput.value;
            const price = parseFloat(priceInput.value.replace(',', '.'));
            const resultType = typeSelect.value;
            
            if(!name || isNaN(price)) {
                showAlert("Erreur de saisie.", 'warning');
                return;
            }
            
            state.labAnalyses.push({ 
                id: Date.now(), 
                name: name, 
                price: price, 
                active: true,
                resultType: resultType
            });
            
            nameInput.value = '';
            priceInput.value = '';
            updateSettingsDisplay();
            showAlert("Analyse ajoutée !", 'success');
        });
    }
    
    updateEmployeesTable();
}

function updateSettingsDisplay() {
    const consList = document.getElementById('consultation-types-list');
    consList.innerHTML = '';
    state.consultationTypes.forEach(t => {
        if(t.active) {
            consList.innerHTML += `<div class="setting-item"><strong>${t.name}</strong> <span class="service-price">${t.price} Gdes</span></div>`;
        }
    });

    const extList = document.getElementById('external-services-list-settings');
    extList.innerHTML = '';
    state.externalServices.forEach(s => {
        if(s.active) {
            extList.innerHTML += `<div class="setting-item"><strong>${s.name}</strong> <span class="service-price">${s.price} Gdes</span></div>`;
        }
    });

    const labList = document.getElementById('lab-analyses-list-settings');
    labList.innerHTML = '';
    state.labAnalyses.forEach(a => {
        if(a.active) {
            const typeBadge = a.resultType === 'image' ? 
                '<span class="result-type-badge result-type-image">Image</span>' : 
                '<span class="result-type-badge result-type-text">Texte</span>';
            
            labList.innerHTML += `<div class="setting-item"><strong>${a.name}</strong> ${typeBadge} <span class="service-price">${a.price} Gdes</span></div>`;
        }
    });
}

function updateEmployeesTable() {
    const tbody = document.getElementById('employees-table-body');
    tbody.innerHTML = '';
    state.employees.forEach(emp => {
        tbody.innerHTML += `
            <tr>
                <td>${emp.name}</td>
                <td>${emp.role}</td>
                <td>${emp.id}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteEmployee('${emp.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`;
    });
}

function deleteEmployee(empId) {
    if (confirm("Voulez-vous vraiment supprimer cet employé ?")) {
        state.employees = state.employees.filter(emp => emp.id !== empId);
        updateEmployeesTable();
        showAlert("Employé supprimé", 'success');
    }
}

function updateHospitalInfoDisplay() {
    // Mettre à jour l'affichage dans l'en-tête
    document.getElementById('hospital-name-header').textContent = state.hospitalInfo.name;
    document.getElementById('hospital-address-header').textContent = state.hospitalInfo.address;
    
    // Mettre à jour dans le login
    document.getElementById('hospital-name-login').textContent = state.hospitalInfo.name;
    
    // Mettre à jour dans les paramètres
    document.getElementById('hospital-name').value = state.hospitalInfo.name;
    document.getElementById('hospital-address').value = state.hospitalInfo.address;
    document.getElementById('hospital-phone').value = state.hospitalInfo.phone;
}

function updateConsultationTypeSelect() {
    const select = document.getElementById('consultation-type');
    select.innerHTML = '<option value="">Sélectionner un type</option>';
    state.consultationTypes.forEach(type => {
        if(type.active) {
            select.innerHTML += `<option value="${type.id}" data-price="${type.price}">${type.name} - ${type.price} Gdes</option>`;
        }
    });
}

// --- CONSULTATION ---
function setupConsultation() {
    updateConsultationTypeSelect();
    
    document.getElementById('search-patient-btn').addEventListener('click', () => {
        const p = findPatient(document.getElementById('search-patient-id').value);
        if(p) {
            // Afficher le formulaire de signes vitaux
            document.getElementById('vitals-form-container').classList.remove('hidden');
            document.getElementById('consultation-form-container').classList.remove('hidden');
            document.getElementById('cons-patient-name').textContent = "Patient: " + p.name + " (" + p.id + ")";
            document.getElementById('consultation-form').dataset.pid = p.id;
            
            // Charger les signes vitaux existants s'ils existent
            if (state.patientVitals[p.id]) {
                const vitals = state.patientVitals[p.id];
                document.getElementById('vital-bp').value = vitals.bp || '';
                document.getElementById('vital-temp').value = vitals.temp || '';
                document.getElementById('vital-pulse').value = vitals.pulse || '';
                document.getElementById('vital-resp').value = vitals.resp || '';
                document.getElementById('vital-oxygen').value = vitals.oxygen || '';
                document.getElementById('vital-glucose').value = vitals.glucose || '';
                document.getElementById('vital-notes').value = vitals.notes || '';
            }
            
            // Afficher les signes vitaux enregistrés
            updateVitalsDisplay(p.id);
            
            const labDiv = document.getElementById('lab-analyses-selection');
            labDiv.innerHTML = '';
            state.labAnalyses.forEach(a => {
                labDiv.innerHTML += `<label><input type="checkbox" value="${a.name}" data-price="${a.price}" data-type="${a.resultType}"> ${a.name} (${a.price} Gdes)</label>`;
            });
        } else {
            showAlert("Patient introuvable");
        }
    });

    // Sauvegarde des signes vitaux
    document.getElementById('save-vitals-btn').addEventListener('click', function() {
        const pid = document.getElementById('consultation-form').dataset.pid;
        if (!pid) {
            showAlert("Veuillez d'abord sélectionner un patient", 'warning');
            return;
        }
        
        const vitals = {
            bp: document.getElementById('vital-bp').value,
            temp: document.getElementById('vital-temp').value,
            pulse: document.getElementById('vital-pulse').value,
            resp: document.getElementById('vital-resp').value,
            oxygen: document.getElementById('vital-oxygen').value,
            glucose: document.getElementById('vital-glucose').value,
            notes: document.getElementById('vital-notes').value,
            date: new Date().toLocaleDateString('fr-FR'),
            time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })
        };
        
        state.patientVitals[pid] = vitals;
        updateVitalsDisplay(pid);
        showAlert("Signes vitaux enregistrés", 'success');
    });

    document.getElementById('check-medication-btn').addEventListener('click', () => {
        const medsText = document.getElementById('consultation-meds').value;
        if (!medsText.trim()) {
            showAlert("Veuillez d'abord entrer des médicaments", 'warning');
            return;
        }
        
        const medLines = medsText.split('\n').filter(line => line.trim());
        let results = [];
        let outOfStock = [];
        
        medLines.forEach(line => {
            const medName = line.split('-')[0].trim();
            const inStock = state.stock.find(s => 
                s.medication.toLowerCase().includes(medName.toLowerCase()) && s.quantity > 0
            );
            
            if (inStock) {
                results.push(`${medName}: Disponible (${inStock.quantity} en stock)`);
            } else {
                results.push(`${medName}: Non disponible en stock`);
                outOfStock.push(medName);
            }
        });
        
        showAlert(results.join('\n'), 'info');
        
        // Si des médicaments sont hors stock, les enregistrer
        if (outOfStock.length > 0) {
            const pid = document.getElementById('consultation-form').dataset.pid;
            if (pid) {
                if (!state.outOfStockMeds) state.outOfStockMeds = {};
                if (!state.outOfStockMeds[pid]) state.outOfStockMeds[pid] = [];
                state.outOfStockMeds[pid] = [...new Set([...state.outOfStockMeds[pid], ...outOfStock])];
            }
        }
    });

    document.getElementById('consultation-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const pid = e.target.dataset.pid;
        const consultationTypeId = document.getElementById('consultation-type').value;
        const consultationType = state.consultationTypes.find(t => t.id == consultationTypeId);
        const diagnosis = document.getElementById('consultation-diagnosis').value;
        const meds = document.getElementById('consultation-meds').value;
        
        // Récupérer les signes vitaux
        const vitals = state.patientVitals[pid] || {};
        
        const checkboxes = document.querySelectorAll('#lab-analyses-selection input:checked');
        let analysesArr = [];
        checkboxes.forEach(cb => analysesArr.push({
            name: cb.value, 
            price: parseFloat(cb.dataset.price),
            resultType: cb.dataset.type
        }));

        state.consultations.push({
            id: Date.now(),
            patientId: pid,
            doctor: state.currentUser,
            date: new Date().toLocaleDateString('fr-FR'),
            diagnosis: diagnosis,
            type: consultationType ? consultationType.name : 'Non spécifié',
            typePrice: consultationType ? consultationType.price : 0,
            vitals: vitals,
            paid: false // Par défaut non payé
        });

        if(meds) {
            state.prescriptions.push({
                patientId: pid,
                details: meds,
                status: 'pending-payment',
                date: new Date().toLocaleDateString('fr-FR')
            });
        }

        if(analysesArr.length > 0) {
            state.analyses.push({
                patientId: pid,
                details: analysesArr,
                status: 'pending-payment',
                results: null,
                date: new Date().toLocaleDateString('fr-FR')
            });
        }

        showAlert("Consultation enregistrée.", 'success');
        e.target.reset();
        document.getElementById('consultation-form-container').classList.add('hidden');
        document.getElementById('vitals-form-container').classList.add('hidden');
        updateDashboard();
    });
}

function updateVitalsDisplay(patientId) {
    const vitals = state.patientVitals[patientId];
    const displayDiv = document.getElementById('vitals-display');
    
    if (!vitals) {
        displayDiv.innerHTML = '<div class="alert alert-info">Aucun signe vital enregistré pour ce patient.</div>';
        return;
    }
    
    let html = '<div class="card"><h4>Signes Vitaux Enregistrés</h4><div class="d-flex" style="gap:15px; flex-wrap:wrap">';
    
    if (vitals.bp) html += `<div><strong>TA:</strong> ${vitals.bp}</div>`;
    if (vitals.temp) html += `<div><strong>Temp:</strong> ${vitals.temp}°C</div>`;
    if (vitals.pulse) html += `<div><strong>Pouls:</strong> ${vitals.pulse} bpm</div>`;
    if (vitals.resp) html += `<div><strong>FR:</strong> ${vitals.resp} rpm</div>`;
    if (vitals.oxygen) html += `<div><strong>SpO2:</strong> ${vitals.oxygen}%</div>`;
    if (vitals.glucose) html += `<div><strong>Glycémie:</strong> ${vitals.glucose} mg/dL</div>`;
    
    html += '</div>';
    if (vitals.notes) html += `<div class="mt-2"><strong>Notes:</strong> ${vitals.notes}</div>`;
    html += `<div class="mt-2"><small>Enregistré le ${vitals.date} à ${vitals.time}</small></div>`;
    html += '</div>';
    
    displayDiv.innerHTML = html;
}

// --- PHARMACY ---
function setupPharmacy() {
    document.getElementById('pharmacy-search-btn').addEventListener('click', (e) => {
        e.preventDefault();
        const inputVal = document.getElementById('pharmacy-patient-id').value;
        const patient = findPatient(inputVal);
        
        const container = document.getElementById('pharmacy-results-container');
        container.innerHTML = '';
        container.classList.remove('hidden');

        if (!patient) {
            container.innerHTML = '<div class="alert alert-danger">Patient introuvable.</div>';
            return;
        }

        const prescriptions = state.prescriptions.filter(p => p.patientId === patient.id);

        if (prescriptions.length === 0) {
            container.innerHTML = `<div class="alert alert-info">Aucune ordonnance trouvée pour ${patient.name}.</div>`;
            return;
        }

        let html = `<div class="card"><h3>Ordonnances pour ${patient.name} (${patient.id})</h3>`;
        
        prescriptions.forEach(p => {
            let statusBadge = '';
            let actionBtn = '';

            // Pour les patients urgents, permettre la délivrance sans paiement
            const isEmergency = patient.id.startsWith('URG');
            
            if ((p.status === 'pending-payment' && !isEmergency) || (p.status === 'pending-payment' && isEmergency)) {
                statusBadge = isEmergency ? 
                    '<span class="text-warning">Urgence - Délivrance autorisée</span>' : 
                    '<span class="text-warning">En attente de paiement (Caisse)</span>';
                
                actionBtn = isEmergency ? 
                    `<button class="btn btn-success" onclick="deliverMedication('${p.patientId}', '${p.details}')">Délivrer (Urgence)</button>` :
                    '<button class="btn btn-secondary" disabled>Paiement requis</button>';
            } else if (p.status === 'paid' || (isEmergency && p.status === 'pending-payment')) {
                statusBadge = '<span class="text-success">Payé / Validé</span>';
                actionBtn = `<button class="btn btn-success" onclick="deliverMedication('${p.patientId}', '${p.details}')">Délivrer</button>`;
            } else if (p.status === 'delivered') {
                statusBadge = '<span class="text-info">Délivré</span>';
                actionBtn = '<button class="btn btn-info" disabled>Déjà délivré</button>';
            }

            html += `
                <div style="border-bottom:1px solid #ddd; padding:10px 0;">
                    <p><strong>Médicaments:</strong> ${p.details}</p>
                    <p><strong>Statut:</strong> ${statusBadge}</p>
                    ${actionBtn}
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    });

    // Gestion de l'ajout de médicaments (admin seulement)
    document.getElementById('toggle-add-medication-btn').addEventListener('click', () => {
        const form = document.getElementById('add-medication-form');
        if (state.currentRole === 'admin') {
            form.classList.toggle('hidden');
        } else {
            showAlert("Seul l'administrateur peut ajouter des médicaments", 'warning');
        }
    });

    document.getElementById('add-medication-btn').addEventListener('click', () => {
        if (state.currentRole !== 'admin') {
            showAlert("Seul l'administrateur peut ajouter des médicaments", 'warning');
            return;
        }
        
        const name = document.getElementById('new-medication-name').value;
        const quantity = parseInt(document.getElementById('new-medication-quantity').value);
        const price = parseFloat(document.getElementById('new-medication-price').value);
        
        if (!name || isNaN(quantity) || isNaN(price)) {
            showAlert("Veuillez remplir tous les champs correctement", 'warning');
            return;
        }
        
        const newId = 'MED' + (state.stock.length + 1).toString().padStart(3, '0');
        state.stock.push({
            id: newId,
            medication: name,
            quantity: quantity,
            price: price
        });
        
        updateStockTable();
        document.getElementById('new-medication-name').value = '';
        document.getElementById('new-medication-quantity').value = '';
        document.getElementById('new-medication-price').value = '';
        showAlert("Médicament ajouté au stock", 'success');
    });

    updateStockTable();
}

function deliverMedication(patientId, details) {
    const patient = state.patients.find(p => p.id === patientId);
    const isEmergency = patient && patient.id.startsWith('URG');
    
    // Vérifier le paiement (sauf pour les urgences)
    const prescription = state.prescriptions.find(p => p.patientId === patientId && p.details === details);
    
    if (!prescription) {
        showAlert("Ordonnance non trouvée", 'danger');
        return;
    }
    
    if (!isEmergency && prescription.status !== 'paid') {
        showAlert("Le patient doit d'abord payer à la caisse", 'warning');
        return;
    }
    
    // Délivrer les médicaments
    prescription.status = 'delivered';
    
    // Décrémenter le stock pour les médicaments délivrés
    const medLines = details.split('\n').filter(line => line.trim());
    let outOfStockMeds = [];
    
    medLines.forEach(line => {
        const medName = line.split('-')[0].trim();
        const stockItem = state.stock.find(s => 
            s.medication.toLowerCase().includes(medName.toLowerCase())
        );
        
        if (stockItem && stockItem.quantity > 0) {
            stockItem.quantity -= 1;
        } else {
            outOfStockMeds.push(medName);
        }
    });
    
    updateStockTable();
    
    if (outOfStockMeds.length > 0) {
        showAlert(`Médicaments délivrés, mais certains sont hors stock: ${outOfStockMeds.join(', ')}`, 'warning');
        
        // Enregistrer les médicaments hors stock
        if (!state.outOfStockMeds) state.outOfStockMeds = {};
        if (!state.outOfStockMeds[patientId]) state.outOfStockMeds[patientId] = [];
        state.outOfStockMeds[patientId] = [...new Set([...state.outOfStockMeds[patientId], ...outOfStockMeds])];
    } else {
        showAlert("Médicaments délivrés avec succès", 'success');
    }
    
    // Recharger l'affichage
    document.getElementById('pharmacy-search-btn').click();
}

function updateStockTable() {
    const tbody = document.getElementById('stock-table-body');
    tbody.innerHTML = '';
    state.stock.forEach(s => {
        tbody.innerHTML += `
            <tr>
                <td>${s.medication}</td>
                <td>${s.quantity}</td>
                <td>${s.price} Gdes</td>
                <td>
                    ${state.currentRole === 'admin' ? 
                        `<button class="btn btn-warning btn-sm" onclick="restockMedication('${s.id}')">Réapprovisionner</button>` : 
                        ''}
                </td>
            </tr>`;
    });
}

function restockMedication(medId) {
    if (state.currentRole !== 'admin') {
        showAlert("Seul l'administrateur peut modifier le stock", 'warning');
        return;
    }
    
    const quantity = prompt("Quantité à ajouter:", "10");
    if (quantity && !isNaN(quantity)) {
        const med = state.stock.find(m => m.id === medId);
        if (med) {
            med.quantity += parseInt(quantity);
            updateStockTable();
            showAlert(`Stock de ${med.medication} mis à jour: ${med.quantity} unités`, 'success');
        }
    }
}

// --- LABORATORY ---
function setupLaboratory() {
    document.getElementById('lab-search-btn').addEventListener('click', (e) => {
        e.preventDefault();
        const inputVal = document.getElementById('lab-patient-id').value;
        const patient = findPatient(inputVal);
        
        const container = document.getElementById('lab-results-container');
        container.innerHTML = '';
        container.classList.remove('hidden');

        if (!patient) {
            container.innerHTML = '<div class="alert alert-danger">Patient introuvable.</div>';
            return;
        }

        const analyses = state.analyses.filter(a => a.patientId === patient.id);

        if (analyses.length === 0) {
            container.innerHTML = `<div class="alert alert-info">Aucune analyse demandée pour ${patient.name}.</div>`;
            return;
        }

        let html = `<div class="card"><h3>Analyses pour ${patient.name} (${patient.id})</h3>`;
        analyses.forEach(a => {
            let list = a.details.map(d => d.name).join(', ');
            let totalPrice = a.details.reduce((sum, d) => sum + d.price, 0);
            
            // Pour les patients urgents, permettre la saisie sans paiement
            const isEmergency = patient.id.startsWith('URG');
            let status = (a.status === 'paid' || isEmergency) ? 'Payé/Validé' : 'En attente paiement';
            let color = (status === 'Payé/Validé') ? 'green' : 'orange';
            
            let action = '';
            if((status === 'Payé/Validé' && !a.results) || (isEmergency && !a.results)) {
                action = `<button class="btn btn-success btn-sm mt-2" onclick="enterLabResults('${a.patientId}', '${a.date}')">Saisir Résultats</button>`;
            } else if (!a.results) {
                action = `<span class="text-muted">Paiement requis à la caisse</span>`;
            } else {
                // Afficher les résultats selon le type
                if (a.results && a.results.startsWith('data:image')) {
                    action = `<div><strong>Résultats:</strong><br><img src="${a.results}" alt="Résultat image" class="image-preview"></div>`;
                } else {
                    action = `<div><strong>Résultats:</strong><pre>${a.results}</pre></div>`;
                }
            }

            html += `
                <div style="border-bottom:1px solid #ddd; padding:10px 0;">
                    <p><strong>Type:</strong> ${list}</p>
                    <p><strong>Prix total:</strong> ${totalPrice} Gdes</p>
                    <p style="color:${color}"><strong>Statut:</strong> ${status}</p>
                    ${action}
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    });
}

function enterLabResults(patientId, analysisDate) {
    const patient = state.patients.find(p => p.id === patientId);
    const isEmergency = patient && patient.id.startsWith('URG');
    
    // Vérifier le paiement (sauf pour les urgences)
    const analysis = state.analyses.find(a => a.patientId === patientId && a.date === analysisDate && !a.results);
    
    if (!analysis) {
        showAlert("Analyse non trouvée", 'danger');
        return;
    }
    
    if (!isEmergency && analysis.status !== 'paid') {
        showAlert("Le patient doit d'abord payer à la caisse", 'warning');
        return;
    }
    
    // Vérifier le type de résultat pour chaque analyse
    let resultForm = '<div class="card"><h4>Saisie des Résultats</h4>';
    
    analysis.details.forEach((detail, index) => {
        const analysisType = state.labAnalyses.find(a => a.name === detail.name);
        const isImageType = analysisType && analysisType.resultType === 'image';
        
        if (isImageType) {
            resultForm += `
                <div class="form-group">
                    <label class="form-label">${detail.name} (Image)</label>
                    <div class="upload-btn-wrapper">
                        <button class="btn btn-secondary">Choisir une image</button>
                        <input type="file" id="analysis-image-${index}" accept="image/*" class="form-control">
                    </div>
                    <div id="image-preview-${index}" class="hidden"></div>
                </div>
            `;
        } else {
            resultForm += `
                <div class="form-group">
                    <label class="form-label">${detail.name} (Texte)</label>
                    <input type="text" id="analysis-text-${index}" class="form-control" placeholder="Résultat...">
                </div>
            `;
        }
    });
    
    resultForm += `
        <button class="btn btn-success" onclick="saveLabResults('${patientId}', '${analysisDate}')">Enregistrer Résultats</button>
        </div>
    `;
    
    showAlert(resultForm, 'info');
}

function saveLabResults(patientId, analysisDate) {
    const analysis = state.analyses.find(a => a.patientId === patientId && a.date === analysisDate && !a.results);
    
    if (!analysis) {
        showAlert("Analyse non trouvée", 'danger');
        return;
    }
    
    let allResults = '';
    
    analysis.details.forEach((detail, index) => {
        const analysisType = state.labAnalyses.find(a => a.name === detail.name);
        const isImageType = analysisType && analysisType.resultType === 'image';
        
        if (isImageType) {
            const fileInput = document.getElementById(`analysis-image-${index}`);
            if (fileInput && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Stocker l'image en base64
                    analysis.results = e.target.result;
                    showAlert("Résultats image enregistrés", 'success');
                    document.getElementById('lab-search-btn').click();
                };
                reader.readAsDataURL(fileInput.files[0]);
            }
        } else {
            const textInput = document.getElementById(`analysis-text-${index}`);
            if (textInput && textInput.value) {
                allResults += `${detail.name}: ${textInput.value}\n`;
            }
        }
    });
    
    if (allResults) {
        analysis.results = allResults;
        showAlert("Résultats enregistrés", 'success');
        document.getElementById('lab-search-btn').click();
    }
}

// --- CAISSE ---
function setupCashier() {
    document.getElementById('cashier-search-btn').addEventListener('click', () => {
        const inputVal = document.getElementById('cashier-patient-id').value;
        const patient = findPatient(inputVal);
        
        const container = document.getElementById('cashier-results-container');
        container.innerHTML = '';
        container.classList.remove('hidden');

        if (!patient) {
            container.innerHTML = '<div class="alert alert-danger">Patient introuvable.</div>';
            return;
        }

        let totalAmount = 0;
        let servicesHtml = '';
        
        // Services par catégorie
        servicesHtml += '<div class="service-category">';
        servicesHtml += '<h4>Consultations</h4>';
        
        // Consultations en attente
        const pendingConsultations = state.consultations.filter(c => 
            c.patientId === patient.id && !c.paid
        );
        
        if (pendingConsultations.length === 0) {
            servicesHtml += '<p class="text-muted">Aucune consultation en attente</p>';
        } else {
            pendingConsultations.forEach(consult => {
                const consultType = state.consultationTypes.find(t => t.name === consult.type);
                const price = consultType ? consultType.price : 500;
                totalAmount += price;
                
                servicesHtml += `
                    <div class="service-item" data-type="consultation" data-id="${consult.id}" data-price="${price}">
                        <div>
                            <input type="checkbox" class="service-checkbox" checked>
                            <strong>Consultation ${consult.type}</strong><br>
                            <small>${consult.date} - Dr. ${consult.doctor}</small>
                        </div>
                        <div>${price} Gdes</div>
                    </div>
                `;
            });
        }
        servicesHtml += '</div>';
        
        // Analyses
        servicesHtml += '<div class="service-category">';
        servicesHtml += '<h4>Analyses de Laboratoire</h4>';
        
        const pendingAnalyses = state.analyses.filter(a => 
            a.patientId === patient.id && a.status === 'pending-payment'
        );
        
        if (pendingAnalyses.length === 0) {
            servicesHtml += '<p class="text-muted">Aucune analyse en attente</p>';
        } else {
            pendingAnalyses.forEach(analysis => {
                const analysisPrice = analysis.details.reduce((sum, d) => sum + d.price, 0);
                totalAmount += analysisPrice;
                
                servicesHtml += `
                    <div class="service-item" data-type="analysis" data-id="${analysis.patientId}" data-date="${analysis.date}" data-price="${analysisPrice}">
                        <div>
                            <input type="checkbox" class="service-checkbox" checked>
                            <strong>Analyses de laboratoire</strong><br>
                            <small>${analysis.details.map(d => d.name).join(', ')}</small>
                        </div>
                        <div>${analysisPrice} Gdes</div>
                    </div>
                `;
            });
        }
        servicesHtml += '</div>';
        
        // Médicaments
        servicesHtml += '<div class="service-category">';
        servicesHtml += '<h4>Médicaments</h4>';
        
        const pendingPrescriptions = state.prescriptions.filter(p => 
            p.patientId === patient.id && p.status === 'pending-payment'
        );
        
        if (pendingPrescriptions.length === 0) {
            servicesHtml += '<p class="text-muted">Aucun médicament en attente</p>';
        } else {
            pendingPrescriptions.forEach(prescription => {
                // Estimation du prix des médicaments
                const medPrice = 100; // Prix estimé, à ajuster selon le stock réel
                totalAmount += medPrice;
                
                servicesHtml += `
                    <div class="service-item" data-type="prescription" data-id="${prescription.patientId}" data-details="${prescription.details}" data-price="${medPrice}">
                        <div>
                            <input type="checkbox" class="service-checkbox" checked>
                            <strong>Médicaments</strong><br>
                            <small>${prescription.details}</small>
                        </div>
                        <div>${medPrice} Gdes</div>
                    </div>
                `;
            });
        }
        servicesHtml += '</div>';
        
        // Services externes
        servicesHtml += '<div class="service-category">';
        servicesHtml += '<h4>Services Externes</h4>';
        
        // Ajouter les services externes disponibles
        if (state.externalServices.length === 0) {
            servicesHtml += '<p class="text-muted">Aucun service externe disponible</p>';
        } else {
            state.externalServices.forEach(service => {
                if (service.active) {
                    servicesHtml += `
                        <div class="service-item" data-type="external" data-id="${service.id}" data-price="${service.price}">
                            <div>
                                <input type="checkbox" class="service-checkbox">
                                <strong>${service.name}</strong>
                            </div>
                            <div>${service.price} Gdes</div>
                        </div>
                    `;
                }
            });
        }
        servicesHtml += '</div>';
        
        // Afficher les médicaments hors stock pour ce patient
        if (state.outOfStockMeds && state.outOfStockMeds[patient.id]) {
            const outOfStockContainer = document.getElementById('out-of-stock-container');
            outOfStockContainer.classList.remove('hidden');
            
            const outOfStockList = document.getElementById('out-of-stock-list');
            outOfStockList.innerHTML = '';
            
            state.outOfStockMeds[patient.id].forEach(med => {
                outOfStockList.innerHTML += `<div class="medication-out-stock">${med} - Hors stock</div>`;
            });
        }
        
        if (servicesHtml.includes('service-item') || (state.outOfStockMeds && state.outOfStockMeds[patient.id])) {
            container.innerHTML = `
                <div class="card">
                    <h3>Services en attente pour ${patient.name} (${patient.id})</h3>
                    <div id="services-list">
                        ${servicesHtml}
                    </div>
                    
                    <div class="cashier-total">
                        <h3>Total sélectionné: <span id="total-amount">${totalAmount}</span> Gdes</h3>
                    </div>
                    
                    <h4>Moyen de paiement</h4>
                    <div class="payment-method-selector">
                        <div class="payment-method active" data-method="cash">
                            <i class="fas fa-money-bill-wave fa-2x"></i>
                            <p>Cash</p>
                        </div>
                        <div class="payment-method" data-method="moncash">
                            <i class="fas fa-mobile-alt fa-2x"></i>
                            <p>Mon Cash</p>
                        </div>
                        <div class="payment-method" data-method="natcash">
                            <i class="fas fa-wallet fa-2x"></i>
                            <p>NatCash</p>
                        </div>
                        <div class="payment-method" data-method="card">
                            <i class="fas fa-credit-card fa-2x"></i>
                            <p>Carte Bancaire</p>
                        </div>
                        <div class="payment-method" data-method="transfer">
                            <i class="fas fa-university fa-2x"></i>
                            <p>Virement</p>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-between mt-3">
                        <button id="generate-global-receipt-btn" class="btn btn-info">
                            <i class="fas fa-receipt"></i> Générer Reçu Global
                        </button>
                        <button id="process-payment-btn" class="btn btn-success btn-lg">
                            <i class="fas fa-check-circle"></i> Procéder au Paiement
                        </button>
                    </div>
                </div>
            `;
            
            setupPaymentMethods();
            setupServiceSelection();
            setupProcessPayment(patient, totalAmount);
            setupGlobalReceipt(patient);
        } else {
            container.innerHTML = `<div class="alert alert-success">Aucun service en attente de paiement pour ${patient.name}.</div>`;
            return;
        }
    });
    
    // Bouton pour imprimer les médicaments hors stock
    document.getElementById('print-out-of-stock-btn').addEventListener('click', function() {
        printOutOfStockMeds();
    });
}

function setupPaymentMethods() {
    const methods = document.querySelectorAll('.payment-method');
    methods.forEach(method => {
        method.addEventListener('click', function() {
            methods.forEach(m => m.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

function setupServiceSelection() {
    const checkboxes = document.querySelectorAll('.service-checkbox');
    checkboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            const serviceItem = this.closest('.service-item');
            serviceItem.classList.toggle('selected', this.checked);
            updateTotalAmount();
        });
    });
}

function updateTotalAmount() {
    let total = 0;
    document.querySelectorAll('.service-checkbox:checked').forEach(cb => {
        const serviceItem = cb.closest('.service-item');
        const price = parseFloat(serviceItem.dataset.price);
        total += price;
    });
    document.getElementById('total-amount').textContent = total;
}

function setupProcessPayment(patient, initialTotal) {
    document.getElementById('process-payment-btn').addEventListener('click', () => {
        const selectedMethod = document.querySelector('.payment-method.active').dataset.method;
        const total = parseFloat(document.getElementById('total-amount').textContent);
        
        if (total === 0) {
            showAlert("Veuillez sélectionner au moins un service", 'warning');
            return;
        }
        
        // Marquer les services comme payés
        document.querySelectorAll('.service-checkbox:checked').forEach(cb => {
            const serviceItem = cb.closest('.service-item');
            const type = serviceItem.dataset.type;
            const id = serviceItem.dataset.id;
            const date = serviceItem.dataset.date;
            const details = serviceItem.dataset.details;
            const price = parseFloat(serviceItem.dataset.price);
            
            if (type === 'consultation') {
                const consult = state.consultations.find(c => c.id == id);
                if (consult) consult.paid = true;
            } else if (type === 'analysis') {
                const analysis = state.analyses.find(a => a.patientId === id && a.date === date && a.status === 'pending-payment');
                if (analysis) analysis.status = 'paid';
            } else if (type === 'prescription') {
                const prescription = state.prescriptions.find(p => p.patientId === id && p.details === details && p.status === 'pending-payment');
                if (prescription) prescription.status = 'paid';
            } else if (type === 'external') {
                // Ajouter le service externe comme transaction
                const service = state.externalServices.find(s => s.id == id);
                if (service) {
                    state.transactions.push({
                        id: 'EXT' + Date.now(),
                        patientId: patient.id,
                        patientName: patient.name,
                        amount: price,
                        method: selectedMethod,
                        date: new Date().toLocaleDateString('fr-FR'),
                        time: new Date().toLocaleTimeString('fr-FR'),
                        agent: state.currentUser,
                        service: service.name
                    });
                }
            }
        });
        
        // Enregistrer la transaction
        const transaction = {
            id: 'TR' + Date.now(),
            patientId: patient.id,
            patientName: patient.name,
            amount: total,
            method: selectedMethod,
            date: new Date().toLocaleDateString('fr-FR'),
            time: new Date().toLocaleTimeString('fr-FR'),
            agent: state.currentUser
        };
        
        state.transactions.push(transaction);
        
        showAlert(`Paiement de ${total} Gdes effectué avec succès via ${selectedMethod}`, 'success');
        
        // Générer un reçu
        generateReceipt(patient, selectedMethod, total);
        
        // Mettre à jour les statistiques
        updateDashboard();
        updateAdminStats();
        
        // Réinitialiser
        document.getElementById('cashier-patient-id').value = '';
        document.getElementById('cashier-results-container').classList.add('hidden');
        document.getElementById('out-of-stock-container').classList.add('hidden');
    });
}

function setupGlobalReceipt(patient) {
    document.getElementById('generate-global-receipt-btn').addEventListener('click', () => {
        generateGlobalReceipt(patient);
    });
}

function generateReceipt(patient, method, amount) {
    const receiptContainer = document.getElementById('global-receipt-container');
    
    // Mettre à jour les informations du reçu
    document.getElementById('receipt-hospital-name').textContent = state.hospitalInfo.name;
    document.getElementById('receipt-hospital-address').textContent = state.hospitalInfo.address;
    document.getElementById('receipt-hospital-phone').textContent = state.hospitalInfo.phone;
    document.getElementById('receipt-patient-name').textContent = patient.name;
    document.getElementById('receipt-patient-id').textContent = patient.id;
    document.getElementById('receipt-date').textContent = new Date().toLocaleDateString('fr-FR');
    document.getElementById('receipt-time').textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    document.getElementById('receipt-total-amount').textContent = amount;
    document.getElementById('receipt-payment-method').textContent = method;
    document.getElementById('receipt-number').textContent = 'TR' + Date.now();
    
    // Services payés
    const servicesList = document.getElementById('receipt-services-list');
    servicesList.innerHTML = '';
    
    // Récupérer les services cochés
    document.querySelectorAll('.service-checkbox:checked').forEach(cb => {
        const serviceItem = cb.closest('.service-item');
        const serviceText = serviceItem.querySelector('strong').textContent;
        const price = serviceItem.dataset.price;
        
        servicesList.innerHTML += `
            <div class="receipt-item">
                <span>${serviceText}</span>
                <span>${price} Gdes</span>
            </div>
        `;
    });
    
    // Cacher la section des services non payés
    document.getElementById('receipt-unpaid-section').classList.add('hidden');
    
    // Afficher et imprimer le reçu
    receiptContainer.classList.remove('hidden');
    setTimeout(() => {
        window.print();
        receiptContainer.classList.add('hidden');
    }, 500);
}

function generateGlobalReceipt(patient) {
    const receiptContainer = document.getElementById('global-receipt-container');
    
    // Mettre à jour les informations du reçu
    document.getElementById('receipt-hospital-name').textContent = state.hospitalInfo.name;
    document.getElementById('receipt-hospital-address').textContent = state.hospitalInfo.address;
    document.getElementById('receipt-hospital-phone').textContent = state.hospitalInfo.phone;
    document.getElementById('receipt-patient-name').textContent = patient.name;
    document.getElementById('receipt-patient-id').textContent = patient.id;
    document.getElementById('receipt-date').textContent = new Date().toLocaleDateString('fr-FR');
    document.getElementById('receipt-time').textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    document.getElementById('receipt-number').textContent = 'GR' + Date.now();
    
    // Tous les services (payés et non payés)
    const servicesList = document.getElementById('receipt-services-list');
    const unpaidList = document.getElementById('receipt-unpaid-list');
    servicesList.innerHTML = '';
    unpaidList.innerHTML = '';
    
    let totalPaid = 0;
    let totalUnpaid = 0;
    
    // Consultations
    const consultations = state.consultations.filter(c => c.patientId === patient.id);
    consultations.forEach(consult => {
        const price = consult.typePrice || 500;
        if (consult.paid) {
            totalPaid += price;
            servicesList.innerHTML += `
                <div class="receipt-item">
                    <span>Consultation ${consult.type} (Payé)</span>
                    <span>${price} Gdes</span>
                </div>
            `;
        } else {
            totalUnpaid += price;
            unpaidList.innerHTML += `
                <div class="receipt-item">
                    <span>Consultation ${consult.type} (Non payé)</span>
                    <span>${price} Gdes</span>
                </div>
            `;
        }
    });
    
    // Analyses
    const analyses = state.analyses.filter(a => a.patientId === patient.id);
    analyses.forEach(analysis => {
        const price = analysis.details.reduce((sum, d) => sum + d.price, 0);
        if (analysis.status === 'paid') {
            totalPaid += price;
            servicesList.innerHTML += `
                <div class="receipt-item">
                    <span>Analyses: ${analysis.details.map(d => d.name).join(', ')} (Payé)</span>
                    <span>${price} Gdes</span>
                </div>
            `;
        } else {
            totalUnpaid += price;
            unpaidList.innerHTML += `
                <div class="receipt-item">
                    <span>Analyses: ${analysis.details.map(d => d.name).join(', ')} (Non payé)</span>
                    <span>${price} Gdes</span>
                </div>
            `;
        }
    });
    
    // Médicaments
    const prescriptions = state.prescriptions.filter(p => p.patientId === patient.id);
    prescriptions.forEach(prescription => {
        const price = 100; // Estimation
        if (prescription.status === 'paid' || prescription.status === 'delivered') {
            totalPaid += price;
            servicesList.innerHTML += `
                <div class="receipt-item">
                    <span>Médicaments (Payé)</span>
                    <span>${price} Gdes</span>
                </div>
            `;
        } else {
            totalUnpaid += price;
            unpaidList.innerHTML += `
                <div class="receipt-item">
                    <span>Médicaments (Non payé)</span>
                    <span>${price} Gdes</span>
                </div>
            `;
        }
    });
    
    // Services externes
    state.externalServices.forEach(service => {
        if (service.active) {
            // Vérifier si le service a été payé (simplifié)
            const servicePaid = state.transactions.some(t => 
                t.patientId === patient.id && t.service === service.name
            );
            
            if (servicePaid) {
                totalPaid += service.price;
                servicesList.innerHTML += `
                    <div class="receipt-item">
                        <span>${service.name} (Payé)</span>
                        <span>${service.price} Gdes</span>
                    </div>
                `;
            }
        }
    });
    
    // Mettre à jour les totaux
    document.getElementById('receipt-total-amount').textContent = totalPaid;
    
    // Afficher la section des services non payés si nécessaire
    if (totalUnpaid > 0) {
        document.getElementById('receipt-unpaid-section').classList.remove('hidden');
        unpaidList.innerHTML += `
            <div class="receipt-item receipt-total">
                <span>Total non payé:</span>
                <span>${totalUnpaid} Gdes</span>
            </div>
        `;
    } else {
        document.getElementById('receipt-unpaid-section').classList.add('hidden');
    }
    
    // Cacher le moyen de paiement pour le reçu global
    document.getElementById('receipt-payment-method').textContent = 'Multiple';
    
    // Afficher et imprimer le reçu
    receiptContainer.classList.remove('hidden');
    setTimeout(() => {
        window.print();
        receiptContainer.classList.add('hidden');
    }, 500);
}

function printOutOfStockMeds() {
    const patientId = document.getElementById('cashier-patient-id').value;
    const patient = findPatient(patientId);
    
    if (!patient || !state.outOfStockMeds || !state.outOfStockMeds[patient.id]) {
        showAlert("Aucun médicament hors stock pour ce patient", 'warning');
        return;
    }
    
    const meds = state.outOfStockMeds[patient.id];
    let printContent = `
        <div class="printable">
            <h3>Médicaments Hors Stock - ${state.hospitalInfo.name}</h3>
            <p><strong>Patient:</strong> ${patient.name} (${patient.id})</p>
            <p><strong>Date:</strong> ${new Date().toLocaleDateString('fr-FR')}</p>
            <hr>
            <h4>Médicaments à commander:</h4>
            <ul>
    `;
    
    meds.forEach(med => {
        printContent += `<li>${med}</li>`;
    });
    
    printContent += `
            </ul>
            <hr>
            <p><small>Document généré le ${new Date().toLocaleString('fr-FR')}</small></p>
        </div>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Médicaments Hors Stock</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h3 { color: #dc3545; }
                ul { padding-left: 20px; }
            </style>
        </head>
        <body>
            ${printContent}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// --- ADMINISTRATION ---
function updateAdminStats() {
    if (state.currentRole !== 'admin') return;
    
    // Calculer les revenus totaux
    const totalRevenue = state.transactions.reduce((sum, t) => sum + t.amount, 0);
    document.getElementById('total-revenue').textContent = totalRevenue + ' Gdes';
    
    // Nombre de consultations
    const consultationsCount = state.consultations.length;
    const consultationsAmount = state.consultations.reduce((sum, c) => sum + (c.typePrice || 0), 0);
    document.getElementById('admin-consultations').textContent = consultationsCount;
    document.getElementById('consultations-amount').textContent = consultationsAmount + ' Gdes';
    
    // Nombre d'analyses
    const analysesCount = state.analyses.length;
    const analysesAmount = state.analyses.reduce((sum, a) => 
        sum + a.details.reduce((s, d) => s + d.price, 0), 0);
    document.getElementById('admin-analyses').textContent = analysesCount;
    document.getElementById('analyses-amount').textContent = analysesAmount + ' Gdes';
    
    // Statistiques par service
    const servicesBody = document.getElementById('admin-services-table-body');
    servicesBody.innerHTML = '';
    
    const serviceStats = {};
    
    // Consultations par type
    state.consultations.forEach(c => {
        const type = c.type || 'Générale';
        if (!serviceStats[type]) serviceStats[type] = { count: 0, amount: 0 };
        serviceStats[type].count++;
        serviceStats[type].amount += c.typePrice || 500;
    });
    
    // Analyses
    if (state.analyses.length > 0) {
        serviceStats['Analyses'] = { 
            count: state.analyses.length, 
            amount: analysesAmount 
        };
    }
    
    // Médicaments
    const medicationsCount = state.prescriptions.filter(p => p.status === 'delivered').length;
    const medicationsAmount = medicationsCount * 100; // Estimation
    if (medicationsCount > 0) {
        serviceStats['Médicaments'] = { 
            count: medicationsCount, 
            amount: medicationsAmount 
        };
    }
    
    // Services externes
    const externalServicesCount = state.transactions.filter(t => t.service).length;
    const externalServicesAmount = state.transactions.filter(t => t.service).reduce((sum, t) => sum + t.amount, 0);
    if (externalServicesCount > 0) {
        serviceStats['Services Externes'] = { 
            count: externalServicesCount, 
            amount: externalServicesAmount 
        };
    }
    
    // Urgences
    const emergencyCount = state.patients.filter(p => p.emergency).length;
    if (emergencyCount > 0) {
        serviceStats['Urgences'] = { 
            count: emergencyCount, 
            amount: emergencyCount * 200 // Estimation
        };
    }
    
    // Afficher les statistiques
    Object.entries(serviceStats).forEach(([service, stats]) => {
        const avg = stats.count > 0 ? (stats.amount / stats.count).toFixed(2) : 0;
        servicesBody.innerHTML += `
            <tr>
                <td>${service}</td>
                <td>${stats.count}</td>
                <td>${stats.amount} Gdes</td>
                <td>${avg} Gdes</td>
            </tr>
        `;
    });
    
    document.getElementById('admin-medications').textContent = medicationsCount;
    document.getElementById('medications-amount').textContent = medicationsAmount + ' Gdes';
    
    // Transactions récentes
    const transactionsBody = document.getElementById('transactions-table-body');
    transactionsBody.innerHTML = '';
    
    state.transactions.slice(-10).reverse().forEach(t => {
        transactionsBody.innerHTML += `
            <tr>
                <td>${t.date} ${t.time}</td>
                <td>${t.patientName} (${t.patientId})</td>
                <td>${t.service || 'Divers'}</td>
                <td>${t.amount} Gdes</td>
                <td>${t.method}</td>
                <td>${t.agent}</td>
            </tr>
        `;
    });
}

// --- MESSAGERIE ---
function setupMessages() {
    document.getElementById('new-message-btn').addEventListener('click', () => {
        document.querySelector('.new-message-form').classList.remove('hidden');
        document.getElementById('message-detail').classList.add('hidden');
    });
    
    document.getElementById('new-message-form').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const recipient = document.getElementById('message-recipient').value;
        const subject = document.getElementById('message-subject').value;
        const content = document.getElementById('message-content').value;
        
        if (!recipient || !subject || !content) {
            showAlert("Veuillez remplir tous les champs", 'warning');
            return;
        }
        
        const newMessage = {
            id: 'MSG' + Date.now(),
            sender: state.currentUser,
            senderRole: state.currentRole,
            recipient: recipient,
            subject: subject,
            content: content,
            timestamp: new Date().toLocaleString('fr-FR'),
            read: false
        };
        
        state.messages.push(newMessage);
        updateMessagesDisplay();
        
        // Réinitialiser le formulaire
        e.target.reset();
        document.querySelector('.new-message-form').classList.add('hidden');
        document.getElementById('message-detail').classList.remove('hidden');
        
        showAlert("Message envoyé avec succès", 'success');
    });
    
    updateMessagesDisplay();
}

function updateMessagesDisplay() {
    const messagesList = document.getElementById('messages-list');
    messagesList.innerHTML = '';
    
    // Filtrer les messages selon le rôle
    let filteredMessages = [];
    
    if (state.currentRole === 'reception') {
        // La réception voit tous les messages qui lui sont destinés
        filteredMessages = state.messages.filter(m => m.recipient === 'reception');
    } else if (state.currentRole === 'admin') {
        // L'admin voit tous les messages
        filteredMessages = state.messages;
    } else {
        // Les autres rôles voient leurs messages envoyés et reçus
        filteredMessages = state.messages.filter(m => 
            m.recipient === state.currentRole || 
            m.sender === state.currentUser ||
            (m.recipient === 'reception' && m.senderRole === state.currentRole)
        );
    }
    
    if (filteredMessages.length === 0) {
        messagesList.innerHTML = '<p class="text-center">Aucun message</p>';
        return;
    }
    
    // Trier par date (plus récent en premier)
    filteredMessages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    filteredMessages.forEach(message => {
        const isUnread = !message.read && message.recipient === state.currentRole;
        const messageClass = isUnread ? 'message-item unread' : 'message-item';
        
        messagesList.innerHTML += `
            <div class="${messageClass}" onclick="showMessageDetail('${message.id}')">
                <div class="d-flex justify-between">
                    <div>
                        <strong>${message.subject}</strong><br>
                        <span class="message-sender">De: ${message.sender} (${message.senderRole})</span><br>
                        <span class="message-sender">À: ${message.recipient}</span>
                    </div>
                    <div class="message-time">${message.timestamp}</div>
                </div>
            </div>
        `;
    });
    
    // Mettre à jour le badge de messages non lus dans l'onglet
    const unreadCount = filteredMessages.filter(m => !m.read && m.recipient === state.currentRole).length;
    const messagesTab = document.getElementById('messages-tab');
    if (unreadCount > 0) {
        messagesTab.innerHTML = `<i class="fas fa-envelope"></i> Messages <span class="emergency-patient-tag">${unreadCount}</span>`;
    } else {
        messagesTab.innerHTML = `<i class="fas fa-envelope"></i> Messages`;
    }
}

function showMessageDetail(messageId) {
    const message = state.messages.find(m => m.id === messageId);
    if (!message) return;
    
    // Marquer comme lu si destiné à l'utilisateur courant
    if (message.recipient === state.currentRole) {
        message.read = true;
    }
    
    const messageDetail = document.getElementById('message-detail');
    messageDetail.innerHTML = `
        <h4>${message.subject}</h4>
        <p><strong>De:</strong> ${message.sender} (${message.senderRole})</p>
        <p><strong>À:</strong> ${message.recipient}</p>
        <p><strong>Date:</strong> ${message.timestamp}</p>
        <div class="message-content">
            ${message.content.replace(/\n/g, '<br>')}
        </div>
        <div class="mt-3">
            <button class="btn btn-secondary" onclick="replyToMessage('${message.sender}', '${message.senderRole}', '${message.subject}')">
                <i class="fas fa-reply"></i> Répondre
            </button>
            <button class="btn btn-danger" onclick="deleteMessage('${message.id}')">
                <i class="fas fa-trash"></i> Supprimer
            </button>
        </div>
    `;
    
    messageDetail.classList.remove('hidden');
    document.querySelector('.new-message-form').classList.add('hidden');
    
    updateMessagesDisplay();
}

function replyToMessage(sender, senderRole, originalSubject) {
    document.querySelector('.new-message-form').classList.remove('hidden');
    document.getElementById('message-detail').classList.add('hidden');
    
    // Pré-remplir le formulaire de réponse
    document.getElementById('message-recipient').value = senderRole;
    document.getElementById('message-subject').value = 'Re: ' + originalSubject;
}

function deleteMessage(messageId) {
    if (confirm("Voulez-vous vraiment supprimer ce message ?")) {
        state.messages = state.messages.filter(m => m.id !== messageId);
        updateMessagesDisplay();
        document.getElementById('message-detail').innerHTML = '<p class="text-center">Sélectionnez un message pour afficher son contenu</p>';
        showAlert("Message supprimé", 'success');
    }
}

// --- DASHBOARD ---
function updateDashboard() {
    if (state.currentRole === 'admin') {
        document.getElementById('stat-patients').textContent = state.patients.length;
        document.getElementById('stat-consultations').textContent = state.consultations.length;
        document.getElementById('stat-analyses').textContent = state.analyses.length;
        
        const totalRevenue = state.transactions.reduce((sum, t) => sum + t.amount, 0);
        document.getElementById('stat-revenue').textContent = totalRevenue + ' Gdes';
    } else if (state.currentRole === 'doctor') {
        updateDoctorDashboard();
    } else if (state.currentRole === 'lab') {
        updateLabDashboard();
    } else if (state.currentRole === 'pharmacy') {
        updatePharmacyDashboard();
    } else if (state.currentRole === 'cashier') {
        updateCashierDashboard();
    } else if (state.currentRole === 'reception') {
        updateReceptionDashboard();
    }
}

// --- DEMO DATA ---
function loadDemoData() {
    state.patients.push(
        {id: 'PA0001', name: 'Jean Dupont', dob: '1980-01-01', phone: '12345678', emergency: false, pediatric: false, registrationDate: new Date().toLocaleDateString('fr-FR')},
        {id: 'URG0002', name: 'Marie Curie', dob: '1990-05-05', phone: '87654321', emergency: true, pediatric: false, registrationDate: new Date().toLocaleDateString('fr-FR')}
    );
    
    state.consultations.push({
        id: Date.now(),
        patientId: 'PA0001',
        doctor: 'Dr. Smith',
        date: new Date().toLocaleDateString('fr-FR'),
        diagnosis: 'Fièvre et maux de tête',
        type: 'Générale',
        typePrice: 500,
        paid: true
    });
    
    state.prescriptions.push({
        patientId: 'PA0001',
        details: 'Doliprane 1000mg',
        status: 'delivered',
        date: new Date().toLocaleDateString('fr-FR')
    });
    
    state.analyses.push({
        patientId: 'PA0001',
        details: [{name: 'Hémogramme', price: 300, resultType: 'text'}],
        status: 'paid',
        results: 'Normal',
        date: new Date().toLocaleDateString('fr-FR')
    });
    
    state.transactions.push({
        id: 'TR001',
        patientId: 'PA0001',
        patientName: 'Jean Dupont',
        amount: 800,
        method: 'cash',
        date: new Date().toLocaleDateString('fr-FR'),
        time: '10:30',
        agent: 'admin'
    });
    
    // Ajouter des signes vitaux de démo
    state.patientVitals['PA0001'] = {
        bp: '120/80',
        temp: 37.2,
        pulse: 72,
        resp: 16,
        oxygen: 98,
        glucose: 95,
        notes: 'Patient stable',
        date: new Date().toLocaleDateString('fr-FR'),
        time: '10:15'
    };
    
    // Ajouter des rendez-vous de démo
    state.appointments.push({
        id: 'RDV001',
        patientId: 'PA0001',
        patientName: 'Jean Dupont',
        doctor: 'Dr. Smith',
        date: new Date().toLocaleDateString('fr-FR'),
        time: '14:30',
        type: 'Générale',
        notes: 'Contrôle de routine',
        status: 'confirmed',
        createdBy: 'reception',
        createdAt: new Date().toLocaleString('fr-FR')
    });
    
    // Ajouter des messages de démo
    state.messages.push({
        id: 'MSG001',
        sender: 'doctor',
        senderRole: 'doctor',
        recipient: 'reception',
        subject: 'Demande de dossier patient',
        content: 'Bonjour, pourriez-vous préparer le dossier du patient PA0001 pour ma consultation de cet après-midi ?\nCordialement,\nDr. Smith',
        timestamp: new Date().toLocaleString('fr-FR'),
        read: false
    });
    
    updatePatientTable();
    updateStockTable();
    updateEmployeesTable();
    updateAppointmentsList();
    updateMessagesDisplay();
}
</script>
</body>
</html>