<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Système de Gestion Hospitalier</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f0f7ff; color: #333; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .header { background: linear-gradient(135deg, #1a6bca 0%, #0d4d9c 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        .logo { display: flex; align-items: center; gap: 15px; }
        .logo-img { width: 50px; height: 50px; object-fit: contain; }
        .logo i { font-size: 2.2rem; }
        .logo h1 { font-size: 1.8rem; font-weight: 700; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .logout-btn { background-color: #ff6b6b; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 600; }
        
        .nav-tabs { display: flex; background-color: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); margin-bottom: 25px; flex-wrap: wrap; }
        .nav-tab { flex: 1; text-align: center; padding: 15px 10px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; color: #555; border-bottom: 3px solid transparent; min-width: 100px; }
        .nav-tab:hover { background-color: #f5f9ff; }
        .nav-tab.active { color: #1a6bca; border-bottom: 3px solid #1a6bca; background-color: #f0f7ff; }
        
        .content { background-color: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 25px; min-height: 500px; display: none; }
        .content.active { display: block; }
        .section-title { color: #1a6bca; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #eef5ff; font-size: 1.5rem; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #444; }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; transition: border 0.3s; }
        .form-control:focus { outline: none; border-color: #1a6bca; }
        .btn { padding: 12px 25px; background-color: #1a6bca; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.3s ease; }
        .btn:hover { background-color: #0d4d9c; transform: translateY(-2px); }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #218838; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #e0a800; }
        
        .card { background-color: #f8fbff; border-radius: 8px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #1a6bca; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); }
        .card h3 { color: #1a6bca; margin-bottom: 10px; }
        .d-flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .hidden { display: none !important; }
        .mt-2 { margin-top: 10px; }
        .mt-3 { margin-top: 15px; }
        .mb-2 { margin-bottom: 10px; }
        .mb-3 { margin-bottom: 15px; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eef5ff; }
        th { background-color: #f0f7ff; color: #1a6bca; font-weight: 600; }
        tr:hover { background-color: #f8fbff; }
        
        .stats-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); display: flex; align-items: center; gap: 15px; }
        .stat-icon { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; }
        .stat-info h3 { font-size: 1.8rem; margin-bottom: 5px; color: #333; }
        .stat-info p { color: #777; font-weight: 600; }

        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #1a6bca 0%, #0d4d9c 100%); }
        .login-box { background-color: white; width: 100%; max-width: 450px; padding: 40px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
        .login-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px; }
        .login-role-btn { padding: 15px; background-color: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .login-role-btn.active { background-color: #1a6bca; color: white; border-color: #1a6bca; }
        
        .alert { padding: 12px 15px; border-radius: 5px; margin-bottom: 20px; position: relative; }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .alert-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .alert-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eef5ff; }
        .setting-actions { display: flex; gap: 10px; }
        .service-price { display: inline-block; background-color: #e7f3ff; color: #1a6bca; padding: 3px 8px; border-radius: 4px; font-weight: 600; margin-left: 10px; font-size: 0.9rem; }
        .emergency-patient-tag { background-color: #dc3545; color: white; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .pediatric-tag { background-color: #17a2b8; color: white; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .external-patient-tag { background-color: #6f42c1; color: white; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        
        .payment-method-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .payment-method { border: 2px solid #ddd; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; }
        .payment-method.active { border-color: #1a6bca; background-color: #f0f7ff; }
        .service-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #eef5ff; border-radius: 5px; margin-bottom: 5px; }
        .service-item.selected { background-color: #e7f3ff; border-color: #1a6bca; }
        .check-availability-btn { margin-left: 10px; padding: 5px 10px; background-color: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .admin-stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .admin-stat-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cashier-total { background-color: #e7f3ff; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center; }
        
        .vitals-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
        .vital-item { border: 1px solid #eef5ff; padding: 15px; border-radius: 8px; }
        
        .patient-card { width: 350px; border: 2px solid #1a6bca; border-radius: 10px; padding: 20px; background: white; }
        .patient-card-header { background: #1a6bca; color: white; padding: 15px; margin: -20px -20px 20px -20px; border-radius: 8px 8px 0 0; }
        .patient-photo { width: 100px; height: 100px; background: #ddd; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; }
        
        @media print {
            body * { visibility: hidden; }
            .printable, .printable * { visibility: visible; }
            .printable { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            .print-receipt { width: 80mm; font-size: 12px; }
            .medical-certificate { width: 210mm; min-height: 297mm; padding: 20mm; }
        }
        
        .small-input { width: 80px; }
        .vitals-form { background: #f8fbff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .employee-form { background: #f8fbff; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .hospital-info-form { background: #f8fbff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .print-controls { margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; }
        .medication-out-stock { background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .receipt-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ddd; }
        .receipt-total { font-weight: bold; font-size: 1.2rem; margin-top: 10px; }
        
        .appointment-form { background: #f8fbff; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .appointment-list { max-height: 400px; overflow-y: auto; }
        .appointment-item { border: 1px solid #eef5ff; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white; }
        .appointment-status { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .status-pending { background-color: #ffc107; color: #212529; }
        .status-confirmed { background-color: #28a745; color: white; }
        .status-cancelled { background-color: #dc3545; color: white; }
        .status-completed { background-color: #17a2b8; color: white; }
        
        .messages-container { display: flex; gap: 20px; }
        .message-list { flex: 1; max-height: 500px; overflow-y: auto; border: 1px solid #eef5ff; border-radius: 8px; padding: 15px; }
        .message-details { flex: 2; border: 1px solid #eef5ff; border-radius: 8px; padding: 15px; }
        .message-item { padding: 10px; border-bottom: 1px solid #eef5ff; cursor: pointer; }
        .message-item:hover { background-color: #f8fbff; }
        .message-item.unread { background-color: #e7f3ff; font-weight: bold; }
        .message-sender { color: #1a6bca; font-weight: 600; }
        .message-time { color: #777; font-size: 0.9rem; }
        .message-content { margin-top: 10px; padding: 10px; background-color: #f8fbff; border-radius: 5px; }
        .new-message-form { margin-top: 20px; }
        
        .image-preview { max-width: 300px; max-height: 300px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .upload-btn-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .result-type-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 10px; }
        .result-type-text { background-color: #17a2b8; color: white; }
        .result-type-image { background-color: #28a745; color: white; }
        
        .service-category { margin-bottom: 20px; }
        .service-category h4 { color: #1a6bca; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #eef5ff; }
        
        .change-money-container { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .change-money-result { font-weight: bold; color: #28a745; font-size: 1.2rem; }
        .medication-prescription-table { width: 100%; margin: 10px 0; }
        .medication-prescription-table th { background-color: #e9ecef; }
        .low-stock { background-color: #fff3cd !important; }
        .out-of-stock { background-color: #f8d7da !important; }
        .patient-status-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.85rem; font-weight: bold; }
        .status-paid { background-color: #d4edda; color: #155724; }
        .status-unpaid { background-color: #f8d7da; color: #721c24; }
        .status-partial { background-color: #fff3cd; color: #856404; }
        .clickable-stat { cursor: pointer; transition: transform 0.2s; }
        .clickable-stat:hover { transform: scale(1.05); }
        .transaction-details-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .transaction-details-content { background: white; padding: 30px; border-radius: 10px; max-width: 800px; max-height: 80vh; overflow-y: auto; }
        .search-patient-transactions { margin-bottom: 20px; }
        
        .messaging-container { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        .conversation-list { max-height: 600px; overflow-y: auto; }
        .conversation-item { padding: 15px; border-bottom: 1px solid #eef5ff; cursor: pointer; }
        .conversation-item:hover { background-color: #f8fbff; }
        .conversation-item.active { background-color: #e7f3ff; }
        .conversation-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #1a6bca; color: white; display: flex; align-items: center; justify-content: center; margin-right: 10px; }
        .conversation-info { flex: 1; }
        .conversation-last-message { color: #777; font-size: 0.9rem; }
        .conversation-time { color: #999; font-size: 0.8rem; }
        .chat-messages { max-height: 500px; overflow-y: auto; padding: 15px; border: 1px solid #eef5ff; border-radius: 8px; background-color: #f8fbff; }
        .message-bubble { margin-bottom: 15px; max-width: 70%; }
        .message-bubble.sent { margin-left: auto; }
        .message-bubble-content { padding: 10px 15px; border-radius: 15px; }
        .message-bubble.received .message-bubble-content { background-color: white; border: 1px solid #eef5ff; }
        .message-bubble.sent .message-bubble-content { background-color: #1a6bca; color: white; }
        .message-bubble-time { font-size: 0.8rem; color: #999; margin-top: 5px; }
        .chat-input-container { display: flex; gap: 10px; margin-top: 15px; }
        
        .analysis-group { border: 1px solid #eef5ff; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .analysis-group h5 { color: #1a6bca; margin-bottom: 10px; }
        .doctor-modification-form { background-color: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .service-external-list { margin-top: 15px; }
        
        .notification-badge { background-color: #dc3545; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; position: absolute; top: -5px; right: -5px; }
        .nav-tab-with-badge { position: relative; }
        
        .modify-consultation-btn { margin-left: 10px; }
        .consultation-modification { background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .modify-analysis-btn { margin-left: 10px; }
        
        .stats-chart-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .chart-title { color: #1a6bca; margin-bottom: 15px; font-size: 1.2rem; }
        .chart-bar-container { margin: 10px 0; }
        .chart-bar-label { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .chart-bar-bg { height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; }
        .chart-bar-fill { height: 100%; background: linear-gradient(90deg, #1a6bca, #0d4d9c); border-radius: 10px; }
        .percentage-badge { background: #17a2b8; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; }
        
        .type-modification-panel { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ffc107; }
        .type-modification-panel h4 { color: #856404; margin-bottom: 10px; }
        
        .vip-tag { background-color: #ffc107; color: #212529; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .admin-search-section { margin-bottom: 25px; }
        .appointment-actions { display: flex; gap: 10px; margin-top: 10px; }
        
        /* Nouveaux styles pour les modifications */
        .privilege-container { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .sponsored-discount { background: #e7f3ff; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .consultation-display { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .external-only-section { background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .pharmacy-fix { border: 2px solid #28a745; }
        .service-external-list { max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #eef5ff; border-radius: 5px; }
        .medical-certificate-container { width: 210mm; min-height: 297mm; padding: 20mm; background: white; margin: 0 auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .certificate-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #1a6bca; padding-bottom: 20px; }
        .certificate-logo { max-width: 150px; margin-bottom: 10px; }
        .certificate-body { margin: 40px 0; line-height: 1.8; }
        .certificate-footer { margin-top: 60px; border-top: 1px solid #ddd; padding-top: 30px; }
        .signature-area { margin-top: 80px; }
        .logo-upload-container { margin: 10px 0; }
        .logo-preview { max-width: 100px; max-height: 100px; margin: 10px 0; }
    </style>
</head>
<body>
    <div id="login-screen" class="login-container">
        <div class="login-box">
            <div class="text-center mb-3">
                <img id="login-logo" src="" alt="Logo" class="certificate-logo" style="display:none;">
                <i class="fas fa-hospital-alt fa-3x" style="color: #1a6bca;" id="login-icon"></i>
                <h2 style="color: #1a6bca;" id="hospital-name-login">Hôpital Saint-Luc</h2>
            </div>
            
            <div class="login-buttons">
                <div class="login-role-btn active" data-role="admin"><i class="fas fa-user-shield"></i><p>Admin</p></div>
                <div class="login-role-btn" data-role="secretary"><i class="fas fa-user-tie"></i><p>Secrétariat</p></div>
                <div class="login-role-btn" data-role="cashier"><i class="fas fa-cash-register"></i><p>Caisse</p></div>
                <div class="login-role-btn" data-role="nurse"><i class="fas fa-user-nurse"></i><p>Infirmier</p></div>
                <div class="login-role-btn" data-role="doctor"><i class="fas fa-user-md"></i><p>Médecin</p></div>
                <div class="login-role-btn" data-role="lab"><i class="fas fa-flask"></i><p>Laboratoire</p></div>
                <div class="login-role-btn" data-role="pharmacy"><i class="fas fa-pills"></i><p>Pharmacie</p></div>
            </div>
            
            <form id="login-form">
                <div class="form-group">
                    <label class="form-label">Nom d'utilisateur</label>
                    <input type="text" id="username" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Mot de passe</label>
                    <input type="password" id="password" class="form-control" required>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Se Connecter</button>
            </form>
            
            <div class="mt-3 text-center">
                <p><strong>Identifiants par défaut:</strong></p>
                <p><small>Admin: admin / 1234</small></p>
                <p><small>Secrétariat: secretary / 1234</small></p>
                <p><small>Caisse: cashier / 1234</small></p>
                <p><small>Infirmier: nurse / 1234</small></p>
                <p><small>Médecin: doctor / 1234</small></p>
                <p><small>Laboratoire: lab / 1234</small></p>
                <p><small>Pharmacie: pharmacy / 1234</small></p>
            </div>
        </div>
    </div>
    
    <div id="main-app" class="hidden">
        <div class="container">
            <header class="header">
                <div class="logo">
                    <img id="header-logo" src="" alt="Logo" class="logo-img" style="display:none;">
                    <i class="fas fa-hospital-alt" id="header-icon"></i>
                    <div><h1 id="hospital-name-header">Hôpital Saint-Luc</h1><p id="hospital-address-header">Système de Gestion</p></div>
                </div>
                <div class="user-info">
                    <div>
                        <p id="current-user-role">Administrateur</p>
                        <p><strong id="current-username">User</strong></p>
                    </div>
                    <button id="logout-btn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Déconnexion</button>
                </div>
            </header>
            
            <nav class="nav-tabs no-print">
                <div class="nav-tab active" data-target="dashboard"><i class="fas fa-tachometer-alt"></i> Accueil</div>
                <div class="nav-tab" data-target="secretary"><i class="fas fa-user-tie"></i> Secrétariat</div>
                <div class="nav-tab" data-target="cashier"><i class="fas fa-cash-register"></i> Caisse</div>
                <div class="nav-tab" data-target="nurse"><i class="fas fa-user-nurse"></i> Infirmier</div>
                <div class="nav-tab" data-target="doctor"><i class="fas fa-user-md"></i> Médecin</div>
                <div class="nav-tab" data-target="laboratory"><i class="fas fa-flask"></i> Laboratoire</div>
                <div class="nav-tab" data-target="pharmacy"><i class="fas fa-pills"></i> Pharmacie</div>
                <div class="nav-tab nav-tab-with-badge" data-target="messaging"><i class="fas fa-comments"></i> Messagerie <span id="message-badge" class="notification-badge hidden">0</span></div>
                <div class="nav-tab" data-target="administration"><i class="fas fa-chart-bar"></i> Administration</div>
                <div class="nav-tab" data-target="settings"><i class="fas fa-cog"></i> Paramètres</div>
            </nav>
            
            <section id="dashboard" class="content active">
                <h2 class="section-title">Tableau de Bord - <span id="dashboard-role">Administrateur</span></h2>
                <div id="role-dashboard-content"></div>
            </section>
            
            <section id="secretary" class="content">
                <h2 class="section-title">Secrétariat</h2>
                
                <div class="card">
                    <h3><i class="fas fa-user-plus"></i> Nouveau Patient</h3>
                    <form id="patient-registration-form">
                        <div class="d-flex" style="gap:20px; margin-bottom: 15px;">
                            <div style="flex:2">
                                <label class="form-label">Nom complet *</label>
                                <input type="text" id="patient-fullname" class="form-control" required>
                            </div>
                            <div style="flex:1">
                                <label class="form-label">Date de naissance *</label>
                                <input type="date" id="patient-birthdate" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="d-flex" style="gap:20px; margin-bottom: 15px;">
                            <div style="flex:1">
                                <label class="form-label">Adresse</label>
                                <input type="text" id="patient-address" class="form-control">
                            </div>
                            <div style="flex:1">
                                <label class="form-label">Téléphone *</label>
                                <input type="tel" id="patient-phone" class="form-control" required>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label class="form-label">Personne responsable (si mineur)</label>
                            <input type="text" id="patient-responsible" class="form-control">
                        </div>
                        
                        <div class="d-flex" style="gap:20px; margin-bottom: 20px;">
                            <div style="flex:1">
                                <label class="form-label">Type de patient</label>
                                <div>
                                    <label><input type="radio" name="patient-type" id="patient-normal" value="normal" checked> Normal</label>
                                    <label style="margin-left: 20px;"><input type="radio" name="patient-type" id="patient-emergency" value="urgence"> Urgence</label>
                                    <label style="margin-left: 20px;"><input type="radio" name="patient-type" id="patient-pediatric" value="pediatrie"> Enfant</label>
                                    <label style="margin-left: 20px;"><input type="radio" name="patient-type" id="patient-external" value="externe"> Externe</label>
                                </div>
                                <div class="mt-2">
                                    <label><input type="checkbox" id="external-only" name="external-only"> Service externe uniquement (pas de consultation)</label>
                                </div>
                            </div>
                            <div style="flex:1" id="consultation-type-container">
                                <label class="form-label">Type de consultation *</label>
                                <select id="consultation-type-secretary" class="form-control" required>
                                    <option value="">Sélectionner...</option>
                                </select>
                                <button type="button" id="modify-consultation-type-btn" class="btn btn-warning btn-sm mt-2 modify-consultation-btn hidden">
                                    <i class="fas fa-edit"></i> Modifier ce type
                                </button>
                            </div>
                        </div>
                        
                        <div id="external-services-selection" class="hidden">
                            <h4>Services externes souhaités</h4>
                            <div id="external-services-options"></div>
                            <button type="button" id="add-external-service-registration" class="btn btn-secondary btn-sm mt-2">
                                <i class="fas fa-plus"></i> Ajouter service
                            </button>
                        </div>
                        
                        <div id="consultation-modification-secretary" class="type-modification-panel hidden">
                            <h4><i class="fas fa-edit"></i> Modification du type de consultation</h4>
                            <div class="d-flex" style="gap:15px;">
                                <input type="text" id="modified-consultation-name" class="form-control" placeholder="Nom modifié">
                                <input type="number" id="modified-consultation-price" class="form-control" placeholder="Prix modifié (Gdes)" min="0">
                                <button type="button" id="save-modified-consultation" class="btn btn-success">Enregistrer</button>
                                <button type="button" id="cancel-consultation-modification" class="btn btn-secondary">Annuler</button>
                            </div>
                            <small class="text-muted">Cette modification s'applique uniquement au patient en cours</small>
                        </div>
                        
                        <div class="d-flex" style="gap:15px;">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Enregistrer le dossier
                            </button>
                            <button type="button" id="generate-patient-id-card" class="btn btn-secondary">
                                <i class="fas fa-id-card"></i> Générer la carte patient
                            </button>
                            <button type="button" id="generate-medical-certificate" class="btn btn-info">
                                <i class="fas fa-file-medical"></i> Certificat médical
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-calendar-alt"></i> Gestion des Rendez-vous</h3>
                    <div class="d-flex" style="gap:15px; margin-bottom: 15px;">
                        <input type="text" id="appointment-patient-search" class="form-control" placeholder="ID patient">
                        <button id="search-appointment-patient" class="btn"><i class="fas fa-search"></i> Rechercher</button>
                    </div>
                    
                    <div id="appointment-patient-details" class="hidden">
                        <h4>Patient: <span id="appointment-patient-name"></span></h4>
                        <div class="form-group">
                            <label class="form-label">Date du rendez-vous</label>
                            <input type="date" id="appointment-date" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Heure du rendez-vous</label>
                            <input type="time" id="appointment-time" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Motif</label>
                            <input type="text" id="appointment-reason" class="form-control" placeholder="Motif du rendez-vous">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Médecin</label>
                            <select id="appointment-doctor" class="form-control">
                                <option value="">Sélectionner un médecin</option>
                            </select>
                        </div>
                        <button id="schedule-appointment" class="btn btn-success">
                            <i class="fas fa-calendar-plus"></i> Programmer le rendez-vous
                        </button>
                    </div>
                    
                    <div class="mt-3">
                        <h4>Rendez-vous programmés</h4>
                        <div id="appointments-list"></div>
                    </div>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-file-invoice-dollar"></i> Facturation Services Externes</h3>
                    <div class="d-flex" style="gap:15px; margin-bottom: 15px;">
                        <input type="text" id="external-service-search" class="form-control" placeholder="ID patient ou nom">
                        <button id="search-external-patient" class="btn"><i class="fas fa-search"></i> Rechercher</button>
                    </div>
                    
                    <div id="external-services-container" class="hidden">
                        <h4>Services externes pour <span id="external-patient-name"></span></h4>
                        <div id="external-services-list"></div>
                        
                        <div class="mt-3">
                            <h5>Ajouter un service externe</h5>
                            <div class="d-flex" style="gap:10px;">
                                <select id="external-service-select" class="form-control">
                                    <option value="">Choisir un service</option>
                                </select>
                                <input type="number" id="new-external-service-price" class="form-control" placeholder="Prix (Gdes)" min="0">
                                <button id="add-external-service" class="btn btn-success">
                                    <i class="fas fa-plus"></i> Ajouter
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button id="generate-external-invoice" class="btn btn-warning">
                                <i class="fas fa-file-invoice"></i> Générer facture
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-list"></i> Patients enregistrés aujourd'hui</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nom</th>
                                    <th>Téléphone</th>
                                    <th>Type</th>
                                    <th>Consultation</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="today-patients-list"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="patient-card-container" class="hidden printable">
                    <div class="patient-card">
                        <div class="patient-card-header text-center">
                            <img id="card-logo" src="" alt="Logo" style="max-width: 80px; margin: 0 auto 10px; display: none;">
                            <h3 id="card-hospital-name">Hôpital Saint-Luc</h3>
                            <p id="card-hospital-address">Port-au-Prince, Haïti</p>
                        </div>
                        <div class="patient-photo">
                            <i class="fas fa-user fa-3x" style="color:#666;"></i>
                        </div>
                        <div class="text-center">
                            <h4 id="card-patient-name">Jean Dupont</h4>
                            <p><strong>ID:</strong> <span id="card-patient-id">PA0001</span></p>
                            <p><strong>Date Naissance:</strong> <span id="card-patient-dob">01/01/1980</span></p>
                            <p><strong>Téléphone:</strong> <span id="card-patient-phone">12345678</span></p>
                            <p><strong>Date d'émission:</strong> <span id="card-issue-date">01/01/2024</span></p>
                            <div class="mt-3">
                                <span id="card-patient-type" class="emergency-patient-tag">URGENCE</span>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <p><small>Cette carte doit être présentée à chaque visite</small></p>
                            <p><small>Valable pour 1 an à partir de la date d'émission</small></p>
                        </div>
                    </div>
                </div>
                
                <div id="medical-certificate-container" class="hidden printable">
                    <div class="medical-certificate">
                        <div class="certificate-header">
                            <img id="certificate-logo" src="" alt="Logo" class="certificate-logo" style="display:none;">
                            <h2 id="certificate-hospital-name">Hôpital Saint-Luc</h2>
                            <p id="certificate-hospital-address">Port-au-Prince, Haïti</p>
                            <p id="certificate-hospital-phone">Tél: (509) 1234-5678</p>
                            <h3 style="margin-top: 20px;">CERTIFICAT MÉDICAL</h3>
                        </div>
                        
                        <div class="certificate-body">
                            <p style="text-align: right;">N°: <span id="certificate-number">CM-001</span></p>
                            <p>Le directeur de l'établissement <strong id="certificate-hospital-name-text">Hôpital Saint-Luc</strong>,</p>
                            <p style="text-align: center; margin: 30px 0; font-size: 1.2em;">
                                <strong>CERTIFIE</strong>
                            </p>
                            <p>Que <strong id="certificate-patient-name">Jean Dupont</strong>, né(e) le <span id="certificate-patient-dob">01/01/1980</span>,</p>
                            <p>demeurant à <span id="certificate-patient-address">123 Rue Principale, Port-au-Prince</span>,</p>
                            <p>a été examiné(e) dans notre établissement le <span id="certificate-consultation-date">01/01/2024</span>.</p>
                            
                            <div style="margin: 30px 0;">
                                <p><strong>Diagnostic:</strong></p>
                                <div id="certificate-diagnosis" style="padding: 15px; background: #f8f9fa; border-radius: 5px; margin-top: 10px;">
                                    Fièvre légère et maux de tête. Pas de signes alarmants.
                                </div>
                            </div>
                            
                            <p>En conséquence, nous attestons que l'intéressé(e) est dans l'incapacité de poursuivre ses activités habituelles et nécessite:</p>
                            
                            <div style="margin: 20px 0;">
                                <div id="certificate-rest-type">
                                    <p><input type="radio" name="rest-type" value="indetermine" checked> Un repos d'une durée indéterminée</p>
                                    <p><input type="radio" name="rest-type" value="determine"> Un repos de <input type="number" id="rest-days" value="7" style="width: 60px;"> jours</p>
                                </div>
                            </div>
                            
                            <p>Le présent certificat est délivré à la demande de l'intéressé(e) pour faire valoir ce que de droit.</p>
                        </div>
                        
                        <div class="certificate-footer">
                            <div style="text-align: right;">
                                <p>Fait à Port-au-Prince, le <span id="certificate-date">01 janvier 2024</span></p>
                                <div class="signature-area">
                                    <p>Le Médecin Responsable,</p>
                                    <p style="margin-top: 50px;">___________________________</p>
                                    <p>Dr. <span id="certificate-doctor">Médecin</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="cashier" class="content">
                <h2 class="section-title">Caisse</h2>
                
                <div class="card">
                    <h3><i class="fas fa-search"></i> Rechercher Patient</h3>
                    <div class="d-flex" style="gap:15px;">
                        <input type="text" id="cashier-patient-search" class="form-control" placeholder="ID patient ou nom">
                        <button id="search-cashier-patient" class="btn"><i class="fas fa-search"></i> Rechercher</button>
                    </div>
                </div>
                
                <div id="cashier-patient-details" class="hidden">
                    <div class="card">
                        <h3>Détails du patient: <span id="cashier-patient-name"></span> (<span id="cashier-patient-id"></span>)</h3>
                        
                        <div class="mt-3">
                            <h4>Services à payer</h4>
                            <div id="services-to-pay-list"></div>
                            
                            <div class="cashier-total">
                                <h3>Total à payer: <span id="total-to-pay">0</span> Gdes</h3>
                            </div>
                        </div>
                        
                        <div class="change-money-container">
                            <h4>Calcul de monnaie</h4>
                            <div class="d-flex" style="gap:15px; align-items: center;">
                                <label>Montant donné:</label>
                                <input type="number" id="amount-given" class="form-control" style="width:150px;" placeholder="Montant en Gdes" min="0">
                                <div class="change-money-result" id="change-result">Monnaie: 0 Gdes</div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <h4>Moyen de paiement</h4>
                            <div class="payment-method-selector">
                                <div class="payment-method active" data-method="cash">
                                    <i class="fas fa-money-bill-wave fa-2x"></i>
                                    <p>Espèces</p>
                                </div>
                                <div class="payment-method" data-method="moncash">
                                    <i class="fas fa-mobile-alt fa-2x"></i>
                                    <p>MonCash</p>
                                </div>
                                <div class="payment-method" data-method="natcash">
                                    <i class="fas fa-wallet fa-2x"></i>
                                    <p>NatCash</p>
                                </div>
                                <div class="payment-method" data-method="card">
                                    <i class="fas fa-credit-card fa-2x"></i>
                                    <p>Carte bancaire</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-between mt-3">
                            <button id="mark-as-paid" class="btn btn-success">
                                <i class="fas fa-check-circle"></i> Marquer comme payé
                            </button>
                            <button id="print-invoice" class="btn btn-warning">
                                <i class="fas fa-print"></i> Imprimer la facture
                            </button>
                            <button id="print-receipt" class="btn btn-info">
                                <i class="fas fa-receipt"></i> Imprimer reçu
                            </button>
                        </div>
                    </div>
                    
                    <div id="invoice-container" class="hidden printable">
                        <div class="print-receipt">
                            <div class="text-center">
                                <img id="invoice-logo" src="" alt="Logo" style="max-width: 80px; margin: 0 auto 10px; display: none;">
                                <h3 id="invoice-hospital-name">Hôpital Saint-Luc</h3>
                                <p id="invoice-hospital-address">Port-au-Prince, Haïti</p>
                                <p id="invoice-hospital-phone">Tél: (509) 1234-5678</p>
                            </div>
                            <hr>
                            <div>
                                <p><strong>Patient:</strong> <span id="invoice-patient-name">Jean Dupont</span></p>
                                <p><strong>ID Patient:</strong> <span id="invoice-patient-id">PA0001</span></p>
                                <p><strong>Date:</strong> <span id="invoice-date">01/01/2024</span></p>
                                <p><strong>Heure:</strong> <span id="invoice-time">10:30</span></p>
                            </div>
                            <hr>
                            <div id="invoice-services-list"></div>
                            <hr>
                            <div class="receipt-item">
                                <span><strong>TOTAL:</strong></span>
                                <span><strong id="invoice-total-amount">0</strong> Gdes</span>
                            </div>
                            <div class="receipt-item">
                                <span>Montant donné:</span>
                                <span id="invoice-amount-given">0 Gdes</span>
                            </div>
                            <div class="receipt-item">
                                <span>Monnaie rendue:</span>
                                <span id="invoice-change">0 Gdes</span>
                            </div>
                            <div class="receipt-item">
                                <span>Moyen de paiement:</span>
                                <span id="invoice-payment-method">Espèces</span>
                            </div>
                            <hr>
                            <div class="text-center">
                                <p>Merci pour votre confiance!</p>
                                <p><small>Facture #<span id="invoice-number">INV001</span></small></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="external-medications-container" class="hidden card mt-3">
                    <h3><i class="fas fa-exclamation-triangle"></i> Médicaments à acheter ailleurs</h3>
                    <div id="external-medications-list"></div>
                    <div class="print-controls">
                        <button id="print-external-meds" class="btn btn-warning">
                            <i class="fas fa-print"></i> Imprimer la liste
                        </button>
                    </div>
                </div>
            </section>
            
            <section id="nurse" class="content">
                <h2 class="section-title">Infirmier - Signes Vitaux</h2>
                
                <div class="card">
                    <h3><i class="fas fa-search"></i> Rechercher Patient</h3>
                    <div class="d-flex" style="gap:15px;">
                        <input type="text" id="nurse-patient-search" class="form-control" placeholder="ID patient ou nom">
                        <button id="search-nurse-patient" class="btn"><i class="fas fa-search"></i> Rechercher</button>
                    </div>
                </div>
                
                <div id="nurse-patient-details" class="hidden">
                    <div class="card">
                        <h3>Patient: <span id="nurse-patient-name"></span> (<span id="nurse-patient-id"></span>)</h3>
                        <p><strong>Statut paiement:</strong> <span id="nurse-payment-status" class="patient-status-badge status-unpaid">Non payé</span></p>
                        
                        <div class="vitals-form mt-3">
                            <h4><i class="fas fa-heartbeat"></i> Signes Vitaux</h4>
                            <form id="vitals-form">
                                <div id="vitals-inputs-container"></div>
                                <button type="submit" class="btn btn-success mt-3">
                                    <i class="fas fa-save"></i> Enregistrer les signes vitaux
                                </button>
                            </form>
                        </div>
                        
                        <div class="mt-3">
                            <h4>Historique des signes vitaux</h4>
                            <div id="vitals-history"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="doctor" class="content">
                <h2 class="section-title">Médecin - Consultation</h2>
                
                <div class="card">
                    <h3><i class="fas fa-search"></i> Rechercher Patient</h3>
                    <div class="d-flex" style="gap:15px;">
                        <input type="text" id="doctor-patient-search" class="form-control" placeholder="ID patient ou nom">
                        <button id="search-doctor-patient" class="btn"><i class="fas fa-search"></i> Rechercher</button>
                    </div>
                </div>
                
                <div id="doctor-patient-details" class="hidden">
                    <div class="card">
                        <h3>Patient: <span id="doctor-patient-name"></span> (<span id="doctor-patient-id"></span>)</h3>
                        
                        <div class="d-flex" style="gap:20px; margin-bottom: 20px;">
                            <div style="flex:1">
                                <p><strong>Âge:</strong> <span id="doctor-patient-age"></span> ans</p>
                                <p><strong>Téléphone:</strong> <span id="doctor-patient-phone"></span></p>
                            </div>
                            <div style="flex:1">
                                <p><strong>Type:</strong> <span id="doctor-patient-type"></span></p>
                                <p><strong>Statut paiement:</strong> <span id="doctor-payment-status" class="patient-status-badge"></span></p>
                            </div>
                        </div>
                        
                        <div id="current-consultation-display" class="consultation-display">
                            <h4><i class="fas fa-stethoscope"></i> Consultation enregistrée par le secrétariat</h4>
                            <div id="current-consultation-info"></div>
                            <div id="consultation-modification-section" class="hidden mt-3">
                                <h5>Modifier la consultation</h5>
                                <div class="d-flex" style="gap:10px;">
                                    <select id="doctor-consultation-type" class="form-control">
                                        <option value="">Sélectionner un type</option>
                                    </select>
                                    <button id="update-consultation-type" class="btn btn-warning">Modifier</button>
                                </div>
                                <small class="text-muted">Si le nouveau type est plus cher, le patient devra retourner à la caisse</small>
                            </div>
                        </div>
                        
                        <div id="doctor-patient-vitals" class="vitals-form">
                            <h4><i class="fas fa-heartbeat"></i> Signes Vitaux Récents</h4>
                            <div id="current-vitals-display"></div>
                            <button id="edit-vitals-btn" class="btn btn-warning mt-2">
                                <i class="fas fa-edit"></i> Modifier les signes vitaux
                            </button>
                        </div>
                        
                        <div class="doctor-modification-form hidden" id="doctor-vitals-modification">
                            <h4><i class="fas fa-edit"></i> Modification des signes vitaux</h4>
                            <form id="vitals-modification-form">
                                <div id="vitals-modification-inputs"></div>
                                <button type="submit" class="btn btn-success mt-2">
                                    <i class="fas fa-save"></i> Enregistrer modifications
                                </button>
                                <button type="button" id="cancel-vitals-modification" class="btn btn-secondary mt-2">
                                    Annuler
                                </button>
                            </form>
                        </div>
                        
                        <div class="mt-3">
                            <h4><i class="fas fa-stethoscope"></i> Consultation médicale</h4>
                            <form id="consultation-form">
                                <div class="form-group">
                                    <label class="form-label">Diagnostic</label>
                                    <textarea id="consultation-diagnosis" class="form-control" rows="3" placeholder="Entrez le diagnostic..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Analyses demandées 
                                        <button type="button" id="modify-analyses-btn" class="btn btn-warning btn-sm modify-analysis-btn">
                                            <i class="fas fa-edit"></i> Modifier les analyses
                                        </button>
                                    </label>
                                    <div id="lab-analyses-selection"></div>
                                    <div id="lab-modification-panel" class="type-modification-panel hidden">
                                        <h5>Modification des analyses</h5>
                                        <div class="d-flex" style="gap:10px; margin-bottom:10px;">
                                            <input type="text" id="modified-analysis-name" class="form-control" placeholder="Nom modifié">
                                            <input type="number" id="modified-analysis-price" class="form-control" placeholder="Prix modifié (Gdes)" min="0">
                                            <button type="button" id="save-modified-analysis" class="btn btn-success btn-sm">Enregistrer</button>
                                            <button type="button" id="cancel-analysis-modification" class="btn btn-secondary btn-sm">Annuler</button>
                                        </div>
                                        <small class="text-muted">Cette modification s'applique uniquement au patient en cours</small>
                                    </div>
                                    <div class="mt-2">
                                        <input type="text" id="custom-analysis-name" class="form-control" placeholder="Nom d'analyse personnalisée" style="width:70%; display:inline-block;">
                                        <input type="number" id="custom-analysis-price" class="form-control" placeholder="Prix" style="width:25%; display:inline-block;">
                                        <button type="button" id="add-custom-analysis" class="btn btn-sm btn-secondary mt-1">Ajouter analyse personnalisée</button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Médicaments prescrits</label>
                                    <div class="mb-2">
                                        <input type="text" id="medication-search" class="form-control" placeholder="Rechercher médicament (ex: paracétamol)">
                                        <div id="medication-suggestions" class="hidden" style="border:1px solid #ddd; background:white; max-height:200px; overflow-y:auto; position:absolute; width:300px; z-index:100;"></div>
                                    </div>
                                    
                                    <table class="medication-prescription-table">
                                        <thead>
                                            <tr>
                                                <th>Médicament</th>
                                                <th>Posologie</th>
                                                <th>Quantité</th>
                                                <th>Stock</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="prescription-medications-list"></tbody>
                                    </table>
                                    
                                    <div id="stock-warnings" class="mt-2"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Rendez-vous de suivi</label>
                                    <div class="d-flex" style="gap:15px;">
                                        <input type="date" id="followup-date" class="form-control">
                                        <input type="time" id="followup-time" class="form-control">
                                    </div>
                                </div>
                                
                                <div class="d-flex" style="gap:15px;">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save"></i> Enregistrer la consultation
                                    </button>
                                    <button type="button" id="modify-consultation-btn" class="btn btn-warning">
                                        <i class="fas fa-edit"></i> Modifier la consultation
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <h3><i class="fas fa-flask"></i> Résultats d'analyses</h3>
                    <div id="doctor-lab-results"></div>
                </div>
                
                <div class="card mt-3">
                    <h3><i class="fas fa-calendar-alt"></i> Rendez-vous des Patients</h3>
                    <div class="d-flex" style="gap:15px; margin-bottom: 15px;">
                        <input type="text" id="doctor-appointment-search" class="form-control" placeholder="ID patient">
                        <button id="search-doctor-appointment" class="btn"><i class="fas fa-search"></i> Rechercher</button>
                    </div>
                    <div id="doctor-appointment-results"></div>
                </div>
            </section>
            
            <section id="laboratory" class="content">
                <h2 class="section-title">Laboratoire</h2>
                
                <div class="card">
                    <h3><i class="fas fa-search"></i> Rechercher Patient</h3>
                    <div class="d-flex" style="gap:15px;">
                        <input type="text" id="lab-patient-search" class="form-control" placeholder="ID patient ou nom">
                        <button id="search-lab-patient" class="btn"><i class="fas fa-search"></i> Rechercher</button>
                    </div>
                </div>
                
                <div id="lab-patient-details" class="hidden">
                    <div class="card">
                        <h3>Patient: <span id="lab-patient-name"></span> (<span id="lab-patient-id"></span>)</h3>
                        <p><strong>Statut paiement:</strong> <span id="lab-payment-status" class="patient-status-badge"></span></p>
                        
                        <div id="lab-analyses-list" class="mt-3"></div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <h3><i class="fas fa-clock"></i> Analyses en attente de résultats</h3>
                    <div id="pending-analyses-list"></div>
                </div>
            </section>
            
            <section id="pharmacy" class="content">
                <h2 class="section-title">Pharmacie</h2>
                
                <div class="card">
                    <h3><i class="fas fa-search"></i> Rechercher Patient</h3>
                    <div class="d-flex" style="gap:15px;">
                        <input type="text" id="pharmacy-patient-search" class="form-control" placeholder="ID patient ou nom">
                        <button id="search-pharmacy-patient" class="btn"><i class="fas fa-search"></i> Rechercher</button>
                    </div>
                </div>
                
                <div id="pharmacy-patient-details" class="hidden">
                    <div class="card">
                        <h3>Patient: <span id="pharmacy-patient-name"></span> (<span id="pharmacy-patient-id"></span>)</h3>
                        <p><strong>Statut paiement:</strong> <span id="pharmacy-payment-status" class="patient-status-badge"></span></p>
                        
                        <div id="pharmacy-prescriptions-list" class="mt-3"></div>
                        
                        <div class="mt-3">
                            <button id="deliver-medications" class="btn btn-success" disabled>
                                <i class="fas fa-check"></i> Délivrer les médicaments
                            </button>
                            <button id="print-delivery-ticket" class="btn btn-warning">
                                <i class="fas fa-print"></i> Imprimer ticket de délivrance
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3 pharmacy-fix">
                    <h3><i class="fas fa-boxes"></i> Gestion du Stock</h3>
                    
                    <div class="d-flex" style="gap:15px; margin-bottom: 15px;">
                        <input type="text" id="medication-search-stock" class="form-control" placeholder="Rechercher médicament">
                        <button id="search-medication" class="btn btn-secondary">Rechercher</button>
                        <button id="add-new-medication" class="btn btn-success">
                            <i class="fas fa-plus"></i> Nouveau médicament
                        </button>
                    </div>
                    
                    <div id="new-medication-form" class="employee-form" style="display: none;">
                        <h4>Ajouter un nouveau médicament</h4>
                        <div class="d-flex" style="gap:10px; margin-bottom: 10px;">
                            <input type="text" id="new-med-name" class="form-control" placeholder="Nom commercial">
                            <input type="text" id="new-med-generic" class="form-control" placeholder="Nom générique">
                        </div>
                        <div class="d-flex" style="gap:10px; margin-bottom: 10px;">
                            <select id="new-med-form" class="form-control">
                                <option value="">Forme</option>
                                <option value="comprimé">Comprimé</option>
                                <option value="capsule">Capsule</option>
                                <option value="sirop">Sirop</option>
                                <option value="injection">Injection</option>
                                <option value="pommade">Pommade</option>
                            </select>
                            <input type="text" id="new-med-unit" class="form-control" placeholder="Unité (comprimés, ml, etc.)">
                            <input type="number" id="new-med-quantity" class="form-control" placeholder="Quantité initiale" min="0">
                        </div>
                        <div class="d-flex" style="gap:10px; margin-bottom: 10px;">
                            <input type="number" id="new-med-alert" class="form-control" placeholder="Seuil d'alerte" min="0">
                            <input type="number" id="new-med-price" class="form-control" placeholder="Prix unitaire (Gdes)" min="0" step="0.01">
                        </div>
                        <div class="d-flex" style="gap:10px;">
                            <button type="button" id="save-new-medication" class="btn btn-success">Enregistrer</button>
                            <button type="button" id="cancel-new-medication" class="btn btn-secondary">Annuler</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Médicament</th>
                                    <th>Forme</th>
                                    <th>Quantité</th>
                                    <th>Seuil d'alerte</th>
                                    <th>Prix unitaire</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="medication-stock-list"></tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <h4><i class="fas fa-exclamation-triangle"></i> Médicaments en rupture/stock faible</h4>
                        <div id="low-stock-medications"></div>
                    </div>
                </div>
            </section>
            
            <section id="messaging" class="content">
                <h2 class="section-title"><i class="fas fa-comments"></i> Messagerie</h2>
                
                <div class="messaging-container">
                    <div class="conversation-list">
                        <div class="d-flex" style="gap:10px; margin-bottom: 15px;">
                            <select id="message-recipient" class="form-control">
                                <option value="">Nouveau message...</option>
                                <option value="all">Tous les utilisateurs</option>
                                <option value="all-doctors">Tous les médecins</option>
                                <option value="all-nurses">Tous les infirmiers</option>
                                <option value="all-secretaries">Tous les secrétaires</option>
                                <option value="all-cashiers">Tous les caissiers</option>
                                <option value="all-labs">Tout le laboratoire</option>
                                <option value="all-pharmacies">Toute la pharmacie</option>
                                <option value="all-admins">Tous les administrateurs</option>
                            </select>
                            <button type="button" id="new-conversation-btn" class="btn btn-success">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="conversations-container"></div>
                    </div>
                    
                    <div class="chat-container">
                        <div class="card">
                            <h4 id="current-conversation-title">Sélectionnez une conversation</h4>
                            <div class="chat-messages" id="chat-messages"></div>
                            <div class="chat-input-container hidden" id="chat-input-container">
                                <input type="text" id="message-input" class="form-control" placeholder="Tapez votre message...">
                                <button type="button" id="send-message-btn" class="btn btn-success">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="administration" class="content">
                <h2 class="section-title">Administration - Statistiques</h2>
                
                <div class="admin-search-section card">
                    <h3><i class="fas fa-search"></i> Recherche Patient</h3>
                    <div class="d-flex" style="gap:15px;">
                        <input type="text" id="admin-patient-search" class="form-control" placeholder="ID patient">
                        <button type="button" id="search-admin-patient" class="btn"><i class="fas fa-search"></i> Rechercher</button>
                    </div>
                    <div id="admin-patient-details" class="hidden mt-3">
                        <h4>Patient: <span id="admin-patient-name"></span></h4>
                        
                        <div class="privilege-container">
                            <h5>Gestion des privilèges</h5>
                            <div class="d-flex" style="gap:15px; align-items:center;">
                                <label>Type de privilège:</label>
                                <select id="privilege-type" class="form-control" style="width:200px;">
                                    <option value="none">Aucun privilège</option>
                                    <option value="vip">VIP (gratuit)</option>
                                    <option value="sponsored">Sponsorisé (réduction %)</option>
                                </select>
                                <div id="discount-section" class="hidden">
                                    <label>Pourcentage de réduction:</label>
                                    <input type="number" id="discount-percentage" class="form-control" placeholder="%" min="0" max="100" style="width:100px;">
                                </div>
                                <button type="button" id="save-privilege" class="btn btn-success">Enregistrer</button>
                            </div>
                        </div>
                        
                        <h4>Historique complet du patient</h4>
                        <div id="admin-patient-history"></div>
                    </div>
                </div>
                
                <div class="stats-chart-container">
                    <div class="chart-card">
                        <h3 class="chart-title"><i class="fas fa-stethoscope"></i> Consultations</h3>
                        <div id="consultations-chart"></div>
                        <div class="text-center mt-2">
                            <p>Total: <span id="admin-consultations-count">0</span> | Montant: <span id="admin-consultations-amount">0 Gdes</span></p>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3 class="chart-title"><i class="fas fa-flask"></i> Analyses</h3>
                        <div id="analyses-chart"></div>
                        <div class="text-center mt-2">
                            <p>Total: <span id="admin-analyses-count">0</span> | Montant: <span id="admin-analyses-amount">0 Gdes</span></p>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3 class="chart-title"><i class="fas fa-pills"></i> Médicaments</h3>
                        <div id="medications-chart"></div>
                        <div class="text-center mt-2">
                            <p>Total: <span id="admin-medications-count">0</span> | Montant: <span id="admin-medications-amount">0 Gdes</span></p>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3 class="chart-title"><i class="fas fa-external-link-alt"></i> Services Externes</h3>
                        <div id="external-chart"></div>
                        <div class="text-center mt-2">
                            <p>Total: <span id="admin-external-count">0</span> | Montant: <span id="admin-external-amount">0 Gdes</span></p>
                        </div>
                    </div>
                </div>
                
                <div class="admin-stats-grid">
                    <div class="admin-stat-card clickable-stat" id="stat-revenue-card">
                        <h3><i class="fas fa-money-bill-wave"></i> Revenus Totaux</h3>
                        <h2 id="admin-total-revenue">0 Gdes</h2>
                        <p>Période: Aujourd'hui</p>
                        <div class="chart-bar-container mt-2">
                            <div class="chart-bar-label">
                                <span>Payés</span>
                                <span id="paid-percentage">0%</span>
                            </div>
                            <div class="chart-bar-bg">
                                <div id="paid-chart-bar" class="chart-bar-fill" style="width:0%"></div>
                            </div>
                        </div>
                        <div class="chart-bar-container">
                            <div class="chart-bar-label">
                                <span>Non payés</span>
                                <span id="unpaid-percentage">0%</span>
                            </div>
                            <div class="chart-bar-bg">
                                <div id="unpaid-chart-bar" class="chart-bar-fill" style="width:0%; background:#dc3545"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="admin-stat-card">
                        <h3><i class="fas fa-chart-pie"></i> Répartition des Services</h3>
                        <div id="services-pie-chart" class="mt-2" style="height:150px; position:relative;">
                            <div style="display:flex; justify-content:center; align-items:center; height:100%;">
                                <div style="width:120px; height:120px; border-radius:50%; background:conic-gradient(#1a6bca 0% 25%, #28a745 25% 50%, #ffc107 50% 75%, #17a2b8 75% 100%);"></div>
                            </div>
                            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center;">
                                <h4 id="total-services-count">0</h4>
                                <small>Services</small>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div><span class="percentage-badge" style="background:#1a6bca">Consultations</span> <span id="consultations-percentage">0%</span></div>
                            <div><span class="percentage-badge" style="background:#28a745">Analyses</span> <span id="analyses-percentage">0%</span></div>
                            <div><span class="percentage-badge" style="background:#ffc107">Médicaments</span> <span id="medications-percentage">0%</span></div>
                            <div><span class="percentage-badge" style="background:#17a2b8">Externes</span> <span id="external-percentage">0%</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <h3><i class="fas fa-history"></i> Transactions Récentes</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date/Heure</th>
                                    <th>Patient</th>
                                    <th>Service</th>
                                    <th>Montant</th>
                                    <th>Méthode</th>
                                    <th>Agent</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody id="recent-transactions-list"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="transaction-details-modal" class="transaction-details-modal hidden">
                    <div class="transaction-details-content">
                        <h3>Détails de la transaction</h3>
                        <div id="transaction-details-content"></div>
                        <div class="mt-3">
                            <button id="close-transaction-details" class="btn btn-secondary">Fermer</button>
                            <button id="edit-transaction" class="btn btn-warning">Modifier</button>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="settings" class="content">
                <h2 class="section-title"><i class="fas fa-cog"></i> Paramètres du Système</h2>
                
                <div class="card">
                    <h3><i class="fas fa-hospital"></i> Informations de l'Hôpital</h3>
                    <div class="hospital-info-form">
                        <div class="form-group">
                            <label class="form-label">Nom de l'Hôpital</label>
                            <input type="text" id="hospital-name" class="form-control" value="Hôpital Saint-Luc">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Adresse</label>
                            <input type="text" id="hospital-address" class="form-control" value="Port-au-Prince, Haïti">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Téléphone</label>
                            <input type="text" id="hospital-phone" class="form-control" value="(509) 1234-5678">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Logo de l'Hôpital</label>
                            <div class="logo-upload-container">
                                <input type="file" id="hospital-logo" class="form-control" accept="image/*">
                                <img id="logo-preview" src="" alt="Aperçu du logo" class="logo-preview" style="display:none;">
                            </div>
                            <small class="text-muted">Taille recommandée: 150x150 pixels. Formats: JPG, PNG</small>
                        </div>
                        <button type="button" id="save-hospital-info-btn" class="btn btn-success">Enregistrer</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-pills"></i> Gestion des Médicaments</h3>
                    <div class="d-flex" style="gap:15px; margin-top:15px;">
                        <input type="text" id="new-medication-name" class="form-control" placeholder="Nom du médicament">
                        <input type="number" id="new-medication-price" class="form-control" placeholder="Prix unitaire (Gdes)" min="0">
                        <input type="number" id="new-medication-quantity" class="form-control" placeholder="Quantité initiale" min="0">
                        <input type="number" id="new-medication-alert" class="form-control" placeholder="Seuil d'alerte" min="0">
                        <button type="button" id="add-medication-settings" class="btn btn-success">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                    </div>
                    <div class="table-container mt-3">
                        <table>
                            <thead>
                                <tr>
                                    <th>Médicament</th>
                                    <th>Prix</th>
                                    <th>Quantité</th>
                                    <th>Seuil alerte</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="medications-settings-list"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-stethoscope"></i> Types de Consultation</h3>
                    <div id="consultation-types-list"></div>
                    <div class="d-flex" style="gap:15px; margin-top:15px;">
                        <input type="text" id="new-consultation-type-name" class="form-control" placeholder="Nom du type">
                        <input type="number" id="new-consultation-type-price" class="form-control" placeholder="Prix (Gdes)" min="0">
                        <textarea id="new-consultation-type-description" class="form-control" placeholder="Description" rows="1"></textarea>
                        <button type="button" id="add-consultation-type" class="btn btn-success">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-heartbeat"></i> Signes Vitaux</h3>
                    <div id="vitals-types-list"></div>
                    <div class="d-flex" style="gap:15px; margin-top:15px;">
                        <input type="text" id="new-vital-name" class="form-control" placeholder="Nom du signe vital">
                        <input type="text" id="new-vital-unit" class="form-control" placeholder="Unité (ex: °C, bpm)">
                        <input type="number" id="new-vital-min" class="form-control" placeholder="Valeur min">
                        <input type="number" id="new-vital-max" class="form-control" placeholder="Valeur max">
                        <button type="button" id="add-vital-type" class="btn btn-success">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-flask"></i> Analyses de Laboratoire</h3>
                    <div id="lab-analyses-types-list"></div>
                    <div class="d-flex" style="gap:15px; margin-top:15px;">
                        <input type="text" id="new-lab-analysis-name" class="form-control" placeholder="Nom de l'analyse">
                        <input type="number" id="new-lab-analysis-price" class="form-control" placeholder="Prix (Gdes)" min="0">
                        <select id="new-lab-analysis-type" class="form-control">
                            <option value="text">Résultat texte</option>
                            <option value="image">Résultat image</option>
                        </select>
                        <button type="button" id="add-lab-analysis-type" class="btn btn-success">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-external-link-alt"></i> Services Externes</h3>
                    <div id="external-services-types-list"></div>
                    <div class="d-flex" style="gap:15px; margin-top:15px;">
                        <input type="text" id="new-external-service-type-name" class="form-control" placeholder="Nom du service">
                        <input type="number" id="new-external-service-type-price" class="form-control" placeholder="Prix (Gdes)" min="0">
                        <button type="button" id="add-external-service-type" class="btn btn-success">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-users"></i> Gestion des Utilisateurs</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Rôle</th>
                                    <th>Identifiant</th>
                                    <th>Actif</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-list"></tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <h4>Ajouter un utilisateur</h4>
                        <div class="d-flex" style="gap:15px;">
                            <input type="text" id="new-user-name" class="form-control" placeholder="Nom complet">
                            <select id="new-user-role" class="form-control">
                                <option value="">Sélectionner rôle</option>
                                <option value="admin">Administrateur</option>
                                <option value="secretary">Secrétariat</option>
                                <option value="cashier">Caisse</option>
                                <option value="nurse">Infirmier</option>
                                <option value="doctor">Médecin</option>
                                <option value="lab">Laboratoire</option>
                                <option value="pharmacy">Pharmacie</option>
                            </select>
                            <input type="text" id="new-user-username" class="form-control" placeholder="Identifiant">
                            <input type="password" id="new-user-password" class="form-control" placeholder="Mot de passe">
                            <button type="button" id="add-user" class="btn btn-success">Ajouter</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
    
    <div id="print-container"></div>

<script>
const state = {
    currentUser: null,
    currentRole: null,
    patients: [],
    consultations: [],
    labAnalyses: [],
    prescriptions: [],
    transactions: [],
    vitals: [],
    medicationStock: [],
    appointments: [],
    users: [
        { id: 1, name: "Administrateur", role: "admin", username: "admin", password: "1234", active: true },
        { id: 2, name: "Secrétaire", role: "secretary", username: "secretary", password: "1234", active: true },
        { id: 3, name: "Caissier", role: "cashier", username: "cashier", password: "1234", active: true },
        { id: 4, name: "Infirmier", role: "nurse", username: "nurse", password: "1234", active: true },
        { id: 5, name: "Docteur", role: "doctor", username: "doctor", password: "1234", active: true },
        { id: 6, name: "Laboratoire", role: "lab", username: "lab", password: "1234", active: true },
        { id: 7, name: "Pharmacien", role: "pharmacy", username: "pharmacy", password: "1234", active: true }
    ],
    consultationTypes: [
        { id: 1, name: "Consultation générale", price: 500, description: "Consultation médicale standard", active: true },
        { id: 2, name: "Urgence", price: 1000, description: "Consultation en urgence", active: true },
        { id: 3, name: "Pédiatrie", price: 400, description: "Consultation pour enfants", active: true }
    ],
    vitalTypes: [
        { id: 1, name: "Tension artérielle", unit: "mmHg", min: 90, max: 140, active: true },
        { id: 2, name: "Température", unit: "°C", min: 36, max: 38, active: true },
        { id: 3, name: "Pouls", unit: "bpm", min: 60, max: 100, active: true },
        { id: 4, name: "Fréquence respiratoire", unit: "rpm", min: 12, max: 20, active: true },
        { id: 5, name: "Saturation O2", unit: "%", min: 95, max: 100, active: true },
        { id: 6, name: "Glycémie", unit: "mg/dL", min: 70, max: 140, active: true }
    ],
    labAnalysisTypes: [
        { id: 1, name: "Hémogramme complet", price: 300, resultType: "text", active: true },
        { id: 2, name: "Glycémie à jeun", price: 150, resultType: "text", active: true },
        { id: 3, name: "Créatinine", price: 200, resultType: "text", active: true },
        { id: 4, name: "Radiographie pulmonaire", price: 500, resultType: "image", active: true }
    ],
    externalServiceTypes: [
        { id: 1, name: "Ambulance", price: 1500, active: true },
        { id: 2, name: "Chambre privée", price: 2000, active: true },
        { id: 3, name: "Matériel médical", price: 3000, active: true }
    ],
    externalServices: [],
    patientCounter: 1,
    transactionCounter: 1,
    messages: [],
    unreadMessages: 0,
    currentConversation: null,
    currentModifiedConsultation: null,
    currentModifiedAnalysis: null,
    hospitalLogo: null
};

document.addEventListener('DOMContentLoaded', () => {
    initApp();
});

function initApp() {
    setupLogin();
    setupNavigation();
    loadDemoData();
    updateSettingsDisplay();
    updateMedicationStock();
    updateMessageRecipients();
    setupAppointments();
    setupAdminSearch();
    setupPharmacy();
    setupPatientTypeChange();
    setupMessaging();
    setupSettings();
    setupMedicalCertificate();
}

function setupLogin() {
    const roleBtns = document.querySelectorAll('.login-role-btn');
    roleBtns.forEach(btn => btn.addEventListener('click', function() {
        roleBtns.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
    }));

    document.getElementById('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const selectedRole = document.querySelector('.login-role-btn.active').dataset.role;
        
        const user = state.users.find(u => 
            u.username === username && 
            u.password === password && 
            u.role === selectedRole &&
            u.active === true
        );
        
        if (!user) {
            alert("Identifiants incorrects ou compte désactivé!");
            return;
        }
        
        state.currentUser = user;
        state.currentRole = selectedRole;
        
        document.getElementById('current-username').textContent = user.name;
        document.getElementById('current-user-role').textContent = user.role;
        document.getElementById('dashboard-role').textContent = user.role.charAt(0).toUpperCase() + user.role.slice(1);
        
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        
        setupRoleBasedNavigation();
        updateRoleDashboard();
        
        updateConsultationTypesSelect();
        updateVitalsInputs();
        updateLabAnalysesSelect();
        updateTodayPatientsList();
        updateExternalServicesSelect();
        updateExternalServicesOptions();
        checkUnreadMessages();
        loadDoctorsForAppointments();
        updateDoctorConsultationTypes();
        updateLogoDisplay();
    });

    document.getElementById('logout-btn').addEventListener('click', () => {
        if (confirm("Voulez-vous vous déconnecter?")) {
            location.reload();
        }
    });
}

function updateLogoDisplay() {
    if (state.hospitalLogo) {
        // Mettre à jour le logo dans l'en-tête
        const headerLogo = document.getElementById('header-logo');
        const headerIcon = document.getElementById('header-icon');
        headerLogo.src = state.hospitalLogo;
        headerLogo.style.display = 'block';
        headerIcon.style.display = 'none';
        
        // Mettre à jour le logo dans l'écran de connexion
        const loginLogo = document.getElementById('login-logo');
        const loginIcon = document.getElementById('login-icon');
        loginLogo.src = state.hospitalLogo;
        loginLogo.style.display = 'block';
        loginIcon.style.display = 'none';
    }
}

function setupSettings() {
    document.getElementById('add-medication-settings').addEventListener('click', addMedicationFromSettings);
    document.getElementById('hospital-logo').addEventListener('change', handleLogoUpload);
}

function handleLogoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        state.hospitalLogo = e.target.result;
        document.getElementById('logo-preview').src = e.target.result;
        document.getElementById('logo-preview').style.display = 'block';
    };
    reader.readAsDataURL(file);
}

function addMedicationFromSettings() {
    const name = document.getElementById('new-medication-name').value.trim();
    const price = parseFloat(document.getElementById('new-medication-price').value);
    const quantity = parseInt(document.getElementById('new-medication-quantity').value);
    const alertThreshold = parseInt(document.getElementById('new-medication-alert').value);
    
    if (!name || isNaN(price) || isNaN(quantity) || isNaN(alertThreshold)) {
        alert("Veuillez remplir tous les champs correctement!");
        return;
    }
    
    const newMed = {
        id: 'MED' + Date.now(),
        name: name,
        genericName: name,
        form: 'comprimé',
        quantity: quantity,
        unit: 'comprimés',
        alertThreshold: alertThreshold,
        price: price,
        reserved: 0
    };
    
    state.medicationStock.push(newMed);
    
    document.getElementById('new-medication-name').value = '';
    document.getElementById('new-medication-price').value = '';
    document.getElementById('new-medication-quantity').value = '';
    document.getElementById('new-medication-alert').value = '';
    
    updateMedicationStock();
    updateMedicationsSettingsList();
    alert("Médicament ajouté avec succès!");
}

function updateMedicationsSettingsList() {
    const container = document.getElementById('medications-settings-list');
    let html = '';
    
    state.medicationStock.forEach(med => {
        html += `
            <tr>
                <td>${med.name}</td>
                <td>${med.price} Gdes</td>
                <td>${med.quantity} ${med.unit}</td>
                <td>${med.alertThreshold}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteMedicationSettings('${med.id}')">
                        Supprimer
                    </button>
                </td>
            </tr>
        `;
    });
    
    container.innerHTML = html;
}

function deleteMedicationSettings(medId) {
    if (confirm("Supprimer ce médicament?")) {
        state.medicationStock = state.medicationStock.filter(m => m.id !== medId);
        updateMedicationStock();
        updateMedicationsSettingsList();
    }
}

function setupRoleBasedNavigation() {
    const tabs = document.querySelectorAll('.nav-tab');
    const role = state.currentRole;
    
    tabs.forEach(tab => {
        const target = tab.dataset.target;
        
        if (role === 'admin') {
            tab.classList.remove('hidden');
        } else if (role === 'secretary') {
            if (['dashboard', 'secretary', 'messaging'].includes(target)) {
                tab.classList.remove('hidden');
            } else {
                tab.classList.add('hidden');
            }
        } else if (role === 'cashier') {
            if (['dashboard', 'cashier', 'messaging'].includes(target)) {
                tab.classList.remove('hidden');
            } else {
                tab.classList.add('hidden');
            }
        } else if (role === 'nurse') {
            if (['dashboard', 'nurse', 'messaging'].includes(target)) {
                tab.classList.remove('hidden');
            } else {
                tab.classList.add('hidden');
            }
        } else if (role === 'doctor') {
            if (['dashboard', 'doctor', 'messaging'].includes(target)) {
                tab.classList.remove('hidden');
            } else {
                tab.classList.add('hidden');
            }
        } else if (role === 'lab') {
            if (['dashboard', 'laboratory', 'messaging'].includes(target)) {
                tab.classList.remove('hidden');
            } else {
                tab.classList.add('hidden');
            }
        } else if (role === 'pharmacy') {
            if (['dashboard', 'pharmacy', 'messaging'].includes(target)) {
                tab.classList.remove('hidden');
            } else {
                tab.classList.add('hidden');
            }
        }
    });
    
    const visibleTabs = document.querySelectorAll('.nav-tab:not(.hidden)');
    if (visibleTabs.length > 0) {
        visibleTabs.forEach(t => t.classList.remove('active'));
        visibleTabs[0].classList.add('active');
        
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.getElementById(visibleTabs[0].dataset.target).classList.add('active');
    }
}

function setupNavigation() {
    const tabs = document.querySelectorAll('.nav-tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById(this.dataset.target).classList.add('active');
            
            const target = this.dataset.target;
            if (target === 'dashboard') {
                updateRoleDashboard();
            } else if (target === 'secretary') {
                updateTodayPatientsList();
                updateConsultationTypesSelect();
                loadAppointmentsList();
            } else if (target === 'administration') {
                updateAdminStats();
                updateCharts();
            } else if (target === 'pharmacy') {
                updateMedicationStock();
            } else if (target === 'messaging') {
                loadConversations();
                updateMessageBadge();
            } else if (target === 'doctor') {
                loadDoctorAppointments();
            } else if (target === 'settings') {
                updateMedicationsSettingsList();
            }
        });
    });
}

function setupPatientTypeChange() {
    const patientTypeRadios = document.querySelectorAll('input[name="patient-type"]');
    patientTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const isExternal = this.value === 'externe';
            const consultationContainer = document.getElementById('consultation-type-container');
            const externalServicesSelection = document.getElementById('external-services-selection');
            const consultationSelect = document.getElementById('consultation-type-secretary');
            
            if (isExternal) {
                consultationContainer.classList.add('hidden');
                externalServicesSelection.classList.remove('hidden');
                consultationSelect.required = false;
            } else {
                consultationContainer.classList.remove('hidden');
                externalServicesSelection.classList.add('hidden');
                consultationSelect.required = true;
            }
        });
    });
    
    document.getElementById('external-only').addEventListener('change', function() {
        const consultationContainer = document.getElementById('consultation-type-container');
        const externalServicesSelection = document.getElementById('external-services-selection');
        const consultationSelect = document.getElementById('consultation-type-secretary');
        
        if (this.checked) {
            consultationContainer.classList.add('hidden');
            externalServicesSelection.classList.remove('hidden');
            consultationSelect.required = false;
        } else {
            consultationContainer.classList.remove('hidden');
            externalServicesSelection.classList.add('hidden');
            consultationSelect.required = true;
        }
    });
}

function updateExternalServicesOptions() {
    const container = document.getElementById('external-services-options');
    let html = '<div class="service-external-list">';
    state.externalServiceTypes.forEach(service => {
        if (service.active) {
            html += `
                <div class="service-item">
                    <div>
                        <input type="checkbox" class="external-service-option" value="${service.id}" data-price="${service.price}">
                        ${service.name} - ${service.price} Gdes
                    </div>
                </div>
            `;
        }
    });
    html += '</div>';
    container.innerHTML = html;
}

document.getElementById('add-external-service-registration').addEventListener('click', function() {
    const container = document.getElementById('external-services-options');
    const newService = document.createElement('div');
    newService.className = 'service-item';
    newService.innerHTML = `
        <div>
            <input type="text" class="form-control external-service-custom" placeholder="Nom du service" style="width:200px; display:inline-block;">
            <input type="number" class="form-control external-service-price" placeholder="Prix (Gdes)" style="width:150px; display:inline-block;">
            <button type="button" class="btn btn-danger btn-sm remove-external-service">X</button>
        </div>
    `;
    container.appendChild(newService);
    
    newService.querySelector('.remove-external-service').addEventListener('click', function() {
        this.closest('.service-item').remove();
    });
});

document.getElementById('patient-registration-form').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const fullName = document.getElementById('patient-fullname').value;
    const birthDate = document.getElementById('patient-birthdate').value;
    const address = document.getElementById('patient-address').value;
    const phone = document.getElementById('patient-phone').value;
    const responsible = document.getElementById('patient-responsible').value;
    const patientType = document.querySelector('input[name="patient-type"]:checked').value;
    const consultationTypeId = parseInt(document.getElementById('consultation-type-secretary').value);
    const externalOnly = document.getElementById('external-only').checked;
    
    if (patientType !== 'externe' && !externalOnly && !consultationTypeId) {
        alert("Veuillez sélectionner un type de consultation pour les patients normaux!");
        return;
    }
    
    const prefix = patientType === 'urgence' ? 'URG' : (patientType === 'pediatrie' ? 'PED' : (patientType === 'externe' ? 'EXT' : 'PAT'));
    const patientId = prefix + state.patientCounter.toString().padStart(4, '0');
    state.patientCounter++;
    
    const newPatient = {
        id: patientId,
        fullName: fullName,
        birthDate: birthDate,
        address: address,
        phone: phone,
        responsible: responsible,
        type: patientType,
        vip: false,
        sponsored: false,
        discountPercentage: 0,
        registrationDate: new Date().toISOString().split('T')[0],
        registrationTime: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
        registeredBy: state.currentUser.username
    };
    
    state.patients.push(newPatient);
    
    if (externalOnly || patientType === 'externe') {
        const externalCheckboxes = document.querySelectorAll('.external-service-option:checked');
        let hasServices = false;
        
        externalCheckboxes.forEach(cb => {
            const serviceId = parseInt(cb.value);
            const service = state.externalServiceTypes.find(s => s.id === serviceId);
            
            if (service) {
                hasServices = true;
                const externalTransaction = {
                    id: 'EXT' + state.transactionCounter.toString().padStart(4, '0'),
                    patientId: patientId,
                    patientName: fullName,
                    service: `Service externe: ${service.name}`,
                    amount: service.price,
                    status: 'unpaid',
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                    createdBy: state.currentUser.username,
                    type: 'external',
                    notificationSent: false
                };
                
                state.transactionCounter++;
                state.transactions.push(externalTransaction);
                sendNotificationToCashier(externalTransaction);
            }
        });
        
        const customServices = document.querySelectorAll('.external-service-custom');
        customServices.forEach((serviceInput, index) => {
            const serviceName = serviceInput.value;
            const priceInput = document.querySelectorAll('.external-service-price')[index];
            const servicePrice = parseFloat(priceInput.value);
            
            if (serviceName && !isNaN(servicePrice)) {
                hasServices = true;
                const externalTransaction = {
                    id: 'EXT' + state.transactionCounter.toString().padStart(4, '0'),
                    patientId: patientId,
                    patientName: fullName,
                    service: `Service externe: ${serviceName}`,
                    amount: servicePrice,
                    status: 'unpaid',
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                    createdBy: state.currentUser.username,
                    type: 'external',
                    notificationSent: false
                };
                
                state.transactionCounter++;
                state.transactions.push(externalTransaction);
                sendNotificationToCashier(externalTransaction);
            }
        });
        
        if (!hasServices) {
            alert("Veuillez sélectionner au moins un service externe!");
            return;
        }
    } else if (consultationTypeId) {
        let consultationType = state.consultationTypes.find(ct => ct.id === consultationTypeId);
        
        if (state.currentModifiedConsultation) {
            consultationType = { ...consultationType, ...state.currentModifiedConsultation };
        }
        
        const consultationTransaction = {
            id: 'TR' + state.transactionCounter.toString().padStart(4, '0'),
            patientId: patientId,
            patientName: fullName,
            service: `Consultation: ${consultationType.name}`,
            amount: consultationType.price,
            status: 'unpaid',
            date: new Date().toISOString().split('T')[0],
            time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
            createdBy: state.currentUser.username,
            type: 'consultation',
            notificationSent: false,
            originalTypeId: consultationTypeId,
            modifiedName: state.currentModifiedConsultation ? state.currentModifiedConsultation.name : null,
            modifiedPrice: state.currentModifiedConsultation ? state.currentModifiedConsultation.price : null
        };
        
        state.transactionCounter++;
        state.transactions.push(consultationTransaction);
        
        sendNotificationToCashier(consultationTransaction);
    }
    
    alert(`Patient enregistré avec succès! ID: ${patientId}`);
    
    e.target.reset();
    document.getElementById('patient-normal').checked = true;
    document.getElementById('external-only').checked = false;
    document.getElementById('consultation-type-container').classList.remove('hidden');
    document.getElementById('external-services-selection').classList.add('hidden');
    state.currentModifiedConsultation = null;
    document.getElementById('consultation-modification-secretary').classList.add('hidden');
    document.getElementById('modify-consultation-type-btn').classList.add('hidden');
    
    updateTodayPatientsList();
    
    document.getElementById('generate-patient-id-card').dataset.patientId = patientId;
    document.getElementById('generate-medical-certificate').dataset.patientId = patientId;
});

function setupMedicalCertificate() {
    document.getElementById('generate-medical-certificate').addEventListener('click', function() {
        const patientId = this.dataset.patientId;
        const patient = state.patients.find(p => p.id === patientId);
        
        if (!patient) {
            alert("Patient non trouvé!");
            return;
        }
        
        const consultation = state.consultations.find(c => c.patientId === patientId);
        
        document.getElementById('certificate-hospital-name').textContent = document.getElementById('hospital-name').value;
        document.getElementById('certificate-hospital-name-text').textContent = document.getElementById('hospital-name').value;
        document.getElementById('certificate-hospital-address').textContent = document.getElementById('hospital-address').value;
        document.getElementById('certificate-hospital-phone').textContent = document.getElementById('hospital-phone').value;
        
        if (state.hospitalLogo) {
            document.getElementById('certificate-logo').src = state.hospitalLogo;
            document.getElementById('certificate-logo').style.display = 'block';
        }
        
        document.getElementById('certificate-patient-name').textContent = patient.fullName;
        document.getElementById('certificate-patient-dob').textContent = patient.birthDate;
        document.getElementById('certificate-patient-address').textContent = patient.address;
        
        if (consultation) {
            document.getElementById('certificate-consultation-date').textContent = consultation.date;
            document.getElementById('certificate-diagnosis').textContent = consultation.diagnosis;
            document.getElementById('certificate-doctor').textContent = consultation.doctor;
        } else {
            document.getElementById('certificate-consultation-date').textContent = new Date().toISOString().split('T')[0];
            document.getElementById('certificate-diagnosis').textContent = "Aucun diagnostic enregistré.";
            document.getElementById('certificate-doctor').textContent = "Médecin";
        }
        
        const now = new Date();
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        document.getElementById('certificate-date').textContent = now.toLocaleDateString('fr-FR', options);
        
        document.getElementById('certificate-number').textContent = 'CM-' + Date.now().toString().slice(-6);
        
        const container = document.getElementById('medical-certificate-container');
        container.classList.remove('hidden');
        
        setTimeout(() => {
            window.print();
            container.classList.add('hidden');
        }, 500);
    });
}

function setupAppointments() {
    document.getElementById('search-appointment-patient').addEventListener('click', searchAppointmentPatient);
    document.getElementById('schedule-appointment').addEventListener('click', scheduleAppointment);
    document.getElementById('search-doctor-appointment').addEventListener('click', searchDoctorAppointment);
}

function searchAppointmentPatient() {
    const patientId = document.getElementById('appointment-patient-search').value.trim();
    const patient = state.patients.find(p => p.id === patientId);
    if (!patient) {
        alert("Patient non trouvé!");
        return;
    }
    document.getElementById('appointment-patient-name').textContent = patient.fullName + ' (' + patient.id + ')';
    document.getElementById('appointment-patient-details').classList.remove('hidden');
}

function loadDoctorsForAppointments() {
    const select = document.getElementById('appointment-doctor');
    select.innerHTML = '<option value="">Sélectionner un médecin</option>';
    state.users.forEach(user => {
        if (user.role === 'doctor' && user.active) {
            select.innerHTML += `<option value="${user.username}">${user.name}</option>`;
        }
    });
}

function scheduleAppointment() {
    const patientId = document.getElementById('appointment-patient-search').value.trim();
    const patient = state.patients.find(p => p.id === patientId);
    if (!patient) {
        alert("Patient non trouvé!");
        return;
    }
    const date = document.getElementById('appointment-date').value;
    const time = document.getElementById('appointment-time').value;
    const reason = document.getElementById('appointment-reason').value;
    const doctor = document.getElementById('appointment-doctor').value;

    if (!date || !time) {
        alert("Veuillez remplir la date et l'heure!");
        return;
    }

    const appointment = {
        id: 'APP' + Date.now(),
        patientId: patient.id,
        patientName: patient.fullName,
        date: date,
        time: time,
        reason: reason,
        doctor: doctor,
        createdBy: state.currentUser.username,
        status: 'scheduled'
    };

    state.appointments.push(appointment);
    alert("Rendez-vous programmé avec succès!");
    loadAppointmentsList();
}

function loadAppointmentsList() {
    const container = document.getElementById('appointments-list');
    const today = new Date().toISOString().split('T')[0];
    const upcoming = state.appointments.filter(a => a.date >= today).sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));
    if (upcoming.length === 0) {
        container.innerHTML = '<p>Aucun rendez-vous à venir.</p>';
        return;
    }
    let html = '<table class="table-container"><thead><tr><th>Patient</th><th>Date</th><th>Heure</th><th>Motif</th><th>Médecin</th><th>Statut</th></tr></thead><tbody>';
    upcoming.forEach(app => {
        html += `<tr><td>${app.patientName}</td><td>${app.date}</td><td>${app.time}</td><td>${app.reason}</td><td>${app.doctor}</td><td>${app.status}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
}

function searchDoctorAppointment() {
    const patientId = document.getElementById('doctor-appointment-search').value.trim();
    const patient = state.patients.find(p => p.id === patientId);
    if (!patient) {
        alert("Patient non trouvé!");
        return;
    }
    
    const patientAppointments = state.appointments.filter(a => a.patientId === patientId);
    const container = document.getElementById('doctor-appointment-results');
    
    if (patientAppointments.length === 0) {
        container.innerHTML = '<p>Aucun rendez-vous trouvé pour ce patient.</p>';
        return;
    }
    
    let html = '<h4>Rendez-vous du patient</h4>';
    html += '<table class="table-container"><thead><tr><th>Date</th><th>Heure</th><th>Motif</th><th>Statut</th></tr></thead><tbody>';
    patientAppointments.forEach(app => {
        html += `<tr><td>${app.date}</td><td>${app.time}</td><td>${app.reason}</td><td>${app.status}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
}

function loadDoctorAppointments() {
    const container = document.getElementById('doctor-appointment-results');
    const today = new Date().toISOString().split('T')[0];
    const doctorAppointments = state.appointments.filter(a => 
        a.doctor === state.currentUser.username && 
        a.date >= today
    ).sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));
    
    if (doctorAppointments.length === 0) {
        container.innerHTML = '<p>Aucun rendez-vous programmé.</p>';
        return;
    }
    
    let html = '<h4>Vos rendez-vous</h4>';
    html += '<table class="table-container"><thead><tr><th>Patient</th><th>Date</th><th>Heure</th><th>Motif</th></tr></thead><tbody>';
    doctorAppointments.forEach(app => {
        html += `<tr><td>${app.patientName} (${app.patientId})</td><td>${app.date}</td><td>${app.time}</td><td>${app.reason}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
}

function setupAdminSearch() {
    document.getElementById('search-admin-patient').addEventListener('click', searchAdminPatient);
    document.getElementById('save-privilege').addEventListener('click', savePrivilege);
    document.getElementById('privilege-type').addEventListener('change', function() {
        const discountSection = document.getElementById('discount-section');
        if (this.value === 'sponsored') {
            discountSection.classList.remove('hidden');
        } else {
            discountSection.classList.add('hidden');
        }
    });
}

function searchAdminPatient() {
    const patientId = document.getElementById('admin-patient-search').value.trim();
    const patient = state.patients.find(p => p.id === patientId);
    
    if (!patient) {
        alert("Patient non trouvé!");
        document.getElementById('admin-patient-details').classList.add('hidden');
        return;
    }
    
    document.getElementById('admin-patient-name').textContent = patient.fullName + ' (' + patient.id + ')';
    document.getElementById('admin-patient-details').classList.remove('hidden');
    
    const privilegeSelect = document.getElementById('privilege-type');
    const discountSection = document.getElementById('discount-section');
    const discountInput = document.getElementById('discount-percentage');
    
    if (patient.vip) {
        privilegeSelect.value = 'vip';
        discountSection.classList.add('hidden');
    } else if (patient.sponsored) {
        privilegeSelect.value = 'sponsored';
        discountSection.classList.remove('hidden');
        discountInput.value = patient.discountPercentage;
    } else {
        privilegeSelect.value = 'none';
        discountSection.classList.add('hidden');
    }
    
    const history = state.transactions.filter(t => t.patientId === patient.id);
    let html = '<table class="table-container"><thead><tr><th>Date</th><th>Service</th><th>Montant</th><th>Statut</th><th>Type</th></tr></thead><tbody>';
    if (history.length === 0) {
        html += '<tr><td colspan="5" class="text-center">Aucune transaction</td></tr>';
    } else {
        history.forEach(t => {
            html += `<tr><td>${t.date}</td><td>${t.service}</td><td>${t.amount} Gdes</td><td>${t.status}</td><td>${t.type}</td></tr>`;
        });
    }
    html += '</tbody></table>';
    document.getElementById('admin-patient-history').innerHTML = html;
}

function savePrivilege() {
    const patientId = document.getElementById('admin-patient-search').value.trim();
    const patient = state.patients.find(p => p.id === patientId);
    if (!patient) return;
    
    const privilegeType = document.getElementById('privilege-type').value;
    const discountPercentage = parseInt(document.getElementById('discount-percentage').value) || 0;
    
    patient.vip = false;
    patient.sponsored = false;
    patient.discountPercentage = 0;
    
    if (privilegeType === 'vip') {
        patient.vip = true;
        state.transactions.forEach(t => {
            if (t.patientId === patientId && t.status === 'unpaid') {
                t.status = 'paid';
                t.paymentMethod = 'vip';
                t.paymentDate = new Date().toISOString().split('T')[0];
                t.paymentTime = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                t.paymentAgent = state.currentUser.username;
            }
        });
        alert("Patient marqué comme VIP (services gratuits)");
    } else if (privilegeType === 'sponsored') {
        patient.sponsored = true;
        patient.discountPercentage = discountPercentage;
        alert(`Patient marqué comme sponsorisé avec ${discountPercentage}% de réduction`);
    } else {
        alert("Privilèges retirés du patient");
    }
    
    searchAdminPatient();
}

document.getElementById('modify-consultation-type-btn').addEventListener('click', () => {
    const consultationTypeId = parseInt(document.getElementById('consultation-type-secretary').value);
    if (!consultationTypeId) {
        alert("Veuillez d'abord sélectionner un type de consultation!");
        return;
    }
    
    const consultationType = state.consultationTypes.find(ct => ct.id === consultationTypeId);
    document.getElementById('modified-consultation-name').value = consultationType.name;
    document.getElementById('modified-consultation-price').value = consultationType.price;
    document.getElementById('consultation-modification-secretary').classList.remove('hidden');
});

document.getElementById('save-modified-consultation').addEventListener('click', () => {
    const consultationTypeId = parseInt(document.getElementById('consultation-type-secretary').value);
    const modifiedName = document.getElementById('modified-consultation-name').value;
    const modifiedPrice = parseFloat(document.getElementById('modified-consultation-price').value);
    
    if (!modifiedName || isNaN(modifiedPrice)) {
        alert("Veuillez remplir tous les champs correctement!");
        return;
    }
    
    state.currentModifiedConsultation = {
        name: modifiedName,
        price: modifiedPrice
    };
    
    document.getElementById('consultation-modification-secretary').classList.add('hidden');
    alert("Modification enregistrée! Cette modification s'appliquera uniquement au patient en cours.");
});

document.getElementById('cancel-consultation-modification').addEventListener('click', () => {
    state.currentModifiedConsultation = null;
    document.getElementById('consultation-modification-secretary').classList.add('hidden');
});

document.getElementById('consultation-type-secretary').addEventListener('change', function() {
    if (this.value) {
        document.getElementById('modify-consultation-type-btn').classList.remove('hidden');
    } else {
        document.getElementById('modify-consultation-type-btn').classList.add('hidden');
    }
});

function sendNotificationToCashier(transaction) {
    const cashiers = state.users.filter(u => u.role === 'cashier' && u.active);
    cashiers.forEach(cashier => {
        const message = {
            id: 'MSG' + Date.now(),
            sender: state.currentUser.username,
            senderRole: state.currentRole,
            recipient: cashier.username,
            recipientRole: cashier.role,
            subject: 'Nouvelle transaction',
            content: `Nouvelle transaction créée pour le patient ${transaction.patientName}: ${transaction.service} - ${transaction.amount} Gdes`,
            timestamp: new Date().toISOString(),
            read: false,
            type: 'transaction_notification'
        };
        state.messages.push(message);
    });
    updateMessageBadge();
}

function sendPaymentNotification(transaction) {
    const roles = ['admin', 'secretary', 'doctor', 'nurse', 'lab', 'pharmacy'];
    roles.forEach(role => {
        const users = state.users.filter(u => u.role === role && u.active && u.username !== state.currentUser.username);
        users.forEach(user => {
            const message = {
                id: 'MSG' + Date.now(),
                sender: state.currentUser.username,
                senderRole: state.currentRole,
                recipient: user.username,
                recipientRole: user.role,
                subject: 'Paiement effectué',
                content: `Paiement effectué pour le patient ${transaction.patientName}: ${transaction.service} - ${transaction.amount} Gdes`,
                timestamp: new Date().toISOString(),
                read: false,
                type: 'payment_notification'
            };
            state.messages.push(message);
        });
    });
    updateMessageBadge();
}

document.getElementById('generate-patient-id-card').addEventListener('click', function() {
    const patientId = this.dataset.patientId;
    const patient = state.patients.find(p => p.id === patientId);
    
    if (!patient) {
        alert("Patient non trouvé!");
        return;
    }
    
    document.getElementById('card-hospital-name').textContent = document.getElementById('hospital-name').value;
    document.getElementById('card-hospital-address').textContent = document.getElementById('hospital-address').value;
    
    if (state.hospitalLogo) {
        document.getElementById('card-logo').src = state.hospitalLogo;
        document.getElementById('card-logo').style.display = 'block';
    }
    
    document.getElementById('card-patient-name').textContent = patient.fullName;
    document.getElementById('card-patient-id').textContent = patient.id;
    document.getElementById('card-patient-dob').textContent = patient.birthDate;
    document.getElementById('card-patient-phone').textContent = patient.phone;
    document.getElementById('card-issue-date').textContent = new Date().toLocaleDateString('fr-FR');
    
    const typeElement = document.getElementById('card-patient-type');
    if (patient.type === 'urgence') {
        typeElement.textContent = 'URGENCE';
        typeElement.className = 'emergency-patient-tag';
    } else if (patient.type === 'pediatrie') {
        typeElement.textContent = 'PÉDIATRIE';
        typeElement.className = 'pediatric-tag';
    } else if (patient.type === 'externe') {
        typeElement.textContent = 'EXTERNE';
        typeElement.className = 'external-patient-tag';
    } else {
        typeElement.textContent = 'STANDARD';
        typeElement.className = '';
    }
    
    if (patient.vip) {
        typeElement.textContent += ' VIP';
        typeElement.classList.add('vip-tag');
    } else if (patient.sponsored) {
        typeElement.textContent += ` SPONSORISÉ (${patient.discountPercentage}%)`;
        typeElement.classList.add('vip-tag');
    }
    
    const container = document.getElementById('patient-card-container');
    container.classList.remove('hidden');
    
    setTimeout(() => {
        window.print();
        container.classList.add('hidden');
    }, 500);
});

document.getElementById('search-external-patient').addEventListener('click', () => {
    const search = document.getElementById('external-service-search').value.toLowerCase();
    const patient = state.patients.find(p => 
        p.id.toLowerCase() === search || 
        p.fullName.toLowerCase().includes(search)
    );
    
    if (!patient) {
        alert("Patient non trouvé!");
        return;
    }
    
    document.getElementById('external-patient-name').textContent = patient.fullName + ' (' + patient.id + ')';
    document.getElementById('external-services-container').classList.remove('hidden');
    
    const externalServices = state.transactions.filter(t => 
        t.patientId === patient.id && 
        t.type === 'external'
    );
    
    let html = '';
    if (externalServices.length === 0) {
        html = '<p>Aucun service externe enregistré.</p>';
    } else {
        externalServices.forEach(service => {
            html += `
                <div class="service-item">
                    <div>${service.service}</div>
                    <div>${service.amount} Gdes</div>
                    <div><span class="${service.status === 'paid' ? 'status-paid' : 'status-unpaid'}">${service.status === 'paid' ? 'Payé' : 'Non payé'}</span></div>
                </div>
            `;
        });
    }
    document.getElementById('external-services-list').innerHTML = html;
});

function updateExternalServicesSelect() {
    const select = document.getElementById('external-service-select');
    select.innerHTML = '<option value="">Choisir un service</option>';
    state.externalServiceTypes.forEach(service => {
        if (service.active) {
            select.innerHTML += `<option value="${service.id}" data-price="${service.price}">${service.name} - ${service.price} Gdes</option>`;
        }
    });
}

document.getElementById('add-external-service').addEventListener('click', () => {
    const patientId = document.getElementById('external-patient-name').textContent.match(/\((.*?)\)/)[1];
    const serviceSelect = document.getElementById('external-service-select');
    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
    const serviceId = selectedOption.value;
    const price = parseFloat(selectedOption.dataset.price) || parseFloat(document.getElementById('new-external-service-price').value);
    
    if (!serviceId || isNaN(price)) {
        alert("Veuillez sélectionner un service et entrer un prix valide!");
        return;
    }
    
    const serviceType = state.externalServiceTypes.find(s => s.id == serviceId);
    const serviceName = serviceType ? serviceType.name : 'Service externe';
    
    const externalTransaction = {
        id: 'EXT' + state.transactionCounter.toString().padStart(4, '0'),
        patientId: patientId,
        patientName: state.patients.find(p => p.id === patientId).fullName,
        service: `Service externe: ${serviceName}`,
        amount: price,
        status: 'unpaid',
        date: new Date().toISOString().split('T')[0],
        time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
        createdBy: state.currentUser.username,
        type: 'external',
        notificationSent: false
    };
    
    state.transactionCounter++;
    state.transactions.push(externalTransaction);
    sendNotificationToCashier(externalTransaction);
    
    document.getElementById('search-external-patient').click();
    
    serviceSelect.selectedIndex = 0;
    document.getElementById('new-external-service-price').value = '';
});

let selectedServices = [];
let currentCashierPatient = null;

document.getElementById('search-cashier-patient').addEventListener('click', () => {
    const search = document.getElementById('cashier-patient-search').value.toLowerCase();
    const patient = state.patients.find(p => 
        p.id.toLowerCase() === search || 
        p.fullName.toLowerCase().includes(search)
    );
    
    if (!patient) {
        alert("Patient non trouvé!");
        return;
    }
    
    currentCashierPatient = patient;
    document.getElementById('cashier-patient-name').textContent = patient.fullName;
    document.getElementById('cashier-patient-id').textContent = patient.id;
    document.getElementById('cashier-patient-details').classList.remove('hidden');
    
    const unpaidTransactions = state.transactions.filter(t => 
        t.patientId === patient.id && 
        t.status === 'unpaid'
    );
    
    let html = '';
    let total = 0;
    selectedServices = [];
    
    unpaidTransactions.forEach(transaction => {
        let amount = transaction.amount;
        if (patient.sponsored && patient.discountPercentage > 0) {
            amount = amount * (1 - patient.discountPercentage / 100);
        }
        
        total += amount;
        selectedServices.push({...transaction, finalAmount: amount});
        
        html += `
            <div class="service-item">
                <div>
                    <input type="checkbox" class="service-checkbox" data-id="${transaction.id}" checked>
                    <strong>${transaction.service}</strong>
                    ${patient.sponsored && patient.discountPercentage > 0 ? 
                        `<br><small>Réduction ${patient.discountPercentage}% appliquée: ${transaction.amount} → ${amount.toFixed(2)} Gdes</small>` : ''}
                </div>
                <div>${amount.toFixed(2)} Gdes</div>
            </div>
        `;
    });
    
    if (unpaidTransactions.length === 0) {
        html = '<p>Aucun service à payer.</p>';
    }
    
    document.getElementById('services-to-pay-list').innerHTML = html;
    document.getElementById('total-to-pay').textContent = total.toFixed(2);
    
    document.querySelectorAll('.service-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const transactionId = this.dataset.id;
            if (this.checked) {
                const transaction = unpaidTransactions.find(t => t.id === transactionId);
                if (transaction) {
                    let amount = transaction.amount;
                    if (patient.sponsored && patient.discountPercentage > 0) {
                        amount = amount * (1 - patient.discountPercentage / 100);
                    }
                    selectedServices.push({...transaction, finalAmount: amount});
                }
            } else {
                selectedServices = selectedServices.filter(t => t.id !== transactionId);
            }
            
            const newTotal = selectedServices.reduce((sum, t) => sum + t.finalAmount, 0);
            document.getElementById('total-to-pay').textContent = newTotal.toFixed(2);
            document.getElementById('amount-given').value = '';
            document.getElementById('change-result').textContent = 'Monnaie: 0 Gdes';
        });
    });
    
    updateExternalMedications(patient.id);
});

document.getElementById('amount-given').addEventListener('input', function() {
    const total = parseFloat(document.getElementById('total-to-pay').textContent);
    const given = parseFloat(this.value);
    
    if (isNaN(given)) {
        document.getElementById('change-result').textContent = 'Monnaie: 0 Gdes';
        return;
    }
    
    if (given < total) {
        document.getElementById('change-result').textContent = `Manquant: ${(total - given).toFixed(2)} Gdes`;
        document.getElementById('change-result').style.color = '#dc3545';
        return;
    }
    
    const change = given - total;
    document.getElementById('change-result').textContent = `Monnaie: ${change.toFixed(2)} Gdes`;
    document.getElementById('change-result').style.color = '#28a745';
});

document.querySelectorAll('.payment-method').forEach(method => {
    method.addEventListener('click', function() {
        document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
        this.classList.add('active');
    });
});

document.getElementById('mark-as-paid').addEventListener('click', () => {
    if (selectedServices.length === 0) {
        alert("Aucun service sélectionné!");
        return;
    }
    
    const given = parseFloat(document.getElementById('amount-given').value);
    const total = parseFloat(document.getElementById('total-to-pay').textContent);
    
    if (isNaN(given) || given < total) {
        alert("Veuillez entrer un montant valide et suffisant!");
        return;
    }
    
    const paymentMethod = document.querySelector('.payment-method.active').dataset.method;
    
    selectedServices.forEach(transaction => {
        const transactionIndex = state.transactions.findIndex(t => t.id === transaction.id);
        if (transactionIndex !== -1) {
            state.transactions[transactionIndex].status = 'paid';
            state.transactions[transactionIndex].paymentMethod = paymentMethod;
            state.transactions[transactionIndex].paymentDate = new Date().toISOString().split('T')[0];
            state.transactions[transactionIndex].paymentTime = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            state.transactions[transactionIndex].paymentAgent = state.currentUser.username;
            
            if (currentCashierPatient.sponsored && currentCashierPatient.discountPercentage > 0) {
                state.transactions[transactionIndex].finalAmount = state.transactions[transactionIndex].amount * (1 - currentCashierPatient.discountPercentage / 100);
            }
            
            sendPaymentNotification(state.transactions[transactionIndex]);
        }
    });
    
    alert("Paiement enregistré avec succès!");
    
    document.getElementById('search-cashier-patient').click();
    
    generateInvoice();
});

document.getElementById('search-nurse-patient').addEventListener('click', () => {
    const search = document.getElementById('nurse-patient-search').value.toLowerCase();
    const patient = state.patients.find(p => 
        p.id.toLowerCase() === search || 
        p.fullName.toLowerCase().includes(search)
    );
    
    if (!patient) {
        alert("Patient non trouvé!");
        return;
    }
    
    document.getElementById('nurse-patient-name').textContent = patient.fullName;
    document.getElementById('nurse-patient-id').textContent = patient.id;
    
    const unpaidCount = state.transactions.filter(t => 
        t.patientId === patient.id && 
        t.status === 'unpaid'
    ).length;
    
    const paymentStatus = unpaidCount > 0 ? 'Non payé' : 'Payé';
    const statusClass = unpaidCount > 0 ? 'status-unpaid' : 'status-paid';
    
    document.getElementById('nurse-payment-status').textContent = paymentStatus;
    document.getElementById('nurse-payment-status').className = `patient-status-badge ${statusClass}`;
    
    document.getElementById('nurse-patient-details').classList.remove('hidden');
    
    updateVitalsHistory(patient.id);
});

function updateVitalsInputs() {
    const container = document.getElementById('vitals-inputs-container');
    let html = '';
    
    state.vitalTypes.forEach(vital => {
        if (vital.active) {
            html += `
                <div class="vital-item">
                    <label class="form-label">${vital.name} (${vital.unit})</label>
                    <input type="text" class="form-control vital-input" data-id="${vital.id}" 
                           placeholder="Valeur">
                    <small class="text-muted">Valeurs normales: ${vital.min} - ${vital.max} ${vital.unit}</small>
                </div>
            `;
        }
    });
    
    container.innerHTML = html;
}

document.getElementById('vitals-form').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const patientId = document.getElementById('nurse-patient-id').textContent;
    const inputs = document.querySelectorAll('.vital-input');
    const vitalsRecord = {
        patientId: patientId,
        date: new Date().toISOString().split('T')[0],
        time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
        takenBy: state.currentUser.username,
        values: {}
    };
    
    inputs.forEach(input => {
        const vitalId = parseInt(input.dataset.id);
        const vital = state.vitalTypes.find(v => v.id === vitalId);
        if (vital && input.value.trim()) {
            vitalsRecord.values[vital.name] = {
                value: input.value,
                unit: vital.unit,
                normalRange: `${vital.min} - ${vital.max}`
            };
        }
    });
    
    state.vitals.push(vitalsRecord);
    alert("Signes vitaux enregistrés avec succès!");
    updateVitalsHistory(patientId);
    e.target.reset();
});

function updateVitalsHistory(patientId) {
    const container = document.getElementById('vitals-history');
    const patientVitals = state.vitals.filter(v => v.patientId === patientId);
    
    if (patientVitals.length === 0) {
        container.innerHTML = '<p>Aucun signe vital enregistré pour ce patient.</p>';
        return;
    }
    
    let html = '<table class="table-container"><thead><tr><th>Date/Heure</th>';
    
    state.vitalTypes.forEach(vital => {
        if (vital.active) {
            html += `<th>${vital.name}</th>`;
        }
    });
    
    html += '<th>Infirmier</th></tr></thead><tbody>';
    
    patientVitals.forEach(record => {
        html += `<tr><td>${record.date} ${record.time}</td>`;
        
        state.vitalTypes.forEach(vital => {
            if (vital.active) {
                const value = record.values[vital.name];
                html += `<td>${value ? `${value.value} ${value.unit}` : '-'}</td>`;
            }
        });
        
        html += `<td>${record.takenBy}</td></tr>`;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

let currentDoctorPatient = null;

function updateDoctorConsultationTypes() {
    const select = document.getElementById('doctor-consultation-type');
    select.innerHTML = '<option value="">Sélectionner un type</option>';
    state.consultationTypes.forEach(type => {
        if (type.active) {
            select.innerHTML += `<option value="${type.id}" data-price="${type.price}">${type.name} - ${type.price} Gdes</option>`;
        }
    });
}

document.getElementById('search-doctor-patient').addEventListener('click', () => {
    const search = document.getElementById('doctor-patient-search').value.toLowerCase();
    const patient = state.patients.find(p => 
        p.id.toLowerCase() === search || 
        p.fullName.toLowerCase().includes(search)
    );
    
    if (!patient) {
        alert("Patient non trouvé!");
        return;
    }
    
    currentDoctorPatient = patient;
    
    const birthDate = new Date(patient.birthDate);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    
    document.getElementById('doctor-patient-name').textContent = patient.fullName;
    document.getElementById('doctor-patient-id').textContent = patient.id;
    document.getElementById('doctor-patient-age').textContent = age;
    document.getElementById('doctor-patient-phone').textContent = patient.phone;
    document.getElementById('doctor-patient-type').textContent = patient.type.charAt(0).toUpperCase() + patient.type.slice(1);
    
    const unpaidTransactions = state.transactions.filter(t => 
        t.patientId === patient.id && 
        t.status === 'unpaid'
    );
    const paidTransactions = state.transactions.filter(t => 
        t.patientId === patient.id && 
        t.status === 'paid'
    );
    
    let statusText, statusClass;
    if (unpaidTransactions.length === 0 && paidTransactions.length > 0) {
        statusText = 'Tout payé';
        statusClass = 'status-paid';
    } else if (paidTransactions.length > 0 && unpaidTransactions.length > 0) {
        statusText = 'Partiellement payé';
        statusClass = 'status-partial';
    } else {
        statusText = 'Non payé';
        statusClass = 'status-unpaid';
    }
    
    document.getElementById('doctor-payment-status').textContent = statusText;
    document.getElementById('doctor-payment-status').className = `patient-status-badge ${statusClass}`;
    
    document.getElementById('doctor-patient-details').classList.remove('hidden');
    
    const consultationTransaction = state.transactions.find(t => 
        t.patientId === patient.id && 
        t.type === 'consultation'
    );
    
    const consultationContainer = document.getElementById('current-consultation-info');
    if (consultationTransaction) {
        consultationContainer.innerHTML = `
            <p><strong>Type:</strong> ${consultationTransaction.service}</p>
            <p><strong>Prix:</strong> ${consultationTransaction.amount} Gdes</p>
            <p><strong>Statut paiement:</strong> <span class="${consultationTransaction.status === 'paid' ? 'status-paid' : 'status-unpaid'}">${consultationTransaction.status === 'paid' ? 'Payé' : 'Non payé'}</span></p>
        `;
        document.getElementById('consultation-modification-section').classList.remove('hidden');
    } else {
        consultationContainer.innerHTML = '<p>Aucune consultation enregistrée</p>';
        document.getElementById('consultation-modification-section').classList.add('hidden');
    }
    
    updateCurrentVitalsDisplay(patient.id);
    updateLabAnalysesSelect();
    updateDoctorLabResults(patient.id);
});

document.getElementById('update-consultation-type').addEventListener('click', function() {
    if (!currentDoctorPatient) {
        alert("Veuillez d'abord sélectionner un patient!");
        return;
    }
    
    const select = document.getElementById('doctor-consultation-type');
    const selectedOption = select.options[select.selectedIndex];
    const newTypeId = selectedOption.value;
    const newPrice = parseFloat(selectedOption.dataset.price);
    
    if (!newTypeId) {
        alert("Veuillez sélectionner un type de consultation!");
        return;
    }
    
    const consultationTransaction = state.transactions.find(t => 
        t.patientId === currentDoctorPatient.id && 
        t.type === 'consultation'
    );
    
    if (!consultationTransaction) {
        alert("Aucune consultation trouvée pour ce patient!");
        return;
    }
    
    const oldPrice = consultationTransaction.amount;
    const priceDifference = newPrice - oldPrice;
    
    if (priceDifference > 0) {
        const adjustmentTransaction = {
            id: 'ADJ' + state.transactionCounter.toString().padStart(4, '0'),
            patientId: currentDoctorPatient.id,
            patientName: currentDoctorPatient.fullName,
            service: `Ajustement consultation: ${selectedOption.text}`,
            amount: priceDifference,
            status: 'unpaid',
            date: new Date().toISOString().split('T')[0],
            time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
            createdBy: state.currentUser.username,
            type: 'adjustment',
            notificationSent: false
        };
        
        state.transactionCounter++;
        state.transactions.push(adjustmentTransaction);
        
        consultationTransaction.service = `Consultation: ${selectedOption.text.split(' - ')[0]}`;
        consultationTransaction.amount = newPrice;
        
        sendNotificationToCashier(adjustmentTransaction);
        alert(`Consultation modifiée! Une transaction d'ajustement de ${priceDifference} Gdes a été créée. Le patient doit retourner à la caisse.`);
    } else if (priceDifference < 0) {
        const creditTransaction = {
            id: 'CRED' + state.transactionCounter.toString().padStart(4, '0'),
            patientId: currentDoctorPatient.id,
            patientName: currentDoctorPatient.fullName,
            service: `Crédit consultation: ${selectedOption.text}`,
            amount: Math.abs(priceDifference),
            status: 'credit',
            date: new Date().toISOString().split('T')[0],
            time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
            createdBy: state.currentUser.username,
            type: 'credit',
            notificationSent: false
        };
        
        state.transactionCounter++;
        state.transactions.push(creditTransaction);
        
        consultationTransaction.service = `Consultation: ${selectedOption.text.split(' - ')[0]}`;
        consultationTransaction.amount = newPrice;
        
        alert(`Consultation modifiée! Un crédit de ${Math.abs(priceDifference)} Gdes a été créé pour le patient.`);
    } else {
        consultationTransaction.service = `Consultation: ${selectedOption.text.split(' - ')[0]}`;
        alert("Consultation modifiée (même prix).");
    }
    
    document.getElementById('search-doctor-patient').click();
});

function updateCurrentVitalsDisplay(patientId) {
    const container = document.getElementById('current-vitals-display');
    const patientVitals = state.vitals.filter(v => v.patientId === patientId);
    
    if (patientVitals.length === 0) {
        container.innerHTML = '<p>Aucun signe vital enregistré.</p>';
        return;
    }
    
    const latestVitals = patientVitals[patientVitals.length - 1];
    
    let html = '<div class="vitals-grid">';
    
    for (const [vitalName, data] of Object.entries(latestVitals.values)) {
        html += `
            <div class="vital-item">
                <strong>${vitalName}:</strong><br>
                ${data.value} ${data.unit}<br>
                <small>Normale: ${data.normalRange}</small>
            </div>
        `;
    }
    
    html += '</div>';
    html += `<p><small>Pris le ${latestVitals.date} à ${latestVitals.time} par ${latestVitals.takenBy}</small></p>`;
    
    container.innerHTML = html;
}

document.getElementById('edit-vitals-btn').addEventListener('click', () => {
    const patientId = document.getElementById('doctor-patient-id').textContent;
    const patientVitals = state.vitals.filter(v => v.patientId === patientId);
    
    if (patientVitals.length === 0) {
        alert("Aucun signe vital à modifier!");
        return;
    }
    
    const latestVitals = patientVitals[patientVitals.length - 1];
    const container = document.getElementById('vitals-modification-inputs');
    let html = '';
    
    state.vitalTypes.forEach(vital => {
        if (vital.active) {
            const currentValue = latestVitals.values[vital.name];
            html += `
                <div class="vital-item">
                    <label class="form-label">${vital.name} (${vital.unit})</label>
                    <input type="text" class="form-control vital-modification-input" data-id="${vital.id}" 
                           value="${currentValue ? currentValue.value : ''}" placeholder="Valeur">
                    <small class="text-muted">Valeurs normales: ${vital.min} - ${vital.max} ${vital.unit}</small>
                </div>
            `;
        }
    });
    
    container.innerHTML = html;
    document.getElementById('doctor-vitals-modification').classList.remove('hidden');
});

document.getElementById('vitals-modification-form').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const patientId = document.getElementById('doctor-patient-id').textContent;
    const patientVitals = state.vitals.filter(v => v.patientId === patientId);
    const latestVitals = patientVitals[patientVitals.length - 1];
    
    const inputs = document.querySelectorAll('.vital-modification-input');
    
    inputs.forEach(input => {
        const vitalId = parseInt(input.dataset.id);
        const vital = state.vitalTypes.find(v => v.id === vitalId);
        if (vital && input.value.trim()) {
            latestVitals.values[vital.name] = {
                value: input.value,
                unit: vital.unit,
                normalRange: `${vital.min} - ${vital.max}`,
                modifiedBy: state.currentUser.username,
                modificationDate: new Date().toISOString()
            };
        }
    });
    
    alert("Signes vitaux modifiés avec succès!");
    updateCurrentVitalsDisplay(patientId);
    document.getElementById('doctor-vitals-modification').classList.add('hidden');
});

document.getElementById('cancel-vitals-modification').addEventListener('click', () => {
    document.getElementById('doctor-vitals-modification').classList.add('hidden');
});

document.getElementById('modify-analyses-btn').addEventListener('click', () => {
    const panel = document.getElementById('lab-modification-panel');
    panel.classList.toggle('hidden');
    
    if (!panel.classList.contains('hidden')) {
        const checkboxes = document.querySelectorAll('#lab-analyses-selection input:checked');
        if (checkboxes.length > 0) {
            const firstChecked = checkboxes[0];
            const analysisId = parseInt(firstChecked.value);
            const analysis = state.labAnalysisTypes.find(a => a.id === analysisId);
            
            if (analysis) {
                document.getElementById('modified-analysis-name').value = analysis.name;
                document.getElementById('modified-analysis-price').value = analysis.price;
                state.currentModifiedAnalysis = { id: analysisId, name: analysis.name, price: analysis.price };
            }
        }
    }
});

document.getElementById('save-modified-analysis').addEventListener('click', () => {
    const modifiedName = document.getElementById('modified-analysis-name').value;
    const modifiedPrice = parseFloat(document.getElementById('modified-analysis-price').value);
    
    if (!modifiedName || isNaN(modifiedPrice)) {
        alert("Veuillez remplir tous les champs correctement!");
        return;
    }
    
    const checkboxes = document.querySelectorAll('#lab-analyses-selection input:checked');
    checkboxes.forEach(cb => {
        const analysisId = parseInt(cb.value);
        if (analysisId === state.currentModifiedAnalysis.id) {
            const label = cb.parentElement;
            label.innerHTML = `<input type="checkbox" value="${analysisId}" data-price="${modifiedPrice}" checked>
                               ${modifiedName} (${modifiedPrice} Gdes) <span class="text-warning"><i class="fas fa-edit"></i> Modifié</span>`;
        }
    });
    
    state.currentModifiedAnalysis.modifiedName = modifiedName;
    state.currentModifiedAnalysis.modifiedPrice = modifiedPrice;
    
    document.getElementById('lab-modification-panel').classList.add('hidden');
    alert("Analyse modifiée! Cette modification s'appliquera uniquement au patient en cours.");
});

document.getElementById('cancel-analysis-modification').addEventListener('click', () => {
    document.getElementById('lab-modification-panel').classList.add('hidden');
    state.currentModifiedAnalysis = null;
});

function updateLabAnalysesSelect() {
    const container = document.getElementById('lab-analyses-selection');
    
    const groupedAnalyses = {};
    state.labAnalysisTypes.forEach(analysis => {
        if (!analysis.active) return;
        
        const category = analysis.name.split(' ')[0];
        if (!groupedAnalyses[category]) {
            groupedAnalyses[category] = [];
        }
        groupedAnalyses[category].push(analysis);
    });
    
    let html = '';
    for (const [category, analyses] of Object.entries(groupedAnalyses)) {
        html += `<div class="analysis-group">`;
        html += `<h5>${category}</h5>`;
        analyses.forEach(analysis => {
            html += `
                <label style="display: block; margin-bottom: 5px;">
                    <input type="checkbox" value="${analysis.id}" data-price="${analysis.price}">
                    ${analysis.name} (${analysis.price} Gdes)
                </label>
            `;
        });
        html += `</div>`;
    }
    
    container.innerHTML = html;
}

document.getElementById('medication-search').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const suggestions = document.getElementById('medication-suggestions');
    
    if (searchTerm.length < 2) {
        suggestions.classList.add('hidden');
        return;
    }
    
    const matchingMeds = state.medicationStock.filter(med => 
        med.name.toLowerCase().includes(searchTerm) ||
        med.genericName.toLowerCase().includes(searchTerm)
    ).slice(0, 5);
    
    if (matchingMeds.length > 0) {
        let html = '';
        matchingMeds.forEach(med => {
            html += `
                <div class="suggestion-item" style="padding:5px 10px; cursor:pointer;" 
                     onclick="addMedicationToPrescription('${med.id}')">
                    ${med.name} (${med.form}) - Stock: ${med.quantity}
                </div>
            `;
        });
        suggestions.innerHTML = html;
        suggestions.classList.remove('hidden');
    } else {
        suggestions.classList.add('hidden');
    }
});

function addMedicationToPrescription(medId) {
    const med = state.medicationStock.find(m => m.id === medId);
    if (!med) return;
    
    const tableBody = document.getElementById('prescription-medications-list');
    
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${med.name}</td>
        <td><input type="text" class="form-control" placeholder="Ex: 1 comprimé matin et soir" value="1 comprimé 3x/jour"></td>
        <td><input type="number" class="form-control quantity-input" data-med-id="${med.id}" value="10" min="1" max="${med.quantity}"></td>
        <td>${med.quantity}</td>
        <td><button class="btn btn-danger btn-sm" onclick="removeMedicationFromPrescription(this)">Supprimer</button></td>
    `;
    
    tableBody.appendChild(row);
    
    document.getElementById('medication-suggestions').classList.add('hidden');
    document.getElementById('medication-search').value = '';
    
    checkStockWarnings();
}

function removeMedicationFromPrescription(button) {
    button.closest('tr').remove();
    checkStockWarnings();
}

function checkStockWarnings() {
    const warnings = document.getElementById('stock-warnings');
    const rows = document.querySelectorAll('#prescription-medications-list tr');
    
    let warningHtml = '';
    let hasWarning = false;
    
    rows.forEach(row => {
        const medId = row.querySelector('.quantity-input').dataset.medId;
        const quantity = parseInt(row.querySelector('.quantity-input').value);
        const med = state.medicationStock.find(m => m.id === medId);
        
        if (med) {
            if (quantity > med.quantity) {
                warningHtml += `<div class="alert alert-warning">${med.name}: Stock insuffisant (demandé: ${quantity}, disponible: ${med.quantity})</div>`;
                hasWarning = true;
            } else if (med.quantity <= med.alertThreshold) {
                warningHtml += `<div class="alert alert-info">${med.name}: Stock faible (${med.quantity} ${med.unit})</div>`;
            }
        }
    });
    
    warnings.innerHTML = warningHtml;
    document.getElementById('deliver-medications').disabled = hasWarning;
}

document.getElementById('consultation-form').addEventListener('submit', (e) => {
    e.preventDefault();
    
    if (!currentDoctorPatient) {
        alert("Veuillez d'abord sélectionner un patient!");
        return;
    }
    
    const diagnosis = document.getElementById('consultation-diagnosis').value;
    const followupDate = document.getElementById('followup-date').value;
    const followupTime = document.getElementById('followup-time').value;
    
    const consultation = {
        id: 'CONS' + Date.now(),
        patientId: currentDoctorPatient.id,
        patientName: currentDoctorPatient.fullName,
        doctor: state.currentUser.username,
        date: new Date().toISOString().split('T')[0],
        time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
        diagnosis: diagnosis,
        followupDate: followupDate,
        followupTime: followupTime,
        modified: false
    };
    
    state.consultations.push(consultation);
    
    const analysisCheckboxes = document.querySelectorAll('#lab-analyses-selection input:checked');
    analysisCheckboxes.forEach(cb => {
        const analysisId = parseInt(cb.value);
        let analysis = state.labAnalysisTypes.find(a => a.id === analysisId);
        
        if (state.currentModifiedAnalysis && state.currentModifiedAnalysis.id === analysisId) {
            analysis = { ...analysis, ...state.currentModifiedAnalysis };
        }
        
        if (analysis) {
            const analysisTransaction = {
                id: 'LAB' + Date.now(),
                patientId: currentDoctorPatient.id,
                patientName: currentDoctorPatient.fullName,
                service: `Analyse: ${analysis.modifiedName || analysis.name}`,
                amount: analysis.modifiedPrice || analysis.price,
                status: currentDoctorPatient.vip ? 'paid' : 'unpaid',
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                createdBy: state.currentUser.username,
                type: 'lab',
                analysisId: analysisId,
                result: null,
                labStatus: 'pending',
                notificationSent: false,
                originalTypeId: analysisId,
                modifiedName: analysis.modifiedName || null,
                modifiedPrice: analysis.modifiedPrice || null
            };
            
            if (currentDoctorPatient.vip) {
                analysisTransaction.paymentMethod = 'vip';
                analysisTransaction.paymentDate = new Date().toISOString().split('T')[0];
                analysisTransaction.paymentTime = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                analysisTransaction.paymentAgent = 'system';
            } else if (currentDoctorPatient.sponsored) {
                analysisTransaction.amount = analysisTransaction.amount * (1 - currentDoctorPatient.discountPercentage / 100);
            }
            
            state.transactions.push(analysisTransaction);
            if (!currentDoctorPatient.vip) {
                sendNotificationToCashier(analysisTransaction);
            }
        }
    });
    
    const medicationRows = document.querySelectorAll('#prescription-medications-list tr');
    medicationRows.forEach(row => {
        const medName = row.cells[0].textContent;
        const dosage = row.cells[1].querySelector('input').value;
        const quantity = parseInt(row.cells[2].querySelector('input').value);
        const medId = row.cells[2].querySelector('input').dataset.medId;
        
        const med = state.medicationStock.find(m => m.id === medId);
        
        const medTransaction = {
            id: 'MED' + Date.now(),
            patientId: currentDoctorPatient.id,
            patientName: currentDoctorPatient.fullName,
            service: `Médicament: ${medName} (${quantity} ${med.unit})`,
            amount: med.price * quantity,
            status: currentDoctorPatient.vip ? 'paid' : 'unpaid',
            date: new Date().toISOString().split('T')[0],
            time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
            createdBy: state.currentUser.username,
            type: 'medication',
            medicationId: medId,
            dosage: dosage,
            quantity: quantity,
            deliveryStatus: 'pending',
            notificationSent: false
        };
        
        if (currentDoctorPatient.vip) {
            medTransaction.paymentMethod = 'vip';
            medTransaction.paymentDate = new Date().toISOString().split('T')[0];
            medTransaction.paymentTime = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            medTransaction.paymentAgent = 'system';
        } else if (currentDoctorPatient.sponsored) {
            medTransaction.amount = medTransaction.amount * (1 - currentDoctorPatient.discountPercentage / 100);
        }
        
        state.transactions.push(medTransaction);
        if (!currentDoctorPatient.vip) {
            sendNotificationToCashier(medTransaction);
        }
        
        med.reserved = (med.reserved || 0) + quantity;
    });
    
    alert("Consultation enregistrée avec succès!");
    e.target.reset();
    
    document.getElementById('prescription-medications-list').innerHTML = '';
    document.getElementById('stock-warnings').innerHTML = '';
    state.currentModifiedAnalysis = null;
    document.getElementById('lab-modification-panel').classList.add('hidden');
});

document.getElementById('modify-consultation-btn').addEventListener('click', () => {
    if (!currentDoctorPatient) {
        alert("Veuillez d'abord sélectionner un patient!");
        return;
    }
    
    const patientConsultations = state.consultations.filter(c => c.patientId === currentDoctorPatient.id);
    if (patientConsultations.length === 0) {
        alert("Aucune consultation à modifier!");
        return;
    }
    
    const latestConsultation = patientConsultations[patientConsultations.length - 1];
    
    document.getElementById('consultation-diagnosis').value = latestConsultation.diagnosis;
    if (latestConsultation.followupDate) {
        document.getElementById('followup-date').value = latestConsultation.followupDate;
    }
    if (latestConsultation.followupTime) {
        document.getElementById('followup-time').value = latestConsultation.followupTime;
    }
    
    latestConsultation.modified = true;
    latestConsultation.modifiedBy = state.currentUser.username;
    latestConsultation.modificationDate = new Date().toISOString();
    
    alert("Consultation chargée pour modification. Modifiez les champs et enregistrez à nouveau.");
});

function updateDoctorLabResults(patientId) {
    const container = document.getElementById('doctor-lab-results');
    const labTransactions = state.transactions.filter(t => 
        t.patientId === patientId && 
        t.type === 'lab' &&
        t.labStatus === 'completed'
    );
    
    if (labTransactions.length === 0) {
        container.innerHTML = '<p>Aucun résultat d\'analyse disponible.</p>';
        return;
    }
    
    let html = '<div class="card">';
    labTransactions.forEach(transaction => {
        const analysisType = state.labAnalysisTypes.find(a => a.id === transaction.analysisId);
        const resultType = analysisType ? analysisType.resultType : 'text';
        
        html += `
            <div class="mb-3">
                <h5>${transaction.service}</h5>
                <p><strong>Date:</strong> ${transaction.date}</p>
                <p><strong>Résultat:</strong></p>
                ${resultType === 'text' ? 
                    `<pre style="background:#f8f9fa; padding:10px; border-radius:5px;">${transaction.result}</pre>` :
                    `<img src="${transaction.result}" alt="Résultat" style="max-width:300px; border:1px solid #ddd; border-radius:5px;">`
                }
                <hr>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

document.getElementById('search-lab-patient').addEventListener('click', () => {
    const search = document.getElementById('lab-patient-search').value.toLowerCase();
    const patient = state.patients.find(p => 
        p.id.toLowerCase() === search || 
        p.fullName.toLowerCase().includes(search)
    );
    
    if (!patient) {
        alert("Patient non trouvé!");
        return;
    }
    
    document.getElementById('lab-patient-name').textContent = patient.fullName;
    document.getElementById('lab-patient-id').textContent = patient.id;
    
    const labTransactions = state.transactions.filter(t => 
        t.patientId === patient.id && 
        t.type === 'lab'
    );
    
    const unpaidLab = labTransactions.filter(t => t.status === 'unpaid');
    const paidLab = labTransactions.filter(t => t.status === 'paid');
    
    let statusText, statusClass;
    if (unpaidLab.length === 0 && paidLab.length > 0) {
        statusText = 'Toutes payées';
        statusClass = 'status-paid';
    } else if (paidLab.length > 0 && unpaidLab.length > 0) {
        statusText = 'Partiellement payé';
        statusClass = 'status-partial';
    } else if (unpaidLab.length > 0) {
        statusText = 'Non payé';
        statusClass = 'status-unpaid';
    } else {
        statusText = 'Aucune analyse';
        statusClass = '';
    }
    
    document.getElementById('lab-payment-status').textContent = statusText;
    document.getElementById('lab-payment-status').className = `patient-status-badge ${statusClass}`;
    
    let html = '';
    labTransactions.forEach(transaction => {
        const analysisType = state.labAnalysisTypes.find(a => a.id === transaction.analysisId);
        const resultType = analysisType ? analysisType.resultType : 'text';
        
        html += `
            <div class="card mb-2">
                <div class="d-flex justify-between">
                    <div>
                        <h5>${transaction.service}</h5>
                        <p>Date: ${transaction.date} ${transaction.time}</p>
                        <p>Statut paiement: <span class="${transaction.status === 'paid' ? 'status-paid' : 'status-unpaid'}">${transaction.status === 'paid' ? 'Payé' : 'Non payé'}</span></p>
                        <p>Statut analyse: <span class="${transaction.labStatus === 'completed' ? 'status-paid' : 'status-unpaid'}">${transaction.labStatus || 'En attente'}</span></p>
                    </div>
                    <div>
                        ${transaction.status === 'paid' && transaction.labStatus !== 'completed' ? `
                            <button class="btn btn-success" onclick="enterLabResult('${transaction.id}')">
                                Saisir résultat
                            </button>
                        ` : ''}
                        ${transaction.result ? `
                            <button class="btn btn-info" onclick="viewLabResult('${transaction.id}')">
                                Voir résultat
                            </button>
                        ` : ''}
                    </div>
                </div>
                ${transaction.result ? `
                    <div class="mt-2">
                        <strong>Résultat:</strong><br>
                        ${resultType === 'image' ? 
                            `<img src="${transaction.result}" alt="Résultat" style="max-width: 200px;">` : 
                            `<pre>${transaction.result}</pre>`
                        }
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    document.getElementById('lab-analyses-list').innerHTML = html || '<p>Aucune analyse trouvée.</p>';
    document.getElementById('lab-patient-details').classList.remove('hidden');
    
    updatePendingAnalysesList();
});

function enterLabResult(transactionId) {
    const transaction = state.transactions.find(t => t.id === transactionId);
    if (!transaction) return;
    
    const analysisType = state.labAnalysisTypes.find(a => a.id === transaction.analysisId);
    const resultType = analysisType ? analysisType.resultType : 'text';
    
    const patient = state.patients.find(p => p.id === transaction.patientId);
    
    let formHtml = `
        <div class="card">
            <h4>Saisir résultat: ${transaction.service}</h4>
            <p>Patient: ${patient.fullName} (${patient.id})</p>
    `;
    
    if (resultType === 'text') {
        formHtml += `
            <textarea id="lab-result-text" class="form-control" rows="5" placeholder="Entrez le résultat..."></textarea>
            <div class="mt-2">
                <button class="btn btn-success" onclick="saveLabResult('${transactionId}', 'text')">Enregistrer</button>
                <button class="btn btn-secondary" onclick="document.getElementById('lab-result-modal').remove()">Annuler</button>
            </div>
        `;
    } else if (resultType === 'image') {
        formHtml += `
            <input type="file" id="lab-result-image" class="form-control" accept="image/*">
            <div class="mt-2">
                <button class="btn btn-success" onclick="saveLabResult('${transactionId}', 'image')">Enregistrer</button>
                <button class="btn btn-secondary" onclick="document.getElementById('lab-result-modal').remove()">Annuler</button>
            </div>
        `;
    }
    
    formHtml += '</div>';
    
    const modal = document.createElement('div');
    modal.id = 'lab-result-modal';
    modal.className = 'transaction-details-modal';
    modal.innerHTML = `<div class="transaction-details-content">${formHtml}</div>`;
    document.body.appendChild(modal);
    modal.classList.remove('hidden');
}

function saveLabResult(transactionId, type) {
    const transaction = state.transactions.find(t => t.id === transactionId);
    if (!transaction) return;
    
    if (type === 'text') {
        const result = document.getElementById('lab-result-text').value;
        if (!result.trim()) {
            alert("Veuillez entrer un résultat!");
            return;
        }
        transaction.result = result;
    } else if (type === 'image') {
        const fileInput = document.getElementById('lab-result-image');
        if (!fileInput.files[0]) {
            alert("Veuillez sélectionner une image!");
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            transaction.result = e.target.result;
            transaction.labStatus = 'completed';
            
            sendLabResultNotification(transaction);
            
            alert("Résultat enregistré avec succès!");
            document.getElementById('lab-result-modal').remove();
            document.getElementById('search-lab-patient').click();
        };
        reader.readAsDataURL(fileInput.files[0]);
        return;
    }
    
    transaction.labStatus = 'completed';
    
    sendLabResultNotification(transaction);
    
    alert("Résultat enregistré avec succès!");
    document.getElementById('lab-result-modal').remove();
    document.getElementById('search-lab-patient').click();
}

function sendLabResultNotification(transaction) {
    const doctors = state.users.filter(u => u.role === 'doctor' && u.active);
    doctors.forEach(doctor => {
        const message = {
            id: 'MSG' + Date.now(),
            sender: state.currentUser.username,
            senderRole: state.currentRole,
            recipient: doctor.username,
            recipientRole: doctor.role,
            subject: 'Résultat d\'analyse disponible',
            content: `Résultat disponible pour le patient ${transaction.patientName}: ${transaction.service}`,
            timestamp: new Date().toISOString(),
            read: false,
            type: 'lab_result'
        };
        state.messages.push(message);
    });
    updateMessageBadge();
}

function viewLabResult(transactionId) {
    const transaction = state.transactions.find(t => t.id === transactionId);
    if (!transaction || !transaction.result) return;
    
    const analysisType = state.labAnalysisTypes.find(a => a.id === transaction.analysisId);
    const resultType = analysisType ? analysisType.resultType : 'text';
    
    let html = `
        <div class="card">
            <h4>Résultat: ${transaction.service}</h4>
            <p>Patient: ${transaction.patientName}</p>
            <p>Date: ${transaction.date}</p>
            <hr>
    `;
    
    if (resultType === 'text') {
        html += `<pre>${transaction.result}</pre>`;
    } else {
        html += `<img src="${transaction.result}" alt="Résultat" style="max-width: 100%;">`;
    }
    
    html += '</div>';
    
    const modal = document.createElement('div');
    modal.className = 'transaction-details-modal';
    modal.innerHTML = `<div class="transaction-details-content">${html}
        <div class="mt-3"><button class="btn btn-secondary" onclick="this.closest('.transaction-details-modal').remove()">Fermer</button></div>
    </div>`;
    document.body.appendChild(modal);
    modal.classList.remove('hidden');
}

function updatePendingAnalysesList() {
    const pending = state.transactions.filter(t => 
        t.type === 'lab' && 
        t.status === 'paid' && 
        (!t.labStatus || t.labStatus !== 'completed')
    );
    
    const container = document.getElementById('pending-analyses-list');
    
    if (pending.length === 0) {
        container.innerHTML = '<p>Aucune analyse en attente de résultats.</p>';
        return;
    }
    
    let html = '<table class="table-container"><thead><tr><th>Patient</th><th>Analyse</th><th>Date</th><th>Statut</th><th>Action</th></tr></thead><tbody>';
    
    pending.forEach(transaction => {
        html += `
            <tr>
                <td>${transaction.patientName}</td>
                <td>${transaction.service}</td>
                <td>${transaction.date}</td>
                <td><span class="${transaction.labStatus === 'completed' ? 'status-paid' : 'status-unpaid'}">${transaction.labStatus || 'En attente'}</span></td>
                <td><button class="btn btn-sm btn-success" onclick="enterLabResult('${transaction.id}')">Saisir</button></td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

document.getElementById('search-pharmacy-patient').addEventListener('click', () => {
    const search = document.getElementById('pharmacy-patient-search').value.toLowerCase();
    const patient = state.patients.find(p => 
        p.id.toLowerCase() === search || 
        p.fullName.toLowerCase().includes(search)
    );
    
    if (!patient) {
        alert("Patient non trouvé!");
        return;
    }
    
    document.getElementById('pharmacy-patient-name').textContent = patient.fullName;
    document.getElementById('pharmacy-patient-id').textContent = patient.id;
    
    const medTransactions = state.transactions.filter(t => 
        t.patientId === patient.id && 
        t.type === 'medication'
    );
    
    const unpaidMeds = medTransactions.filter(t => t.status === 'unpaid');
    const paidMeds = medTransactions.filter(t => t.status === 'paid');
    
    let statusText, statusClass;
    if (unpaidMeds.length === 0 && paidMeds.length > 0) {
        statusText = 'Tout payé';
        statusClass = 'status-paid';
    } else if (paidMeds.length > 0 && unpaidMeds.length > 0) {
        statusText = 'Partiellement payé';
        statusClass = 'status-partial';
    } else if (unpaidMeds.length > 0) {
        statusText = 'Non payé';
        statusClass = 'status-unpaid';
    } else {
        statusText = 'Aucun médicament';
        statusClass = '';
    }
    
    document.getElementById('pharmacy-payment-status').textContent = statusText;
    document.getElementById('pharmacy-payment-status').className = `patient-status-badge ${statusClass}`;
    
    let html = '';
    medTransactions.forEach(transaction => {
        const med = state.medicationStock.find(m => m.id === transaction.medicationId);
        const canDeliver = transaction.status === 'paid' && 
                          (!transaction.deliveryStatus || transaction.deliveryStatus !== 'delivered');
        
        html += `
            <div class="card mb-2">
                <div class="d-flex justify-between">
                    <div>
                        <h5>${transaction.service}</h5>
                        <p>Posologie: ${transaction.dosage}</p>
                        <p>Statut paiement: <span class="${transaction.status === 'paid' ? 'status-paid' : 'status-unpaid'}">${transaction.status === 'paid' ? 'Payé' : 'Non payé'}</span></p>
                        <p>Livraison: <span class="${transaction.deliveryStatus === 'delivered' ? 'status-paid' : 'status-unpaid'}">${transaction.deliveryStatus || 'En attente'}</span></p>
                    </div>
                    <div>
                        ${canDeliver ? `
                            <button class="btn btn-success" onclick="deliverMedication('${transaction.id}')">
                                Délivrer
                            </button>
                        ` : ''}
                        ${transaction.deliveryStatus === 'delivered' ? `
                            <span class="text-success"><i class="fas fa-check"></i> Déjà délivré</span>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('pharmacy-prescriptions-list').innerHTML = html || '<p>Aucun médicament prescrit.</p>';
    document.getElementById('pharmacy-patient-details').classList.remove('hidden');
    
    const hasDeliverable = medTransactions.some(t => 
        t.status === 'paid' && 
        (!t.deliveryStatus || t.deliveryStatus !== 'delivered')
    );
    document.getElementById('deliver-medications').disabled = !hasDeliverable;
});

function deliverMedication(transactionId) {
    const transaction = state.transactions.find(t => t.id === transactionId);
    if (!transaction) return;
    
    const med = state.medicationStock.find(m => m.id === transaction.medicationId);
    if (!med) return;
    
    if (med.quantity < transaction.quantity) {
        alert(`Stock insuffisant! Disponible: ${med.quantity}, Demandé: ${transaction.quantity}`);
        return;
    }
    
    med.quantity -= transaction.quantity;
    med.reserved = (med.reserved || 0) - transaction.quantity;
    
    transaction.deliveryStatus = 'delivered';
    transaction.deliveryDate = new Date().toISOString().split('T')[0];
    transaction.deliveryTime = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    transaction.deliveredBy = state.currentUser.username;
    
    alert("Médicament délivré avec succès!");
    document.getElementById('search-pharmacy-patient').click();
    updateMedicationStock();
}

function setupPharmacy() {
    document.getElementById('add-new-medication').addEventListener('click', () => {
        document.getElementById('new-medication-form').style.display = 'block';
    });
    
    document.getElementById('cancel-new-medication').addEventListener('click', () => {
        document.getElementById('new-medication-form').style.display = 'none';
        resetNewMedicationForm();
    });
    
    document.getElementById('save-new-medication').addEventListener('click', addNewMedication);
}

function resetNewMedicationForm() {
    document.getElementById('new-med-name').value = '';
    document.getElementById('new-med-generic').value = '';
    document.getElementById('new-med-form').value = '';
    document.getElementById('new-med-unit').value = '';
    document.getElementById('new-med-quantity').value = '';
    document.getElementById('new-med-alert').value = '';
    document.getElementById('new-med-price').value = '';
}

function addNewMedication() {
    const name = document.getElementById('new-med-name').value.trim();
    const genericName = document.getElementById('new-med-generic').value.trim();
    const form = document.getElementById('new-med-form').value;
    const unit = document.getElementById('new-med-unit').value.trim();
    const quantity = parseInt(document.getElementById('new-med-quantity').value);
    const alertThreshold = parseInt(document.getElementById('new-med-alert').value);
    const price = parseFloat(document.getElementById('new-med-price').value);
    
    if (!name || !form || !unit || isNaN(quantity) || isNaN(alertThreshold) || isNaN(price)) {
        alert("Veuillez remplir tous les champs correctement!");
        return;
    }
    
    const newMed = {
        id: 'MED' + Date.now(),
        name: name,
        genericName: genericName,
        form: form,
        quantity: quantity,
        unit: unit,
        alertThreshold: alertThreshold,
        price: price,
        reserved: 0
    };
    
    state.medicationStock.push(newMed);
    
    document.getElementById('new-medication-form').style.display = 'none';
    resetNewMedicationForm();
    
    updateMedicationStock();
    alert("Médicament ajouté avec succès!");
}

function updateMedicationStock() {
    const container = document.getElementById('medication-stock-list');
    let html = '';
    
    state.medicationStock.forEach(med => {
        const statusClass = med.quantity === 0 ? 'out-of-stock' : 
                          (med.quantity <= med.alertThreshold ? 'low-stock' : '');
        
        html += `
            <tr class="${statusClass}">
                <td>${med.name}<br><small>${med.genericName}</small></td>
                <td>${med.form}</td>
                <td>${med.quantity} ${med.unit}</td>
                <td>${med.alertThreshold}</td>
                <td>${med.price} Gdes</td>
                <td>
                    ${med.quantity === 0 ? 'Rupture' : 
                     med.quantity <= med.alertThreshold ? 'Stock faible' : 'Normal'}
                </td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="restockMedication('${med.id}')">
                        Réapprovisionner
                    </button>
                </td>
            </tr>
        `;
    });
    
    container.innerHTML = html;
    
    updateLowStockMedications();
}

function updateLowStockMedications() {
    const lowStock = state.medicationStock.filter(med => 
        med.quantity <= med.alertThreshold
    );
    
    const container = document.getElementById('low-stock-medications');
    
    if (lowStock.length === 0) {
        container.innerHTML = '<p>Aucun médicament en rupture ou stock faible.</p>';
        return;
    }
    
    let html = '<table class="table-container"><thead><tr><th>Médicament</th><th>Stock actuel</th><th>Seuil d\'alerte</th><th>Statut</th></tr></thead><tbody>';
    
    lowStock.forEach(med => {
        html += `
            <tr class="${med.quantity === 0 ? 'out-of-stock' : 'low-stock'}">
                <td>${med.name}</td>
                <td>${med.quantity} ${med.unit}</td>
                <td>${med.alertThreshold}</td>
                <td>${med.quantity === 0 ? 'RUPTURE' : 'Stock faible'}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function restockMedication(medId) {
    if (state.currentRole !== 'admin' && state.currentRole !== 'pharmacy') {
        alert("Seul l'administrateur ou le pharmacien peut modifier le stock!");
        return;
    }
    
    const med = state.medicationStock.find(m => m.id === medId);
    if (!med) return;
    
    const quantity = prompt(`Quantité à ajouter pour ${med.name} (en ${med.unit}):`, "100");
    if (quantity && !isNaN(quantity) && parseInt(quantity) > 0) {
        med.quantity += parseInt(quantity);
        updateMedicationStock();
        alert(`Stock mis à jour! Nouvelle quantité: ${med.quantity} ${med.unit}`);
    }
}

function setupMessaging() {
    updateMessageRecipients();
}

function updateMessageRecipients() {
    const select = document.getElementById('message-recipient');
    select.innerHTML = '<option value="">Nouveau message...</option><option value="all">Tous les utilisateurs</option><option value="all-doctors">Tous les médecins</option><option value="all-nurses">Tous les infirmiers</option><option value="all-secretaries">Tous les secrétaires</option><option value="all-cashiers">Tous les caissiers</option><option value="all-labs">Tout le laboratoire</option><option value="all-pharmacies">Toute la pharmacie</option><option value="all-admins">Tous les administrateurs</option>';
    
    state.users.forEach(user => {
        if (user.active && user.username !== state.currentUser.username) {
            select.innerHTML += `<option value="${user.username}">${user.name} (${user.role})</option>`;
        }
    });
}

function loadConversations() {
    const container = document.getElementById('conversations-container');
    const userMessages = state.messages.filter(m => 
        m.recipient === state.currentUser.username || 
        m.sender === state.currentUser.username
    );
    
    const conversations = {};
    userMessages.forEach(message => {
        const otherUser = message.sender === state.currentUser.username ? message.recipient : message.sender;
        if (!conversations[otherUser]) {
            conversations[otherUser] = {
                user: otherUser,
                lastMessage: message,
                unread: message.recipient === state.currentUser.username && !message.read
            };
        } else {
            if (new Date(message.timestamp) > new Date(conversations[otherUser].lastMessage.timestamp)) {
                conversations[otherUser].lastMessage = message;
            }
            if (message.recipient === state.currentUser.username && !message.read) {
                conversations[otherUser].unread = true;
            }
        }
    });
    
    let html = '';
    Object.values(conversations).forEach(conv => {
        const otherUser = state.users.find(u => u.username === conv.user);
        const displayName = otherUser ? otherUser.name : conv.user;
        
        html += `
            <div class="conversation-item ${conv.unread ? 'unread' : ''} ${state.currentConversation === conv.user ? 'active' : ''}" 
                 onclick="loadConversation('${conv.user}')">
                <div class="d-flex align-items-center">
                    <div class="conversation-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="conversation-info">
                        <div class="d-flex justify-between">
                            <strong>${displayName}</strong>
                            <span class="conversation-time">${new Date(conv.lastMessage.timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="conversation-last-message">${conv.lastMessage.content.substring(0, 50)}${conv.lastMessage.content.length > 50 ? '...' : ''}</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html || '<p>Aucune conversation</p>';
}

function loadConversation(otherUser) {
    state.currentConversation = otherUser;
    const messages = state.messages.filter(m => 
        (m.sender === state.currentUser.username && m.recipient === otherUser) ||
        (m.sender === otherUser && m.recipient === state.currentUser.username)
    ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    
    const otherUserObj = state.users.find(u => u.username === otherUser);
    const displayName = otherUserObj ? otherUserObj.name : otherUser;
    
    document.getElementById('current-conversation-title').textContent = `Conversation avec ${displayName}`;
    
    const container = document.getElementById('chat-messages');
    let html = '';
    
    messages.forEach(message => {
        const isSent = message.sender === state.currentUser.username;
        const time = new Date(message.timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
        
        html += `
            <div class="message-bubble ${isSent ? 'sent' : 'received'}">
                <div class="message-bubble-content">
                    ${message.content}
                </div>
                <div class="message-bubble-time">${time}</div>
            </div>
        `;
        
        if (message.recipient === state.currentUser.username && !message.read) {
            message.read = true;
        }
    });
    
    container.innerHTML = html || '<p>Aucun message</p>';
    container.scrollTop = container.scrollHeight;
    
    document.getElementById('chat-input-container').classList.remove('hidden');
    document.getElementById('message-input').focus();
    
    loadConversations();
    updateMessageBadge();
}

document.getElementById('send-message-btn').addEventListener('click', () => {
    sendMessage();
});

document.getElementById('message-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

function sendMessage() {
    const input = document.getElementById('message-input');
    const content = input.value.trim();
    
    if (!content || !state.currentConversation) {
        alert("Veuillez sélectionner un destinataire et entrer un message!");
        return;
    }
    
    const message = {
        id: 'MSG' + Date.now(),
        sender: state.currentUser.username,
        senderRole: state.currentRole,
        recipient: state.currentConversation,
        recipientRole: state.users.find(u => u.username === state.currentConversation)?.role || '',
        subject: 'Message',
        content: content,
        timestamp: new Date().toISOString(),
        read: false,
        type: 'message'
    };
    
    state.messages.push(message);
    input.value = '';
    
    loadConversation(state.currentConversation);
    updateMessageBadge();
}

document.getElementById('new-conversation-btn').addEventListener('click', () => {
    const recipient = document.getElementById('message-recipient').value;
    if (!recipient) {
        alert("Veuillez sélectionner un destinataire!");
        return;
    }
    
    if (recipient.startsWith('all')) {
        let targetUsers = [];
        
        if (recipient === 'all') {
            targetUsers = state.users.filter(u => u.active && u.username !== state.currentUser.username);
        } else if (recipient === 'all-doctors') {
            targetUsers = state.users.filter(u => u.role === 'doctor' && u.active && u.username !== state.currentUser.username);
        } else if (recipient === 'all-nurses') {
            targetUsers = state.users.filter(u => u.role === 'nurse' && u.active && u.username !== state.currentUser.username);
        } else if (recipient === 'all-secretaries') {
            targetUsers = state.users.filter(u => u.role === 'secretary' && u.active && u.username !== state.currentUser.username);
        } else if (recipient === 'all-cashiers') {
            targetUsers = state.users.filter(u => u.role === 'cashier' && u.active && u.username !== state.currentUser.username);
        } else if (recipient === 'all-labs') {
            targetUsers = state.users.filter(u => u.role === 'lab' && u.active && u.username !== state.currentUser.username);
        } else if (recipient === 'all-pharmacies') {
            targetUsers = state.users.filter(u => u.role === 'pharmacy' && u.active && u.username !== state.currentUser.username);
        } else if (recipient === 'all-admins') {
            targetUsers = state.users.filter(u => u.role === 'admin' && u.active && u.username !== state.currentUser.username);
        }
        
        const messageContent = prompt(`Entrez votre message à ${targetUsers.length} destinataire(s):`);
        if (!messageContent) return;
        
        targetUsers.forEach(user => {
            const message = {
                id: 'MSG' + Date.now(),
                sender: state.currentUser.username,
                senderRole: state.currentRole,
                recipient: user.username,
                recipientRole: user.role,
                subject: `Message à tous les ${user.role}s`,
                content: messageContent,
                timestamp: new Date().toISOString(),
                read: false,
                type: 'broadcast'
            };
            state.messages.push(message);
        });
        
        alert(`Message envoyé à ${targetUsers.length} destinataire(s)!`);
        loadConversations();
        updateMessageBadge();
        document.getElementById('message-recipient').selectedIndex = 0;
        return;
    }
    
    state.currentConversation = recipient;
    loadConversation(recipient);
    document.getElementById('message-recipient').selectedIndex = 0;
});

function updateMessageBadge() {
    const unreadCount = state.messages.filter(m => 
        m.recipient === state.currentUser.username && 
        !m.read
    ).length;
    
    const badge = document.getElementById('message-badge');
    if (unreadCount > 0) {
        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
    
    state.unreadMessages = unreadCount;
}

function checkUnreadMessages() {
    updateMessageBadge();
}

function updateAdminStats() {
    const consultationTransactions = state.transactions.filter(t => t.type === 'consultation');
    const consultationAmount = consultationTransactions.reduce((sum, t) => sum + t.amount, 0);
    document.getElementById('admin-consultations-count').textContent = consultationTransactions.length;
    document.getElementById('admin-consultations-amount').textContent = consultationAmount + ' Gdes';
    
    const labTransactions = state.transactions.filter(t => t.type === 'lab');
    const labAmount = labTransactions.reduce((sum, t) => sum + t.amount, 0);
    document.getElementById('admin-analyses-count').textContent = labTransactions.length;
    document.getElementById('admin-analyses-amount').textContent = labAmount + ' Gdes';
    
    const medTransactions = state.transactions.filter(t => t.type === 'medication');
    const medAmount = medTransactions.reduce((sum, t) => sum + t.amount, 0);
    document.getElementById('admin-medications-count').textContent = medTransactions.length;
    document.getElementById('admin-medications-amount').textContent = medAmount + ' Gdes';
    
    const externalTransactions = state.transactions.filter(t => t.type === 'external');
    const externalAmount = externalTransactions.reduce((sum, t) => sum + t.amount, 0);
    document.getElementById('admin-external-count').textContent = externalTransactions.length;
    document.getElementById('admin-external-amount').textContent = externalAmount + ' Gdes';
    
    const totalRevenue = state.transactions
        .filter(t => t.status === 'paid')
        .reduce((sum, t) => sum + t.amount, 0);
    document.getElementById('admin-total-revenue').textContent = totalRevenue + ' Gdes';
    
    updateRecentTransactions();
}

function updateCharts() {
    const consultationTransactions = state.transactions.filter(t => t.type === 'consultation');
    const labTransactions = state.transactions.filter(t => t.type === 'lab');
    const medTransactions = state.transactions.filter(t => t.type === 'medication');
    const externalTransactions = state.transactions.filter(t => t.type === 'external');
    
    const totalTransactions = consultationTransactions.length + labTransactions.length + medTransactions.length + externalTransactions.length;
    
    if (totalTransactions > 0) {
        const consultationPercentage = Math.round((consultationTransactions.length / totalTransactions) * 100);
        const labPercentage = Math.round((labTransactions.length / totalTransactions) * 100);
        const medPercentage = Math.round((medTransactions.length / totalTransactions) * 100);
        const externalPercentage = Math.round((externalTransactions.length / totalTransactions) * 100);
        
        document.getElementById('consultations-percentage').textContent = consultationPercentage + '%';
        document.getElementById('analyses-percentage').textContent = labPercentage + '%';
        document.getElementById('medications-percentage').textContent = medPercentage + '%';
        document.getElementById('external-percentage').textContent = externalPercentage + '%';
        document.getElementById('total-services-count').textContent = totalTransactions;
        
        const paidTransactions = state.transactions.filter(t => t.status === 'paid').length;
        const unpaidTransactions = state.transactions.filter(t => t.status === 'unpaid').length;
        const total = paidTransactions + unpaidTransactions;
        
        if (total > 0) {
            const paidPercentage = Math.round((paidTransactions / total) * 100);
            const unpaidPercentage = Math.round((unpaidTransactions / total) * 100);
            
            document.getElementById('paid-percentage').textContent = paidPercentage + '%';
            document.getElementById('unpaid-percentage').textContent = unpaidPercentage + '%';
            document.getElementById('paid-chart-bar').style.width = paidPercentage + '%';
            document.getElementById('unpaid-chart-bar').style.width = unpaidPercentage + '%';
        }
    }
    
    updateServicesCharts();
}

function updateServicesCharts() {
    const today = new Date().toISOString().split('T')[0];
    
    const consultationsChart = document.getElementById('consultations-chart');
    const labChart = document.getElementById('analyses-chart');
    const medChart = document.getElementById('medications-chart');
    const externalChart = document.getElementById('external-chart');
    
    const consultationData = [5, 8, 6, 9, 7, 10, 8];
    const labData = [3, 5, 4, 6, 5, 7, 6];
    const medData = [12, 15, 14, 16, 15, 18, 16];
    const externalData = [1, 2, 1, 3, 2, 4, 3];
    
    consultationsChart.innerHTML = createChartHTML(consultationData, 'Consultations');
    labChart.innerHTML = createChartHTML(labData, 'Analyses');
    medChart.innerHTML = createChartHTML(medData, 'Médicaments');
    externalChart.innerHTML = createChartHTML(externalData, 'Services externes');
}

function createChartHTML(data, title) {
    const max = Math.max(...data);
    const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
    
    let html = '<div style="display:flex; height:150px; align-items:flex-end; gap:10px; margin-top:15px;">';
    
    data.forEach((value, index) => {
        const height = (value / max) * 100;
        html += `
            <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
                <div style="width:30px; height:${height}%; background:linear-gradient(to top, #1a6bca, #0d4d9c); border-radius:4px 4px 0 0;"></div>
                <div style="margin-top:5px; font-size:0.8rem; color:#666;">${days[index]}</div>
                <div style="font-size:0.7rem; color:#999;">${value}</div>
            </div>
        `;
    });
    
    html += '</div>';
    return html;
}

function updateRecentTransactions() {
    const recent = [...state.transactions]
        .sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time))
        .slice(0, 10);
    
    const container = document.getElementById('recent-transactions-list');
    let html = '';
    
    recent.forEach(transaction => {
        html += `
            <tr>
                <td>${transaction.date} ${transaction.time}</td>
                <td>${transaction.patientName}<br><small>${transaction.patientId}</small></td>
                <td>${transaction.service}</td>
                <td>${transaction.amount} Gdes</td>
                <td>${transaction.paymentMethod || '-'}</td>
                <td>${transaction.createdBy}</td>
                <td><span class="${transaction.status === 'paid' ? 'status-paid' : 'status-unpaid'}">${transaction.status === 'paid' ? 'Payé' : 'Non payé'}</span></td>
            </tr>
        `;
    });
    
    container.innerHTML = html;
}

function updateSettingsDisplay() {
    const consultationList = document.getElementById('consultation-types-list');
    let html = '<table class="table-container"><thead><tr><th>Nom</th><th>Prix</th><th>Description</th><th>Actif</th><th>Actions</th></tr></thead><tbody>';
    
    state.consultationTypes.forEach(type => {
        html += `
            <tr>
                <td>${type.name}</td>
                <td><input type="number" class="form-control consultation-price-input" data-id="${type.id}" value="${type.price}" style="width:100px;"></td>
                <td><input type="text" class="form-control consultation-desc-input" data-id="${type.id}" value="${type.description}" style="width:200px;"></td>
                <td><input type="checkbox" ${type.active ? 'checked' : ''} onchange="toggleConsultationType(${type.id}, this.checked)"></td>
                <td>
                    <button class="btn btn-sm btn-success" onclick="saveConsultationType(${type.id})">Enregistrer</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteConsultationType(${type.id})">Supprimer</button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    consultationList.innerHTML = html;
    
    const vitalsList = document.getElementById('vitals-types-list');
    html = '<table class="table-container"><thead><tr><th>Nom</th><th>Unité</th><th>Valeur min</th><th>Valeur max</th><th>Actif</th><th>Actions</th></tr></thead><tbody>';
    
    state.vitalTypes.forEach(vital => {
        html += `
            <tr>
                <td>${vital.name}</td>
                <td>${vital.unit}</td>
                <td>${vital.min}</td>
                <td>${vital.max}</td>
                <td><input type="checkbox" ${vital.active ? 'checked' : ''} onchange="toggleVitalType(${vital.id}, this.checked)"></td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="editVitalType(${vital.id})">Modifier</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteVitalType(${vital.id})">Supprimer</button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    vitalsList.innerHTML = html;
    
    const labList = document.getElementById('lab-analyses-types-list');
    html = '<table class="table-container"><thead><tr><th>Nom</th><th>Prix</th><th>Type résultat</th><th>Actif</th><th>Actions</th></tr></thead><tbody>';
    
    state.labAnalysisTypes.forEach(analysis => {
        html += `
            <tr>
                <td>${analysis.name}</td>
                <td><input type="number" class="form-control analysis-price-input" data-id="${analysis.id}" value="${analysis.price}" style="width:100px;"></td>
                <td>${analysis.resultType === 'text' ? 'Texte' : 'Image'}</td>
                <td><input type="checkbox" ${analysis.active ? 'checked' : ''} onchange="toggleLabAnalysisType(${analysis.id}, this.checked)"></td>
                <td>
                    <button class="btn btn-sm btn-success" onclick="saveLabAnalysisType(${analysis.id})">Enregistrer</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteLabAnalysisType(${analysis.id})">Supprimer</button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    labList.innerHTML = html;
    
    const externalList = document.getElementById('external-services-types-list');
    html = '<table class="table-container"><thead><tr><th>Nom</th><th>Prix</th><th>Actif</th><th>Actions</th></tr></thead><tbody>';
    
    state.externalServiceTypes.forEach(service => {
        html += `
            <tr>
                <td>${service.name}</td>
                <td><input type="number" class="form-control external-price-input" data-id="${service.id}" value="${service.price}" style="width:100px;"></td>
                <td><input type="checkbox" ${service.active ? 'checked' : ''} onchange="toggleExternalServiceType(${service.id}, this.checked)"></td>
                <td>
                    <button class="btn btn-sm btn-success" onclick="saveExternalServiceType(${service.id})">Enregistrer</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteExternalServiceType(${service.id})">Supprimer</button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    externalList.innerHTML = html;
    
    updateUsersList();
    
    updateConsultationTypesSelect();
    updateVitalsInputs();
    updateLabAnalysesSelect();
    updateExternalServicesSelect();
    updateExternalServicesOptions();
    updateDoctorConsultationTypes();
    updateMedicationsSettingsList();
}

function updateConsultationTypesSelect() {
    const select = document.getElementById('consultation-type-secretary');
    select.innerHTML = '<option value="">Sélectionner...</option>';
    
    state.consultationTypes.forEach(type => {
        if (type.active) {
            select.innerHTML += `<option value="${type.id}">${type.name} - ${type.price} Gdes</option>`;
        }
    });
}

function updateUsersList() {
    const container = document.getElementById('users-list');
    let html = '';
    
    state.users.forEach(user => {
        html += `
            <tr>
                <td>${user.name}</td>
                <td>${user.role}</td>
                <td>${user.username}</td>
                <td><input type="checkbox" ${user.active ? 'checked' : ''} onchange="toggleUser(${user.id}, this.checked)"></td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="editUser(${user.id})">Modifier</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Supprimer</button>
                </td>
            </tr>
        `;
    });
    
    container.innerHTML = html;
}

document.getElementById('add-consultation-type').addEventListener('click', () => {
    const name = document.getElementById('new-consultation-type-name').value;
    const price = parseFloat(document.getElementById('new-consultation-type-price').value);
    const description = document.getElementById('new-consultation-type-description').value;
    
    if (!name || isNaN(price)) {
        alert("Veuillez entrer un nom et un prix valides!");
        return;
    }
    
    const newType = {
        id: Date.now(),
        name: name,
        price: price,
        description: description,
        active: true
    };
    
    state.consultationTypes.push(newType);
    updateSettingsDisplay();
    
    document.getElementById('new-consultation-type-name').value = '';
    document.getElementById('new-consultation-type-price').value = '';
    document.getElementById('new-consultation-type-description').value = '';
});

function saveConsultationType(id) {
    const type = state.consultationTypes.find(t => t.id === id);
    if (!type) return;
    
    const priceInput = document.querySelector(`.consultation-price-input[data-id="${id}"]`);
    const descInput = document.querySelector(`.consultation-desc-input[data-id="${id}"]`);
    
    type.price = parseFloat(priceInput.value);
    type.description = descInput.value;
    
    alert("Type de consultation enregistré!");
    updateConsultationTypesSelect();
    updateDoctorConsultationTypes();
}

function toggleConsultationType(id, active) {
    const type = state.consultationTypes.find(t => t.id === id);
    if (type) {
        type.active = active;
        updateConsultationTypesSelect();
        updateDoctorConsultationTypes();
    }
}

function deleteConsultationType(id) {
    if (confirm("Supprimer ce type de consultation?")) {
        state.consultationTypes = state.consultationTypes.filter(t => t.id !== id);
        updateSettingsDisplay();
    }
}

document.getElementById('add-vital-type').addEventListener('click', () => {
    const name = document.getElementById('new-vital-name').value;
    const unit = document.getElementById('new-vital-unit').value;
    const min = parseFloat(document.getElementById('new-vital-min').value);
    const max = parseFloat(document.getElementById('new-vital-max').value);
    
    if (!name || !unit || isNaN(min) || isNaN(max)) {
        alert("Veuillez remplir tous les champs correctement!");
        return;
    }
    
    const newVital = {
        id: Date.now(),
        name: name,
        unit: unit,
        min: min,
        max: max,
        active: true
    };
    
    state.vitalTypes.push(newVital);
    updateSettingsDisplay();
});

function toggleVitalType(id, active) {
    const vital = state.vitalTypes.find(v => v.id === id);
    if (vital) {
        vital.active = active;
    }
}

function deleteVitalType(id) {
    if (confirm("Supprimer ce signe vital?")) {
        state.vitalTypes = state.vitalTypes.filter(v => v.id !== id);
        updateSettingsDisplay();
    }
}

document.getElementById('add-lab-analysis-type').addEventListener('click', () => {
    const name = document.getElementById('new-lab-analysis-name').value;
    const price = parseFloat(document.getElementById('new-lab-analysis-price').value);
    const type = document.getElementById('new-lab-analysis-type').value;
    
    if (!name || isNaN(price)) {
        alert("Veuillez entrer un nom et un prix valides!");
        return;
    }
    
    const newAnalysis = {
        id: Date.now(),
        name: name,
        price: price,
        resultType: type,
        active: true
    };
    
    state.labAnalysisTypes.push(newAnalysis);
    updateSettingsDisplay();
});

function saveLabAnalysisType(id) {
    const analysis = state.labAnalysisTypes.find(a => a.id === id);
    if (!analysis) return;
    
    const priceInput = document.querySelector(`.analysis-price-input[data-id="${id}"]`);
    analysis.price = parseFloat(priceInput.value);
    
    alert("Analyse enregistrée!");
}

function toggleLabAnalysisType(id, active) {
    const analysis = state.labAnalysisTypes.find(a => a.id === id);
    if (analysis) {
        analysis.active = active;
    }
}

function deleteLabAnalysisType(id) {
    if (confirm("Supprimer cette analyse?")) {
        state.labAnalysisTypes = state.labAnalysisTypes.filter(a => a.id !== id);
        updateSettingsDisplay();
    }
}

document.getElementById('add-external-service-type').addEventListener('click', () => {
    const name = document.getElementById('new-external-service-type-name').value;
    const price = parseFloat(document.getElementById('new-external-service-type-price').value);
    
    if (!name || isNaN(price)) {
        alert("Veuillez entrer un nom et un prix valides!");
        return;
    }
    
    const newService = {
        id: Date.now(),
        name: name,
        price: price,
        active: true
    };
    
    state.externalServiceTypes.push(newService);
    updateSettingsDisplay();
    updateExternalServicesSelect();
    updateExternalServicesOptions();
});

function saveExternalServiceType(id) {
    const service = state.externalServiceTypes.find(s => s.id == id);
    if (!service) return;
    
    const priceInput = document.querySelector(`.external-price-input[data-id="${id}"]`);
    service.price = parseFloat(priceInput.value);
    
    alert("Service externe enregistré!");
    updateExternalServicesSelect();
    updateExternalServicesOptions();
}

function toggleExternalServiceType(id, active) {
    const service = state.externalServiceTypes.find(s => s.id == id);
    if (service) {
        service.active = active;
        updateExternalServicesSelect();
        updateExternalServicesOptions();
    }
}

function deleteExternalServiceType(id) {
    if (confirm("Supprimer ce service externe?")) {
        state.externalServiceTypes = state.externalServiceTypes.filter(s => s.id != id);
        updateSettingsDisplay();
        updateExternalServicesSelect();
        updateExternalServicesOptions();
    }
}

document.getElementById('add-user').addEventListener('click', () => {
    const name = document.getElementById('new-user-name').value;
    const role = document.getElementById('new-user-role').value;
    const username = document.getElementById('new-user-username').value;
    const password = document.getElementById('new-user-password').value;
    
    if (!name || !role || !username || !password) {
        alert("Veuillez remplir tous les champs!");
        return;
    }
    
    const newUser = {
        id: Date.now(),
        name: name,
        role: role,
        username: username,
        password: password,
        active: true
    };
    
    state.users.push(newUser);
    updateSettingsDisplay();
    updateMessageRecipients();
    
    document.getElementById('new-user-name').value = '';
    document.getElementById('new-user-role').value = '';
    document.getElementById('new-user-username').value = '';
    document.getElementById('new-user-password').value = '';
});

function toggleUser(id, active) {
    const user = state.users.find(u => u.id === id);
    if (user) {
        user.active = active;
    }
}

function editUser(id) {
    const user = state.users.find(u => u.id === id);
    if (!user) return;
    
    const newPassword = prompt(`Nouveau mot de passe pour ${user.name}:`, user.password);
    if (newPassword !== null) {
        user.password = newPassword;
        alert("Mot de passe modifié!");
        updateSettingsDisplay();
    }
}

function deleteUser(id) {
    if (id <= 7) {
        alert("Impossible de supprimer les utilisateurs par défaut!");
        return;
    }
    
    if (confirm("Supprimer cet utilisateur?")) {
        state.users = state.users.filter(u => u.id !== id);
        updateSettingsDisplay();
        updateMessageRecipients();
    }
}

function updateTodayPatientsList() {
    const today = new Date().toISOString().split('T')[0];
    const todayPatients = state.patients.filter(p => p.registrationDate === today);
    
    const container = document.getElementById('today-patients-list');
    let html = '';
    
    todayPatients.forEach(patient => {
        const consultation = state.transactions.find(t => 
            t.patientId === patient.id && 
            t.type === 'consultation'
        );
        
        let typeBadge = '';
        if (patient.type === 'urgence') {
            typeBadge = '<span class="emergency-patient-tag">Urgence</span>';
        } else if (patient.type === 'pediatrie') {
            typeBadge = '<span class="pediatric-tag">Enfant</span>';
        } else if (patient.type === 'externe') {
            typeBadge = '<span class="external-patient-tag">Externe</span>';
        } else {
            typeBadge = '<span>Normal</span>';
        }
        
        if (patient.vip) {
            typeBadge += ' <span class="vip-tag">VIP</span>';
        } else if (patient.sponsored) {
            typeBadge += ` <span class="vip-tag">SPONSORISÉ (${patient.discountPercentage}%)</span>`;
        }
        
        html += `
            <tr>
                <td>${patient.id}</td>
                <td>${patient.fullName}</td>
                <td>${patient.phone}</td>
                <td>${typeBadge}</td>
                <td>${consultation ? consultation.service : 'Service externe uniquement'}</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="viewPatientCard('${patient.id}')">
                        Carte
                    </button>
                </td>
            </tr>
        `;
    });
    
    container.innerHTML = html;
}

function updateExternalMedications(patientId) {
    const medTransactions = state.transactions.filter(t => 
        t.patientId === patientId && 
        t.type === 'medication' &&
        t.status === 'paid'
    );
    
    const externalMeds = [];
    
    medTransactions.forEach(transaction => {
        const med = state.medicationStock.find(m => m.id === transaction.medicationId);
        if (!med || med.quantity < transaction.quantity) {
            externalMeds.push({
                name: transaction.service.replace('Médicament: ', ''),
                quantity: transaction.quantity,
                needed: transaction.quantity - (med ? med.quantity : 0)
            });
        }
    });
    
    const container = document.getElementById('external-medications-container');
    const list = document.getElementById('external-medications-list');
    
    if (externalMeds.length === 0) {
        container.classList.add('hidden');
        return;
    }
    
    let html = '<p>Les médicaments suivants doivent être achetés ailleurs:</p><ul>';
    externalMeds.forEach(med => {
        html += `<li><strong>${med.name}</strong> - Quantité nécessaire: ${med.needed > 0 ? med.needed : med.quantity}</li>`;
    });
    html += '</ul>';
    
    list.innerHTML = html;
    container.classList.remove('hidden');
}

function generateInvoice() {
    const patient = currentCashierPatient;
    const selectedMethod = document.querySelector('.payment-method.active').dataset.method;
    const given = parseFloat(document.getElementById('amount-given').value);
    const total = parseFloat(document.getElementById('total-to-pay').textContent);
    const change = given - total;
    
    document.getElementById('invoice-hospital-name').textContent = document.getElementById('hospital-name').value;
    document.getElementById('invoice-hospital-address').textContent = document.getElementById('hospital-address').value;
    document.getElementById('invoice-hospital-phone').textContent = document.getElementById('hospital-phone').value;
    
    if (state.hospitalLogo) {
        document.getElementById('invoice-logo').src = state.hospitalLogo;
        document.getElementById('invoice-logo').style.display = 'block';
    }
    
    document.getElementById('invoice-patient-name').textContent = patient.fullName;
    document.getElementById('invoice-patient-id').textContent = patient.id;
    document.getElementById('invoice-date').textContent = new Date().toLocaleDateString('fr-FR');
    document.getElementById('invoice-time').textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    document.getElementById('invoice-total-amount').textContent = total.toFixed(2);
    document.getElementById('invoice-amount-given').textContent = given.toFixed(2) + ' Gdes';
    document.getElementById('invoice-change').textContent = change.toFixed(2) + ' Gdes';
    document.getElementById('invoice-payment-method').textContent = selectedMethod;
    document.getElementById('invoice-number').textContent = 'INV' + Date.now();
    
    let servicesHtml = '';
    selectedServices.forEach(service => {
        servicesHtml += `
            <div class="receipt-item">
                <span>${service.service}</span>
                <span>${service.finalAmount ? service.finalAmount.toFixed(2) : service.amount.toFixed(2)} Gdes</span>
            </div>
        `;
    });
    
    document.getElementById('invoice-services-list').innerHTML = servicesHtml;
    
    const container = document.getElementById('invoice-container');
    container.classList.remove('hidden');
    
    setTimeout(() => {
        window.print();
        container.classList.add('hidden');
        
        document.getElementById('cashier-patient-search').value = '';
        document.getElementById('cashier-patient-details').classList.add('hidden');
        document.getElementById('amount-given').value = '';
        document.getElementById('change-result').textContent = 'Monnaie: 0 Gdes';
        document.getElementById('change-result').style.color = '#28a745';
    }, 500);
}

function updateRoleDashboard() {
    const container = document.getElementById('role-dashboard-content');
    const role = state.currentRole;
    
    let html = '';
    
    if (role === 'admin') {
        html = `
            <div class="stats-container">
                <div class="stat-card clickable-stat" onclick="showSection('secretary')">
                    <div class="stat-icon" style="background:#1a6bca"><i class="fas fa-user-tie"></i></div>
                    <div class="stat-info"><h3>${state.patients.length}</h3><p>Patients enregistrés</p></div>
                </div>
                <div class="stat-card clickable-stat" onclick="showSection('administration')">
                    <div class="stat-icon" style="background:#28a745"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="stat-info">
                        <h3>${state.transactions.filter(t => t.status === 'paid').reduce((sum, t) => sum + t.amount, 0)}</h3>
                        <p>Revenus totaux (Gdes)</p>
                    </div>
                </div>
                <div class="stat-card clickable-stat" onclick="showSection('pharmacy')">
                    <div class="stat-icon" style="background:#dc3545"><i class="fas fa-pills"></i></div>
                    <div class="stat-info">
                        <h3>${state.medicationStock.filter(m => m.quantity <= m.alertThreshold).length}</h3>
                        <p>Médicaments en alerte</p>
                    </div>
                </div>
                <div class="stat-card clickable-stat" onclick="showSection('messaging')">
                    <div class="stat-icon" style="background:#17a2b8"><i class="fas fa-comments"></i></div>
                    <div class="stat-info">
                        <h3>${state.unreadMessages}</h3>
                        <p>Messages non lus</p>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <h3>Activité récente</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Heure</th>
                                <th>Action</th>
                                <th>Utilisateur</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>10:30</td><td>Consultation enregistrée</td><td>doctor</td></tr>
                            <tr><td>10:15</td><td>Paiement effectué</td><td>cashier</td></tr>
                            <tr><td>09:45</td><td>Nouveau patient</td><td>secretary</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    } else if (role === 'secretary') {
        const today = new Date().toISOString().split('T')[0];
        const todayPatients = state.patients.filter(p => p.registrationDate === today);
        
        html = `
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon" style="background:#1a6bca"><i class="fas fa-user-plus"></i></div>
                    <div class="stat-info"><h3>${todayPatients.length}</h3><p>Patients aujourd'hui</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#28a745"><i class="fas fa-file-invoice-dollar"></i></div>
                    <div class="stat-info">
                        <h3>${state.transactions.filter(t => t.type === 'external' && t.status === 'unpaid').length}</h3>
                        <p>Services externes en attente</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#ffc107"><i class="fas fa-calendar-alt"></i></div>
                    <div class="stat-info">
                        <h3>${state.appointments.filter(a => a.date >= today).length}</h3>
                        <p>Rendez-vous programmés</p>
                    </div>
                </div>
                <div class="stat-card clickable-stat" onclick="showSection('messaging')">
                    <div class="stat-icon" style="background:#17a2b8"><i class="fas fa-comments"></i></div>
                    <div class="stat-info">
                        <h3>${state.unreadMessages}</h3>
                        <p>Messages non lus</p>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <h3>Patients récemment enregistrés</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nom</th>
                                <th>Heure</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${todayPatients.slice(0, 5).map(patient => `
                                <tr>
                                    <td>${patient.id}</td>
                                    <td>${patient.fullName}</td>
                                    <td>${patient.registrationTime}</td>
                                    <td>${patient.type}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    } else if (role === 'cashier') {
        const today = new Date().toISOString().split('T')[0];
        const todayTransactions = state.transactions.filter(t => 
            t.status === 'paid' && 
            t.paymentDate === today
        );
        const todayRevenue = todayTransactions.reduce((sum, t) => sum + t.amount, 0);
        
        html = `
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon" style="background:#28a745"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="stat-info"><h3>${todayRevenue}</h3><p>Encaissements aujourd'hui (Gdes)</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#1a6bca"><i class="fas fa-users"></i></div>
                    <div class="stat-info"><h3>${new Set(todayTransactions.map(t => t.patientId)).size}</h3><p>Patients servis</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#ffc107"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="stat-info"><h3>${state.transactions.filter(t => t.status === 'unpaid').length}</h3><p>Services impayés</p></div>
                </div>
                <div class="stat-card clickable-stat" onclick="showSection('messaging')">
                    <div class="stat-icon" style="background:#17a2b8"><i class="fas fa-comments"></i></div>
                    <div class="stat-info">
                        <h3>${state.unreadMessages}</h3>
                        <p>Messages non lus</p>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <h3>Derniers paiements</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Heure</th>
                                <th>Patient</th>
                                <th>Montant</th>
                                <th>Méthode</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${todayTransactions.slice(0, 5).map(transaction => `
                                <tr>
                                    <td>${transaction.paymentTime}</td>
                                    <td>${transaction.patientName}</td>
                                    <td>${transaction.amount} Gdes</td>
                                    <td>${transaction.paymentMethod}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    } else if (role === 'nurse') {
        const today = new Date().toISOString().split('T')[0];
        const todayVitals = state.vitals.filter(v => v.date === today);
        
        html = `
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon" style="background:#17a2b8"><i class="fas fa-heartbeat"></i></div>
                    <div class="stat-info"><h3>${todayVitals.length}</h3><p>Signes vitaux aujourd'hui</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#1a6bca"><i class="fas fa-user-injured"></i></div>
                    <div class="stat-info"><h3>${new Set(todayVitals.map(v => v.patientId)).size}</h3><p>Patients vus</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#28a745"><i class="fas fa-bell"></i></div>
                    <div class="stat-info"><h3>${state.messages.filter(m => m.recipient === state.currentUser.username && !m.read).length}</h3><p>Notifications</p></div>
                </div>
                <div class="stat-card clickable-stat" onclick="showSection('messaging')">
                    <div class="stat-icon" style="background:#17a2b8"><i class="fas fa-comments"></i></div>
                    <div class="stat-info">
                        <h3>${state.unreadMessages}</h3>
                        <p>Messages non lus</p>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <h3>Signes vitaux récents</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>Heure</th>
                                <th>Tension</th>
                                <th>Température</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${todayVitals.slice(0, 5).map(record => {
                                const patient = state.patients.find(p => p.id === record.patientId);
                                const tension = record.values['Tension artérielle'];
                                const temperature = record.values['Température'];
                                return `
                                    <tr>
                                        <td>${patient ? patient.fullName : record.patientId}</td>
                                        <td>${record.time}</td>
                                        <td>${tension ? tension.value + ' ' + tension.unit : '-'}</td>
                                        <td>${temperature ? temperature.value + ' ' + temperature.unit : '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    } else if (role === 'doctor') {
        const today = new Date().toISOString().split('T')[0];
        const todayConsultations = state.consultations.filter(c => c.date === today && c.doctor === state.currentUser.username);
        
        html = `
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon" style="background:#1a6bca"><i class="fas fa-stethoscope"></i></div>
                    <div class="stat-info"><h3>${todayConsultations.length}</h3><p>Consultations aujourd'hui</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#28a745"><i class="fas fa-prescription"></i></div>
                    <div class="stat-info"><h3>${state.transactions.filter(t => t.type === 'medication' && t.createdBy === state.currentUser.username).length}</h3><p>Prescriptions</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#ffc107"><i class="fas fa-calendar-alt"></i></div>
                    <div class="stat-info"><h3>${state.appointments.filter(a => a.doctor === state.currentUser.username && a.date >= today).length}</h3><p>Rendez-vous</p></div>
                </div>
                <div class="stat-card clickable-stat" onclick="showSection('messaging')">
                    <div class="stat-icon" style="background:#17a2b8"><i class="fas fa-comments"></i></div>
                    <div class="stat-info">
                        <h3>${state.unreadMessages}</h3>
                        <p>Messages non lus</p>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <h3>Consultations récentes</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>Heure</th>
                                <th>Diagnostic</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${todayConsultations.slice(0, 5).map(consultation => `
                                <tr>
                                    <td>${consultation.patientName}</td>
                                    <td>${consultation.time}</td>
                                    <td>${consultation.diagnosis.substring(0, 50)}${consultation.diagnosis.length > 50 ? '...' : ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    } else if (role === 'lab') {
        const pendingAnalyses = state.transactions.filter(t => 
            t.type === 'lab' && 
            t.status === 'paid' && 
            (!t.labStatus || t.labStatus !== 'completed')
        );
        
        html = `
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon" style="background:#dc3545"><i class="fas fa-flask"></i></div>
                    <div class="stat-info"><h3>${pendingAnalyses.length}</h3><p>Analyses en attente</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#28a745"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-info"><h3>${state.transactions.filter(t => t.type === 'lab' && t.labStatus === 'completed').length}</h3><p>Analyses complétées</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#17a2b8"><i class="fas fa-bell"></i></div>
                    <div class="stat-info"><h3>${state.messages.filter(m => m.recipient === state.currentUser.username && !m.read && m.type === 'lab_result').length}</h3><p>Résultats à communiquer</p></div>
                </div>
                <div class="stat-card clickable-stat" onclick="showSection('messaging')">
                    <div class="stat-icon" style="background:#17a2b8"><i class="fas fa-comments"></i></div>
                    <div class="stat-info">
                        <h3>${state.unreadMessages}</h3>
                        <p>Messages non lus</p>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <h3>Analyses urgentes</h3>
                <div id="pending-analyses-list-dashboard"></div>
            </div>
        `;
        
        const urgentContainer = document.getElementById('pending-analyses-list-dashboard');
        if (pendingAnalyses.length === 0) {
            urgentContainer.innerHTML = '<p>Aucune analyse en attente.</p>';
        } else {
            let urgentHtml = '<table class="table-container"><thead><tr><th>Patient</th><th>Analyse</th><th>Depuis</th></tr></thead><tbody>';
            
            pendingAnalyses.slice(0, 5).forEach(analysis => {
                const hoursAgo = Math.floor((Date.now() - new Date(analysis.date + ' ' + analysis.time)) / (1000 * 60 * 60));
                urgentHtml += `
                    <tr>
                        <td>${analysis.patientName}</td>
                        <td>${analysis.service}</td>
                        <td>${hoursAgo} heure(s)</td>
                    </tr>
                `;
            });
            
            urgentHtml += '</tbody></table>';
            urgentContainer.innerHTML = urgentHtml;
        }
    } else if (role === 'pharmacy') {
        const lowStock = state.medicationStock.filter(med => med.quantity <= med.alertThreshold);
        const pendingDeliveries = state.transactions.filter(t => 
            t.type === 'medication' && 
            t.status === 'paid' && 
            (!t.deliveryStatus || t.deliveryStatus !== 'delivered')
        );
        
        html = `
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon" style="background:#ffc107"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="stat-info"><h3>${lowStock.length}</h3><p>Médicaments en alerte</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#17a2b8"><i class="fas fa-truck"></i></div>
                    <div class="stat-info"><h3>${pendingDeliveries.length}</h3><p>Livraisons en attente</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#28a745"><i class="fas fa-capsules"></i></div>
                    <div class="stat-info"><h3>${state.medicationStock.reduce((sum, med) => sum + med.quantity, 0)}</h3><p>Médicaments en stock</p></div>
                </div>
                <div class="stat-card clickable-stat" onclick="showSection('messaging')">
                    <div class="stat-icon" style="background:#17a2b8"><i class="fas fa-comments"></i></div>
                    <div class="stat-info">
                        <h3>${state.unreadMessages}</h3>
                        <p>Messages non lus</p>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <h3>Médicaments en rupture de stock</h3>
                <div id="low-stock-dashboard"></div>
            </div>
        `;
        
        const lowStockContainer = document.getElementById('low-stock-dashboard');
        const outOfStock = lowStock.filter(med => med.quantity === 0);
        
        if (outOfStock.length === 0) {
            lowStockContainer.innerHTML = '<p>Aucun médicament en rupture de stock.</p>';
        } else {
            let stockHtml = '<table class="table-container"><thead><tr><th>Médicament</th><th>Forme</th><th>Dernière commande</th></tr></thead><tbody>';
            
            outOfStock.slice(0, 5).forEach(med => {
                stockHtml += `
                    <tr class="out-of-stock">
                        <td>${med.name}</td>
                        <td>${med.form}</td>
                        <td>Il y a 7 jours</td>
                    </tr>
                `;
            });
            
            stockHtml += '</tbody></table>';
            lowStockContainer.innerHTML = stockHtml;
        }
    }
    
    container.innerHTML = html;
}

function showSection(sectionId) {
    const tab = document.querySelector(`.nav-tab[data-target="${sectionId}"]`);
    if (tab) {
        tab.click();
    }
}

function viewPatientCard(patientId) {
    const patient = state.patients.find(p => p.id === patientId);
    
    if (!patient) {
        alert("Patient non trouvé!");
        return;
    }
    
    document.getElementById('card-hospital-name').textContent = document.getElementById('hospital-name').value;
    document.getElementById('card-hospital-address').textContent = document.getElementById('hospital-address').value;
    
    if (state.hospitalLogo) {
        document.getElementById('card-logo').src = state.hospitalLogo;
        document.getElementById('card-logo').style.display = 'block';
    }
    
    document.getElementById('card-patient-name').textContent = patient.fullName;
    document.getElementById('card-patient-id').textContent = patient.id;
    document.getElementById('card-patient-dob').textContent = patient.birthDate;
    document.getElementById('card-patient-phone').textContent = patient.phone;
    document.getElementById('card-issue-date').textContent = new Date().toLocaleDateString('fr-FR');
    
    const typeElement = document.getElementById('card-patient-type');
    if (patient.type === 'urgence') {
        typeElement.textContent = 'URGENCE';
        typeElement.className = 'emergency-patient-tag';
    } else if (patient.type === 'pediatrie') {
        typeElement.textContent = 'PÉDIATRIE';
        typeElement.className = 'pediatric-tag';
    } else if (patient.type === 'externe') {
        typeElement.textContent = 'EXTERNE';
        typeElement.className = 'external-patient-tag';
    } else {
        typeElement.textContent = 'STANDARD';
        typeElement.className = '';
    }
    
    if (patient.vip) {
        typeElement.textContent += ' VIP';
        typeElement.classList.add('vip-tag');
    } else if (patient.sponsored) {
        typeElement.textContent += ` SPONSORISÉ (${patient.discountPercentage}%)`;
        typeElement.classList.add('vip-tag');
    }
    
    const container = document.getElementById('patient-card-container');
    container.classList.remove('hidden');
    
    setTimeout(() => {
        window.print();
        container.classList.add('hidden');
    }, 500);
}

function loadDemoData() {
    state.patients.push(
        {
            id: 'PAT0001',
            fullName: 'Jean Dupont',
            birthDate: '1980-05-15',
            address: '123 Rue Principale, Port-au-Prince',
            phone: '1234-5678',
            responsible: '',
            type: 'normal',
            vip: false,
            sponsored: false,
            discountPercentage: 0,
            registrationDate: new Date().toISOString().split('T')[0],
            registrationTime: '08:30',
            registeredBy: 'secretary'
        },
        {
            id: 'URG0002',
            fullName: 'Marie Curie',
            birthDate: '1992-11-22',
            address: '456 Avenue de la Santé',
            phone: '8765-4321',
            responsible: '',
            type: 'urgence',
            vip: true,
            sponsored: false,
            discountPercentage: 0,
            registrationDate: new Date().toISOString().split('T')[0],
            registrationTime: '09:15',
            registeredBy: 'secretary'
        },
        {
            id: 'PED0003',
            fullName: 'Luc Petit',
            birthDate: '2018-03-10',
            address: '789 Rue des Enfants',
            phone: '2345-6789',
            responsible: 'Sophie Petit',
            type: 'pediatrie',
            vip: false,
            sponsored: true,
            discountPercentage: 20,
            registrationDate: new Date().toISOString().split('T')[0],
            registrationTime: '10:00',
            registeredBy: 'secretary'
        },
        {
            id: 'EXT0004',
            fullName: 'Paul Externe',
            birthDate: '1975-08-20',
            address: '101 Rue Externe',
            phone: '3456-7890',
            responsible: '',
            type: 'externe',
            vip: false,
            sponsored: false,
            discountPercentage: 0,
            registrationDate: new Date().toISOString().split('T')[0],
            registrationTime: '11:00',
            registeredBy: 'secretary'
        }
    );
    
    state.medicationStock.push(
        {
            id: 'MED001',
            name: 'Paracétamol 500mg',
            genericName: 'Acétaminophène',
            form: 'Comprimé',
            quantity: 150,
            unit: 'comprimés',
            alertThreshold: 20,
            price: 5,
            reserved: 0
        },
        {
            id: 'MED002',
            name: 'Amoxicilline 500mg',
            genericName: 'Amoxicilline',
            form: 'Capsule',
            quantity: 80,
            unit: 'capsules',
            alertThreshold: 10,
            price: 15,
            reserved: 0
        },
        {
            id: 'MED003',
            name: 'Ibuprofène 400mg',
            genericName: 'Ibuprofène',
            form: 'Comprimé',
            quantity: 5,
            unit: 'comprimés',
            alertThreshold: 10,
            price: 8,
            reserved: 0
        },
        {
            id: 'MED004',
            name: 'Métronidazole 250mg',
            genericName: 'Métronidazole',
            form: 'Comprimé',
            quantity: 0,
            unit: 'comprimés',
            alertThreshold: 10,
            price: 12,
            reserved: 0
        }
    );
    
    state.transactions.push(
        {
            id: 'TR0001',
            patientId: 'PAT0001',
            patientName: 'Jean Dupont',
            service: 'Consultation: Consultation générale',
            amount: 500,
            status: 'paid',
            date: new Date().toISOString().split('T')[0],
            time: '08:45',
            createdBy: 'secretary',
            type: 'consultation',
            paymentMethod: 'cash',
            paymentDate: new Date().toISOString().split('T')[0],
            paymentTime: '09:00',
            paymentAgent: 'cashier'
        },
        {
            id: 'TR0002',
            patientId: 'URG0002',
            patientName: 'Marie Curie',
            service: 'Consultation: Urgence',
            amount: 1000,
            status: 'paid',
            date: new Date().toISOString().split('T')[0],
            time: '09:30',
            createdBy: 'secretary',
            type: 'consultation',
            paymentMethod: 'vip',
            paymentDate: new Date().toISOString().split('T')[0],
            paymentTime: '09:30',
            paymentAgent: 'system'
        },
        {
            id: 'EXT0001',
            patientId: 'EXT0004',
            patientName: 'Paul Externe',
            service: 'Service externe: Ambulance',
            amount: 1500,
            status: 'unpaid',
            date: new Date().toISOString().split('T')[0],
            time: '11:15',
            createdBy: 'secretary',
            type: 'external',
            notificationSent: true
        }
    );
    
    state.vitals.push(
        {
            patientId: 'PAT0001',
            date: new Date().toISOString().split('T')[0],
            time: '09:00',
            takenBy: 'nurse',
            values: {
                'Tension artérielle': { value: '120/80', unit: 'mmHg', normalRange: '90 - 140' },
                'Température': { value: '37.2', unit: '°C', normalRange: '36 - 38' },
                'Pouls': { value: '72', unit: 'bpm', normalRange: '60 - 100' }
            }
        }
    );
    
    state.consultations.push(
        {
            id: 'CONS0001',
            patientId: 'PAT0001',
            patientName: 'Jean Dupont',
            doctor: 'doctor',
            date: new Date().toISOString().split('T')[0],
            time: '09:30',
            diagnosis: 'Fièvre légère et maux de tête. Pas de signes alarmants.',
            followupDate: '',
            followupTime: ''
        }
    );
    
    state.appointments.push(
        {
            id: 'APP0001',
            patientId: 'PAT0001',
            patientName: 'Jean Dupont',
            date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
            time: '10:00',
            reason: 'Contrôle post-consultation',
            doctor: 'doctor',
            createdBy: 'secretary',
            status: 'scheduled'
        }
    );
    
    state.messages.push(
        {
            id: 'MSG0001',
            sender: 'secretary',
            senderRole: 'secretary',
            recipient: 'doctor',
            recipientRole: 'doctor',
            subject: 'Nouveau patient urgent',
            content: 'Patient Marie Curie (URG0002) nécessite une consultation urgente.',
            timestamp: new Date().toISOString(),
            read: false,
            type: 'notification'
        },
        {
            id: 'MSG0002',
            sender: 'doctor',
            senderRole: 'doctor',
            recipient: 'nurse',
            recipientRole: 'nurse',
            subject: 'Signes vitaux',
            content: 'Veuillez prendre les signes vitaux du patient PAT0001 avant la consultation.',
            timestamp: new Date().toISOString(),
            read: false,
            type: 'notification'
        }
    );
    
    state.patientCounter = 5;
    state.transactionCounter = 4;
}
</script>
</body>
</html>