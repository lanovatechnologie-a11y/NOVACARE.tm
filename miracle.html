<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miracle de Dieu Distribution - Gestion</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset et styles généraux */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Header */
        header {
            background-color: var(--primary);
            color: white;
            padding: 15px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 1.8rem;
            color: var(--secondary);
        }

        .logo h1 {
            font-size: 1.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            font-weight: 600;
        }

        .logout-btn {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .logout-btn:hover {
            background-color: #c0392b;
        }

        /* Navigation */
        nav {
            background-color: var(--dark);
            padding: 10px 0;
        }

        .nav-tabs {
            display: flex;
            list-style: none;
            overflow-x: auto;
        }

        .nav-tabs li {
            margin-right: 2px;
        }

        .nav-tabs a {
            display: block;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            background-color: #34495e;
            border-radius: 4px 4px 0 0;
            transition: background-color 0.3s;
            white-space: nowrap;
        }

        .nav-tabs a:hover, .nav-tabs a.active {
            background-color: var(--secondary);
        }

        /* Main content */
        main {
            padding: 20px 0;
            min-height: calc(100vh - 180px);
        }

        /* Dashboard */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .card-icon {
            font-size: 2.5rem;
            color: var(--secondary);
            margin-bottom: 15px;
        }

        .card.warning {
            border-left: 5px solid var(--warning);
        }

        .card.danger {
            border-left: 5px solid var(--danger);
        }

        .card.success {
            border-left: 5px solid var(--success);
        }

        /* Tables */
        .table-container {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            text-align: left;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .stock-low {
            background-color: #ffeaa7;
        }

        .stock-critical {
            background-color: #fab1a0;
        }

        /* Forms */
        .form-container {
            background-color: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #219653;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Login page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }

        .login-box {
            background-color: white;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 20px;
            color: var(--secondary);
        }

        .login-logo i {
            font-size: 3rem;
        }

        .user-type-selector {
            display: flex;
            margin-bottom: 20px;
            border-radius: 4px;
            overflow: hidden;
        }

        .user-type {
            flex: 1;
            text-align: center;
            padding: 10px;
            background-color: #f8f9fa;
            cursor: pointer;
            border: 1px solid #ddd;
        }

        .user-type.active {
            background-color: var(--secondary);
            color: white;
        }

        /* Alertes */
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .alert-warning {
            background-color: #fff3cd;
            border-left: 5px solid var(--warning);
        }

        .alert-danger {
            background-color: #f8d7da;
            border-left: 5px solid var(--danger);
        }

        .alert i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        /* Fiche de vente */
        .invoice {
            background-color: white;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .company-info h2 {
            color: var(--primary);
            margin-bottom: 5px;
        }

        .invoice-details {
            text-align: right;
        }

        .invoice-title {
            text-align: center;
            margin: 30px 0;
            color: var(--dark);
        }

        .invoice-items {
            margin: 30px 0;
        }

        .invoice-total {
            text-align: right;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .print-btn {
            text-align: center;
            margin-top: 30px;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .dashboard-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                justify-content: flex-start;
            }
            
            .invoice-header {
                flex-direction: column;
                gap: 20px;
            }
            
            .company-info, .invoice-details {
                text-align: center;
            }
        }

        @media print {
            header, nav, .no-print {
                display: none !important;
            }
            
            .invoice {
                box-shadow: none;
                padding: 0;
            }
            
            body {
                background-color: white;
            }
        }

        /* Onglets cachés */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Page de connexion -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-gem"></i>
            </div>
            <h2 class="login-title">Miracle de Dieu Distribution</h2>
            
            <div class="user-type-selector">
                <div class="user-type active" id="adminType">Administrateur</div>
                <div class="user-type" id="sellerType">Vendeur</div>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Nom d'utilisateur</label>
                    <input type="text" id="username" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Mot de passe</label>
                    <input type="password" id="password" required>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">Se connecter</button>
            </form>
            
            <div style="text-align: center; margin-top: 20px; color: #777; font-size: 0.9rem;">
                <p>Admin: admin / 1234 | Vendeur: vendeur1 / 1234</p>
            </div>
        </div>
    </div>
    
    <!-- Interface principale (cachée au début) -->
    <div id="mainApp" style="display: none;">
        <!-- Header -->
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <i class="fas fa-gem"></i>
                        <h1>Miracle de Dieu Distribution</h1>
                    </div>
                    <div class="user-info">
                        <span id="currentUser">Administrateur</span>
                        <span id="currentRole">(Admin)</span>
                        <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Déconnexion</button>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Navigation -->
        <nav>
            <div class="container">
                <ul class="nav-tabs" id="navTabs">
                    <!-- Les onglets seront générés par JavaScript selon le rôle -->
                </ul>
            </div>
        </nav>
        
        <!-- Contenu principal -->
        <main>
            <div class="container">
                <!-- Dashboard Admin -->
                <div id="dashboardTab" class="tab-content active">
                    <h2 style="margin-bottom: 20px;">Tableau de Bord</h2>
                    
                    <div class="dashboard-cards">
                        <div class="card">
                            <div class="card-icon">
                                <i class="fas fa-boxes"></i>
                            </div>
                            <div class="card-title">Produits en stock</div>
                            <div class="card-value" id="totalProducts">0</div>
                        </div>
                        
                        <div class="card warning">
                            <div class="card-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="card-title">Alertes de stock</div>
                            <div class="card-value" id="alertsCount">0</div>
                        </div>
                        
                        <div class="card">
                            <div class="card-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="card-title">Employés</div>
                            <div class="card-value" id="totalEmployees">5</div>
                        </div>
                        
                        <div class="card success">
                            <div class="card-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="card-title">Ventes du mois</div>
                            <div class="card-value" id="monthSales">0</div>
                        </div>
                    </div>
                    
                    <!-- Alertes de stock -->
                    <div id="stockAlertsContainer" style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px;">Alertes de stock</h3>
                        <div class="table-container">
                            <table id="stockAlertsTable">
                                <thead>
                                    <tr>
                                        <th>Produit</th>
                                        <th>Catégorie</th>
                                        <th>Stock actuel</th>
                                        <th>Seuil d'alerte</th>
                                        <th>Statut</th>
                                    </tr>
                                </thead>
                                <tbody id="stockAlertsBody">
                                    <!-- Les alertes seront générées par JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Statistiques -->
                    <div style="margin-top: 40px;">
                        <h3 style="margin-bottom: 15px;">Statistiques des ventes</h3>
                        <div class="table-container">
                            <canvas id="salesChart" height="100"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Gestion des stocks -->
                <div id="stockTab" class="tab-content">
                    <h2 style="margin-bottom: 20px;">Gestion des stocks</h2>
                    
                    <div class="form-container">
                        <h3 style="margin-bottom: 20px;">Ajouter/Modifier un produit</h3>
                        <form id="productForm">
                            <input type="hidden" id="productId">
                            
                            <div class="form-group">
                                <label for="productName">Nom du produit</label>
                                <input type="text" id="productName" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="productCategory">Catégorie</label>
                                <select id="productCategory" required>
                                    <option value="">Sélectionner une catégorie</option>
                                    <option value="Électronique">Électronique</option>
                                    <option value="Électroménager">Électroménager</option>
                                    <option value="Accessoires téléphone">Accessoires téléphone</option>
                                    <option value="Autre">Autre</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="productPrice">Prix (MGA)</label>
                                <input type="number" id="productPrice" required min="0" step="100">
                            </div>
                            
                            <div class="form-group">
                                <label for="productStock">Quantité en stock</label>
                                <input type="number" id="productStock" required min="0">
                            </div>
                            
                            <div class="form-group">
                                <label for="productAlert">Seuil d'alerte</label>
                                <input type="number" id="productAlert" required min="1">
                                <small style="color: var(--gray);">Alerte quand le stock est inférieur à cette valeur</small>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary" id="saveProductBtn">Enregistrer</button>
                                <button type="button" class="btn btn-danger" id="cancelProductBtn" style="display: none;">Annuler</button>
                            </div>
                        </form>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px;">Liste des produits</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Produit</th>
                                        <th>Catégorie</th>
                                        <th>Prix (MGA)</th>
                                        <th>Stock</th>
                                        <th>Seuil d'alerte</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="productsList">
                                    <!-- Les produits seront générés par JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Gestion des employés -->
                <div id="employeesTab" class="tab-content">
                    <h2 style="margin-bottom: 20px;">Gestion des employés</h2>
                    
                    <div class="form-container">
                        <h3 style="margin-bottom: 20px;">Ajouter/Modifier un employé</h3>
                        <form id="employeeForm">
                            <input type="hidden" id="employeeId">
                            
                            <div class="form-group">
                                <label for="employeeName">Nom complet</label>
                                <input type="text" id="employeeName" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="employeePhone">Téléphone</label>
                                <input type="text" id="employeePhone">
                            </div>
                            
                            <div class="form-group">
                                <label for="employeeEmail">Email</label>
                                <input type="email" id="employeeEmail">
                            </div>
                            
                            <div class="form-group">
                                <label for="employeeRole">Rôle</label>
                                <select id="employeeRole" required>
                                    <option value="">Sélectionner un rôle</option>
                                    <option value="Vendeur">Vendeur</option>
                                    <option value="Gestionnaire">Gestionnaire</option>
                                    <option value="Administrateur">Administrateur</option>
                                </select>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary" id="saveEmployeeBtn">Enregistrer</button>
                                <button type="button" class="btn btn-danger" id="cancelEmployeeBtn" style="display: none;">Annuler</button>
                            </div>
                        </form>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px;">Liste des employés</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Téléphone</th>
                                        <th>Email</th>
                                        <th>Rôle</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="employeesList">
                                    <!-- Les employés seront générés par JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Gestion des remises -->
                <div id="discountsTab" class="tab-content">
                    <h2 style="margin-bottom: 20px;">Gestion des remises</h2>
                    
                    <div class="form-container">
                        <h3 style="margin-bottom: 20px;">Créer une remise</h3>
                        <form id="discountForm">
                            <input type="hidden" id="discountId">
                            
                            <div class="form-group">
                                <label for="discountName">Nom de la remise</label>
                                <input type="text" id="discountName" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="discountType">Type de remise</label>
                                <select id="discountType" required>
                                    <option value="">Sélectionner un type</option>
                                    <option value="Pourcentage">Pourcentage (%)</option>
                                    <option value="Montant fixe">Montant fixe (MGA)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="discountValue">Valeur</label>
                                <input type="number" id="discountValue" required min="0">
                            </div>
                            
                            <div class="form-group">
                                <label for="discountProduct">Produit concerné</label>
                                <select id="discountProduct">
                                    <option value="">Tous les produits</option>
                                    <!-- Options seront ajoutées par JavaScript -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="discountExpiry">Date d'expiration</label>
                                <input type="date" id="discountExpiry">
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary" id="saveDiscountBtn">Enregistrer</button>
                                <button type="button" class="btn btn-danger" id="cancelDiscountBtn" style="display: none;">Annuler</button>
                            </div>
                        </form>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px;">Remises actives</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Type</th>
                                        <th>Valeur</th>
                                        <th>Produit</th>
                                        <th>Expiration</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="discountsList">
                                    <!-- Les remises seront générées par JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Interface vente -->
                <div id="salesTab" class="tab-content">
                    <h2 style="margin-bottom: 20px;">Nouvelle vente</h2>
                    
                    <div class="alert alert-warning no-print" id="stockWarning" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="warningMessage"></span>
                    </div>
                    
                    <div class="form-container">
                        <div class="form-group">
                            <label for="productSearch">Rechercher un produit</label>
                            <input type="text" id="productSearch" placeholder="Tapez le nom du produit...">
                            <div id="searchResults" style="margin-top: 10px; display: none;">
                                <!-- Résultats de recherche -->
                            </div>
                        </div>
                        
                        <h3 style="margin-bottom: 15px; margin-top: 30px;">Produits ajoutés</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Produit</th>
                                        <th>Prix unitaire</th>
                                        <th>Quantité</th>
                                        <th>Remise</th>
                                        <th>Sous-total</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="cartItems">
                                    <!-- Les produits ajoutés au panier -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 20px; text-align: right;">
                            <h3>Total: <span id="cartTotal">0</span> MGA</h3>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                            <button class="btn btn-danger" id="clearCartBtn">Vider le panier</button>
                            <button class="btn btn-success" id="completeSaleBtn">Finaliser la vente</button>
                        </div>
                    </div>
                    
                    <!-- Historique des ventes -->
                    <div style="margin-top: 40px;">
                        <h3 style="margin-bottom: 15px;">Historique des ventes</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Numéro</th>
                                        <th>Date</th>
                                        <th>Produits</th>
                                        <th>Montant</th>
                                        <th>Vendeur</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="salesHistory">
                                    <!-- Historique des ventes -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Fiche de vente -->
                <div id="invoiceTab" class="tab-content">
                    <div class="print-btn no-print">
                        <button class="btn btn-primary" id="printInvoiceBtn"><i class="fas fa-print"></i> Imprimer la fiche</button>
                        <button class="btn btn-danger" id="closeInvoiceBtn">Fermer</button>
                    </div>
                    
                    <div class="invoice" id="invoiceContent">
                        <!-- Contenu de la fiche de vente généré par JavaScript -->
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer style="background-color: var(--primary); color: white; padding: 20px 0; text-align: center; margin-top: 30px;">
            <div class="container">
                <p>Miracle de Dieu Distribution &copy; <span id="currentYear"></span> - Téléphone: 47 95 9272</p>
                <p>Matériels électroniques, électroménagers et accessoires téléphone</p>
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Données initiales
        const initialData = {
            users: [
                { id: 1, username: 'admin', password: '1234', name: 'Administrateur', role: 'admin' },
                { id: 2, username: 'vendeur1', password: '1234', name: 'Jean Rakoto', role: 'seller' },
                { id: 3, username: 'vendeur2', password: '1234', name: 'Marie Ravao', role: 'seller' },
                { id: 4, username: 'vendeur3', password: '1234', name: 'Paul Randria', role: 'seller' },
                { id: 5, username: 'vendeur4', password: '1234', name: 'Sophie Rasoa', role: 'seller' },
                { id: 6, username: 'vendeur5', password: '1234', name: 'Luc Rajerison', role: 'seller' }
            ],
            
            employees: [
                { id: 1, name: 'Jean Rakoto', phone: '034 12 345 67', email: 'jean@example.com', role: 'Vendeur' },
                { id: 2, name: 'Marie Ravao', phone: '032 23 456 78', email: 'marie@example.com', role: 'Vendeur' },
                { id: 3, name: 'Paul Randria', phone: '033 34 567 89', email: 'paul@example.com', role: 'Vendeur' },
                { id: 4, name: 'Sophie Rasoa', phone: '038 45 678 90', email: 'sophie@example.com', role: 'Vendeur' },
                { id: 5, name: 'Luc Rajerison', phone: '039 56 789 01', email: 'luc@example.com', role: 'Vendeur' }
            ],
            
            products: [
                { id: 1, name: 'Smartphone Samsung A10', category: 'Électronique', price: 350000, stock: 15, alertThreshold: 5 },
                { id: 2, name: 'Télévision LED 32"', category: 'Électronique', price: 800000, stock: 8, alertThreshold: 3 },
                { id: 3, name: 'Réfrigérateur 200L', category: 'Électroménager', price: 1200000, stock: 5, alertThreshold: 2 },
                { id: 4, name: 'Casque Bluetooth', category: 'Accessoires téléphone', price: 45000, stock: 25, alertThreshold: 10 },
                { id: 5, name: 'Chargeur rapide', category: 'Accessoires téléphone', price: 25000, stock: 40, alertThreshold: 15 },
                { id: 6, name: 'Four micro-ondes', category: 'Électroménager', price: 450000, stock: 12, alertThreshold: 4 },
                { id: 7, name: 'Tablette Android', category: 'Électronique', price: 600000, stock: 7, alertThreshold: 3 },
                { id: 8, name: 'Étui téléphone', category: 'Accessoires téléphone', price: 15000, stock: 60, alertThreshold: 20 }
            ],
            
            discounts: [
                { id: 1, name: 'Promo été', type: 'Pourcentage', value: 10, productId: null, expiry: '2023-12-31' },
                { id: 2, name: 'Réfrigérateur -20%', type: 'Pourcentage', value: 20, productId: 3, expiry: '2023-11-30' },
                { id: 3, name: 'Remise fidélité', type: 'Montant fixe', value: 5000, productId: null, expiry: '2024-01-31' }
            ],
            
            sales: [
                { 
                    id: 1, 
                    date: '2023-10-15', 
                    sellerId: 2, 
                    sellerName: 'Jean Rakoto',
                    items: [
                        { productId: 1, name: 'Smartphone Samsung A10', price: 350000, quantity: 1, discount: 0 },
                        { productId: 4, name: 'Casque Bluetooth', price: 45000, quantity: 2, discount: 0 }
                    ],
                    total: 440000,
                    invoiceNumber: 'INV-2023-001'
                },
                { 
                    id: 2, 
                    date: '2023-10-16', 
                    sellerId: 3, 
                    sellerName: 'Marie Ravao',
                    items: [
                        { productId: 3, name: 'Réfrigérateur 200L', price: 1200000, quantity: 1, discount: 240000 },
                        { productId: 5, name: 'Chargeur rapide', price: 25000, quantity: 3, discount: 0 }
                    ],
                    total: 975000,
                    invoiceNumber: 'INV-2023-002'
                }
            ]
        };
        
        // État de l'application
        let currentUser = null;
        let currentRole = null;
        let cart = [];
        let nextSaleId = 3;
        let nextInvoiceNumber = 3;
        
        // Initialisation des données dans localStorage
        function initializeData() {
            if (!localStorage.getItem('mdg_users')) {
                localStorage.setItem('mdg_users', JSON.stringify(initialData.users));
            }
            
            if (!localStorage.getItem('mdg_employees')) {
                localStorage.setItem('mdg_employees', JSON.stringify(initialData.employees));
            }
            
            if (!localStorage.getItem('mdg_products')) {
                localStorage.setItem('mdg_products', JSON.stringify(initialData.products));
            }
            
            if (!localStorage.getItem('mdg_discounts')) {
                localStorage.setItem('mdg_discounts', JSON.stringify(initialData.discounts));
            }
            
            if (!localStorage.getItem('mdg_sales')) {
                localStorage.setItem('mdg_sales', JSON.stringify(initialData.sales));
            }
            
            if (!localStorage.getItem('mdg_nextSaleId')) {
                localStorage.setItem('mdg_nextSaleId', nextSaleId);
            } else {
                nextSaleId = parseInt(localStorage.getItem('mdg_nextSaleId'));
            }
            
            if (!localStorage.getItem('mdg_nextInvoiceNumber')) {
                localStorage.setItem('mdg_nextInvoiceNumber', nextInvoiceNumber);
            } else {
                nextInvoiceNumber = parseInt(localStorage.getItem('mdg_nextInvoiceNumber'));
            }
        }
        
        // Récupération des données
        function getUsers() {
            return JSON.parse(localStorage.getItem('mdg_users') || '[]');
        }
        
        function getEmployees() {
            return JSON.parse(localStorage.getItem('mdg_employees') || '[]');
        }
        
        function getProducts() {
            return JSON.parse(localStorage.getItem('mdg_products') || '[]');
        }
        
        function getDiscounts() {
            return JSON.parse(localStorage.getItem('mdg_discounts') || '[]');
        }
        
        function getSales() {
            return JSON.parse(localStorage.getItem('mdg_sales') || '[]');
        }
        
        // Sauvegarde des données
        function saveProducts(products) {
            localStorage.setItem('mdg_products', JSON.stringify(products));
        }
        
        function saveEmployees(employees) {
            localStorage.setItem('mdg_employees', JSON.stringify(employees));
        }
        
        function saveDiscounts(discounts) {
            localStorage.setItem('mdg_discounts', JSON.stringify(discounts));
        }
        
        function saveSales(sales) {
            localStorage.setItem('mdg_sales', JSON.stringify(sales));
            localStorage.setItem('mdg_nextSaleId', nextSaleId);
            localStorage.setItem('mdg_nextInvoiceNumber', nextInvoiceNumber);
        }
        
        // Connexion
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const isAdmin = document.getElementById('adminType').classList.contains('active');
            
            const users = getUsers();
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                // Vérifier si le rôle correspond
                const expectedRole = isAdmin ? 'admin' : 'seller';
                
                if (user.role === expectedRole) {
                    currentUser = user;
                    currentRole = user.role;
                    
                    // Masquer la page de connexion, afficher l'application
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    
                    // Mettre à jour l'interface utilisateur
                    document.getElementById('currentUser').textContent = user.name;
                    document.getElementById('currentRole').textContent = `(${user.role === 'admin' ? 'Administrateur' : 'Vendeur'})`;
                    
                    // Initialiser les onglets selon le rôle
                    initTabs();
                    
                    // Initialiser le tableau de bord
                    if (user.role === 'admin') {
                        initDashboard();
                    } else {
                        // Pour les vendeurs, afficher directement l'onglet des ventes
                        showTab('salesTab');
                    }
                } else {
                    alert(`Veuillez vous connecter en tant que ${isAdmin ? 'Administrateur' : 'Vendeur'}`);
                }
            } else {
                alert('Nom d\'utilisateur ou mot de passe incorrect');
            }
        });
        
        // Sélecteur de type d'utilisateur
        document.getElementById('adminType').addEventListener('click', function() {
            document.getElementById('adminType').classList.add('active');
            document.getElementById('sellerType').classList.remove('active');
        });
        
        document.getElementById('sellerType').addEventListener('click', function() {
            document.getElementById('sellerType').classList.add('active');
            document.getElementById('adminType').classList.remove('active');
        });
        
        // Déconnexion
        document.getElementById('logoutBtn').addEventListener('click', function() {
            currentUser = null;
            currentRole = null;
            cart = [];
            
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            // Réinitialiser le formulaire de connexion
            document.getElementById('loginForm').reset();
        });
        
        // Gestion des onglets
        function initTabs() {
            const navTabs = document.getElementById('navTabs');
            navTabs.innerHTML = '';
            
            if (currentRole === 'admin') {
                // Onglets pour l'administrateur
                const adminTabs = [
                    { id: 'dashboardTab', label: 'Tableau de bord', icon: 'fas fa-tachometer-alt' },
                    { id: 'stockTab', label: 'Gestion des stocks', icon: 'fas fa-boxes' },
                    { id: 'employeesTab', label: 'Gestion des employés', icon: 'fas fa-users' },
                    { id: 'discountsTab', label: 'Gestion des remises', icon: 'fas fa-percentage' },
                    { id: 'salesTab', label: 'Ventes', icon: 'fas fa-shopping-cart' }
                ];
                
                adminTabs.forEach(tab => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="#" data-tab="${tab.id}"><i class="${tab.icon}"></i> ${tab.label}</a>`;
                    navTabs.appendChild(li);
                });
            } else {
                // Onglets pour les vendeurs
                const sellerTabs = [
                    { id: 'salesTab', label: 'Nouvelle vente', icon: 'fas fa-cart-plus' },
                    { id: 'salesHistory', label: 'Mes ventes', icon: 'fas fa-history' }
                ];
                
                sellerTabs.forEach(tab => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="#" data-tab="${tab.id}"><i class="${tab.icon}"></i> ${tab.label}</a>`;
                    navTabs.appendChild(li);
                });
            }
            
            // Activer le premier onglet
            const firstTab = navTabs.querySelector('a');
            if (firstTab) {
                firstTab.classList.add('active');
            }
            
            // Ajouter des écouteurs d'événements
            document.querySelectorAll('[data-tab]').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const tabId = this.getAttribute('data-tab');
                    
                    // Mettre à jour l'onglet actif
                    document.querySelectorAll('[data-tab]').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Afficher le contenu de l'onglet
                    showTab(tabId);
                });
            });
        }
        
        function showTab(tabId) {
            // Masquer tous les onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Afficher l'onglet sélectionné
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
                
                // Initialiser le contenu de l'onglet si nécessaire
                if (tabId === 'dashboardTab') {
                    initDashboard();
                } else if (tabId === 'stockTab') {
                    initStockManagement();
                } else if (tabId === 'employeesTab') {
                    initEmployeesManagement();
                } else if (tabId === 'discountsTab') {
                    initDiscountsManagement();
                } else if (tabId === 'salesTab') {
                    initSalesInterface();
                } else if (tabId === 'salesHistory') {
                    // Pour l'historique des ventes des vendeurs
                    initSalesHistory();
                }
            }
        }
        
        // Tableau de bord
        function initDashboard() {
            const products = getProducts();
            const sales = getSales();
            
            // Calculer les statistiques
            const totalProducts = products.length;
            const alertsCount = products.filter(p => p.stock < p.alertThreshold).length;
            const totalEmployees = getEmployees().length;
            
            // Ventes du mois (exemple)
            const currentMonth = new Date().getMonth();
            const monthSales = sales.filter(s => {
                const saleDate = new Date(s.date);
                return saleDate.getMonth() === currentMonth;
            }).length;
            
            // Mettre à jour les cartes
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('alertsCount').textContent = alertsCount;
            document.getElementById('totalEmployees').textContent = totalEmployees;
            document.getElementById('monthSales').textContent = monthSales;
            
            // Alertes de stock
            const stockAlertsBody = document.getElementById('stockAlertsBody');
            stockAlertsBody.innerHTML = '';
            
            const lowStockProducts = products.filter(p => p.stock < p.alertThreshold);
            
            if (lowStockProducts.length === 0) {
                document.getElementById('stockAlertsContainer').style.display = 'none';
            } else {
                document.getElementById('stockAlertsContainer').style.display = 'block';
                
                lowStockProducts.forEach(product => {
                    const status = product.stock === 0 ? 'Rupture de stock' : 'Stock faible';
                    const rowClass = product.stock === 0 ? 'stock-critical' : 'stock-low';
                    
                    const row = document.createElement('tr');
                    row.className = rowClass;
                    row.innerHTML = `
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>${product.stock}</td>
                        <td>${product.alertThreshold}</td>
                        <td><span class="badge ${product.stock === 0 ? 'badge-danger' : 'badge-warning'}">${status}</span></td>
                    `;
                    stockAlertsBody.appendChild(row);
                });
            }
            
            // Graphique des ventes
            initSalesChart();
        }
        
        // Graphique des ventes
        function initSalesChart() {
            const sales = getSales();
            const ctx = document.getElementById('salesChart').getContext('2d');
            
            // Regrouper les ventes par jour (exemple des 7 derniers jours)
            const last7Days = Array.from({length: 7}, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - i);
                return date.toISOString().split('T')[0];
            }).reverse();
            
            const salesByDay = last7Days.map(day => {
                return sales.filter(s => s.date === day).length;
            });
            
            // Détruire le graphique existant s'il y en a un
            if (window.salesChartInstance) {
                window.salesChartInstance.destroy();
            }
            
            // Créer un nouveau graphique
            window.salesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(date => new Date(date).toLocaleDateString('fr-FR')),
                    datasets: [{
                        label: 'Nombre de ventes',
                        data: salesByDay,
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 2,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // Gestion des stocks
        function initStockManagement() {
            const products = getProducts();
            const productsList = document.getElementById('productsList');
            productsList.innerHTML = '';
            
            // Remplir la liste des produits
            products.forEach(product => {
                const row = document.createElement('tr');
                row.className = product.stock < product.alertThreshold ? 'stock-low' : '';
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>${product.price.toLocaleString()} MGA</td>
                    <td>${product.stock}</td>
                    <td>${product.alertThreshold}</td>
                    <td>
                        <button class="btn btn-primary btn-sm edit-product" data-id="${product.id}">Modifier</button>
                        <button class="btn btn-danger btn-sm delete-product" data-id="${product.id}">Supprimer</button>
                    </td>
                `;
                productsList.appendChild(row);
            });
            
            // Écouteurs d'événements pour les boutons
            document.querySelectorAll('.edit-product').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-id'));
                    const product = products.find(p => p.id === productId);
                    
                    if (product) {
                        // Remplir le formulaire
                        document.getElementById('productId').value = product.id;
                        document.getElementById('productName').value = product.name;
                        document.getElementById('productCategory').value = product.category;
                        document.getElementById('productPrice').value = product.price;
                        document.getElementById('productStock').value = product.stock;
                        document.getElementById('productAlert').value = product.alertThreshold;
                        
                        // Afficher le bouton Annuler
                        document.getElementById('cancelProductBtn').style.display = 'inline-block';
                    }
                });
            });
            
            document.querySelectorAll('.delete-product').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-id'));
                    
                    if (confirm('Êtes-vous sûr de vouloir supprimer ce produit ?')) {
                        const updatedProducts = products.filter(p => p.id !== productId);
                        saveProducts(updatedProducts);
                        initStockManagement();
                    }
                });
            });
            
            // Réinitialiser le formulaire
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('cancelProductBtn').style.display = 'none';
            
            // Écouteur pour le formulaire de produit
            document.getElementById('productForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const productId = document.getElementById('productId').value;
                const name = document.getElementById('productName').value;
                const category = document.getElementById('productCategory').value;
                const price = parseInt(document.getElementById('productPrice').value);
                const stock = parseInt(document.getElementById('productStock').value);
                const alertThreshold = parseInt(document.getElementById('productAlert').value);
                
                let products = getProducts();
                
                if (productId) {
                    // Modification
                    const index = products.findIndex(p => p.id == productId);
                    if (index !== -1) {
                        products[index] = { 
                            ...products[index], 
                            name, 
                            category, 
                            price, 
                            stock, 
                            alertThreshold 
                        };
                    }
                } else {
                    // Ajout
                    const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                    products.push({
                        id: newId,
                        name,
                        category,
                        price,
                        stock,
                        alertThreshold
                    });
                }
                
                saveProducts(products);
                initStockManagement();
                
                // Réinitialiser le formulaire
                document.getElementById('productForm').reset();
                document.getElementById('productId').value = '';
                document.getElementById('cancelProductBtn').style.display = 'none';
                
                alert('Produit enregistré avec succès !');
            });
            
            // Annuler l'édition
            document.getElementById('cancelProductBtn').addEventListener('click', function() {
                document.getElementById('productForm').reset();
                document.getElementById('productId').value = '';
                this.style.display = 'none';
            });
        }
        
        // Gestion des employés
        function initEmployeesManagement() {
            const employees = getEmployees();
            const employeesList = document.getElementById('employeesList');
            employeesList.innerHTML = '';
            
            // Remplir la liste des employés
            employees.forEach(employee => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${employee.name}</td>
                    <td>${employee.phone}</td>
                    <td>${employee.email}</td>
                    <td>${employee.role}</td>
                    <td>
                        <button class="btn btn-primary btn-sm edit-employee" data-id="${employee.id}">Modifier</button>
                        <button class="btn btn-danger btn-sm delete-employee" data-id="${employee.id}">Supprimer</button>
                    </td>
                `;
                employeesList.appendChild(row);
            });
            
            // Écouteurs d'événements pour les boutons
            document.querySelectorAll('.edit-employee').forEach(btn => {
                btn.addEventListener('click', function() {
                    const employeeId = parseInt(this.getAttribute('data-id'));
                    const employee = employees.find(e => e.id === employeeId);
                    
                    if (employee) {
                        // Remplir le formulaire
                        document.getElementById('employeeId').value = employee.id;
                        document.getElementById('employeeName').value = employee.name;
                        document.getElementById('employeePhone').value = employee.phone;
                        document.getElementById('employeeEmail').value = employee.email;
                        document.getElementById('employeeRole').value = employee.role;
                        
                        // Afficher le bouton Annuler
                        document.getElementById('cancelEmployeeBtn').style.display = 'inline-block';
                    }
                });
            });
            
            document.querySelectorAll('.delete-employee').forEach(btn => {
                btn.addEventListener('click', function() {
                    const employeeId = parseInt(this.getAttribute('data-id'));
                    
                    if (confirm('Êtes-vous sûr de vouloir supprimer cet employé ?')) {
                        const updatedEmployees = employees.filter(e => e.id !== employeeId);
                        saveEmployees(updatedEmployees);
                        initEmployeesManagement();
                    }
                });
            });
            
            // Réinitialiser le formulaire
            document.getElementById('employeeForm').reset();
            document.getElementById('employeeId').value = '';
            document.getElementById('cancelEmployeeBtn').style.display = 'none';
            
            // Écouteur pour le formulaire d'employé
            document.getElementById('employeeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const employeeId = document.getElementById('employeeId').value;
                const name = document.getElementById('employeeName').value;
                const phone = document.getElementById('employeePhone').value;
                const email = document.getElementById('employeeEmail').value;
                const role = document.getElementById('employeeRole').value;
                
                let employees = getEmployees();
                
                if (employeeId) {
                    // Modification
                    const index = employees.findIndex(e => e.id == employeeId);
                    if (index !== -1) {
                        employees[index] = { 
                            ...employees[index], 
                            name, 
                            phone, 
                            email, 
                            role 
                        };
                    }
                } else {
                    // Ajout
                    const newId = employees.length > 0 ? Math.max(...employees.map(e => e.id)) + 1 : 1;
                    employees.push({
                        id: newId,
                        name,
                        phone,
                        email,
                        role
                    });
                }
                
                saveEmployees(employees);
                initEmployeesManagement();
                
                // Réinitialiser le formulaire
                document.getElementById('employeeForm').reset();
                document.getElementById('employeeId').value = '';
                document.getElementById('cancelEmployeeBtn').style.display = 'none';
                
                alert('Employé enregistré avec succès !');
            });
            
            // Annuler l'édition
            document.getElementById('cancelEmployeeBtn').addEventListener('click', function() {
                document.getElementById('employeeForm').reset();
                document.getElementById('employeeId').value = '';
                this.style.display = 'none';
            });
        }
        
        // Gestion des remises
        function initDiscountsManagement() {
            const discounts = getDiscounts();
            const products = getProducts();
            const discountsList = document.getElementById('discountsList');
            discountsList.innerHTML = '';
            
            // Remplir les options des produits
            const productSelect = document.getElementById('discountProduct');
            productSelect.innerHTML = '<option value="">Tous les produits</option>';
            
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.name;
                productSelect.appendChild(option);
            });
            
            // Remplir la liste des remises
            discounts.forEach(discount => {
                const productName = discount.productId 
                    ? products.find(p => p.id === discount.productId)?.name || 'N/A'
                    : 'Tous les produits';
                    
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${discount.name}</td>
                    <td>${discount.type}</td>
                    <td>${discount.value} ${discount.type === 'Pourcentage' ? '%' : 'MGA'}</td>
                    <td>${productName}</td>
                    <td>${discount.expiry || 'Sans limite'}</td>
                    <td>
                        <button class="btn btn-primary btn-sm edit-discount" data-id="${discount.id}">Modifier</button>
                        <button class="btn btn-danger btn-sm delete-discount" data-id="${discount.id}">Supprimer</button>
                    </td>
                `;
                discountsList.appendChild(row);
            });
            
            // Écouteurs d'événements pour les boutons
            document.querySelectorAll('.edit-discount').forEach(btn => {
                btn.addEventListener('click', function() {
                    const discountId = parseInt(this.getAttribute('data-id'));
                    const discount = discounts.find(d => d.id === discountId);
                    
                    if (discount) {
                        // Remplir le formulaire
                        document.getElementById('discountId').value = discount.id;
                        document.getElementById('discountName').value = discount.name;
                        document.getElementById('discountType').value = discount.type;
                        document.getElementById('discountValue').value = discount.value;
                        document.getElementById('discountProduct').value = discount.productId || '';
                        document.getElementById('discountExpiry').value = discount.expiry || '';
                        
                        // Afficher le bouton Annuler
                        document.getElementById('cancelDiscountBtn').style.display = 'inline-block';
                    }
                });
            });
            
            document.querySelectorAll('.delete-discount').forEach(btn => {
                btn.addEventListener('click', function() {
                    const discountId = parseInt(this.getAttribute('data-id'));
                    
                    if (confirm('Êtes-vous sûr de vouloir supprimer cette remise ?')) {
                        const updatedDiscounts = discounts.filter(d => d.id !== discountId);
                        saveDiscounts(updatedDiscounts);
                        initDiscountsManagement();
                    }
                });
            });
            
            // Réinitialiser le formulaire
            document.getElementById('discountForm').reset();
            document.getElementById('discountId').value = '';
            document.getElementById('cancelDiscountBtn').style.display = 'none';
            
            // Écouteur pour le formulaire de remise
            document.getElementById('discountForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const discountId = document.getElementById('discountId').value;
                const name = document.getElementById('discountName').value;
                const type = document.getElementById('discountType').value;
                const value = parseInt(document.getElementById('discountValue').value);
                const productId = document.getElementById('discountProduct').value || null;
                const expiry = document.getElementById('discountExpiry').value || null;
                
                let discounts = getDiscounts();
                
                if (discountId) {
                    // Modification
                    const index = discounts.findIndex(d => d.id == discountId);
                    if (index !== -1) {
                        discounts[index] = { 
                            ...discounts[index], 
                            name, 
                            type, 
                            value, 
                            productId: productId ? parseInt(productId) : null, 
                            expiry 
                        };
                    }
                } else {
                    // Ajout
                    const newId = discounts.length > 0 ? Math.max(...discounts.map(d => d.id)) + 1 : 1;
                    discounts.push({
                        id: newId,
                        name,
                        type,
                        value,
                        productId: productId ? parseInt(productId) : null,
                        expiry
                    });
                }
                
                saveDiscounts(discounts);
                initDiscountsManagement();
                
                // Réinitialiser le formulaire
                document.getElementById('discountForm').reset();
                document.getElementById('discountId').value = '';
                document.getElementById('cancelDiscountBtn').style.display = 'none';
                
                alert('Remise enregistrée avec succès !');
            });
            
            // Annuler l'édition
            document.getElementById('cancelDiscountBtn').addEventListener('click', function() {
                document.getElementById('discountForm').reset();
                document.getElementById('discountId').value = '';
                this.style.display = 'none';
            });
        }
        
        // Interface de vente
        function initSalesInterface() {
            cart = [];
            updateCartDisplay();
            
            // Recherche de produits
            document.getElementById('productSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const products = getProducts();
                const searchResults = document.getElementById('searchResults');
                
                if (searchTerm.length < 2) {
                    searchResults.style.display = 'none';
                    return;
                }
                
                const filteredProducts = products.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) && p.stock > 0
                );
                
                if (filteredProducts.length === 0) {
                    searchResults.innerHTML = '<div style="padding: 10px; background-color: #f8f9fa; border-radius: 4px;">Aucun produit trouvé</div>';
                    searchResults.style.display = 'block';
                    return;
                }
                
                let resultsHTML = '<div style="border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto;">';
                
                filteredProducts.forEach(product => {
                    resultsHTML += `
                        <div class="search-result-item" style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" 
                             data-id="${product.id}">
                            <div>
                                <strong>${product.name}</strong><br>
                                <small>${product.category} - Stock: ${product.stock}</small>
                            </div>
                            <div>
                                ${product.price.toLocaleString()} MGA
                                <button class="btn btn-primary btn-sm add-to-cart-btn" style="margin-left: 10px;" data-id="${product.id}">Ajouter</button>
                            </div>
                        </div>
                    `;
                });
                
                resultsHTML += '</div>';
                searchResults.innerHTML = resultsHTML;
                searchResults.style.display = 'block';
                
                // Écouteurs pour les boutons "Ajouter"
                document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const productId = parseInt(this.getAttribute('data-id'));
                        addToCart(productId);
                        document.getElementById('productSearch').value = '';
                        searchResults.style.display = 'none';
                    });
                });
                
                // Écouteurs pour les éléments de résultat
                document.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        if (!e.target.classList.contains('add-to-cart-btn')) {
                            const productId = parseInt(this.getAttribute('data-id'));
                            addToCart(productId);
                            document.getElementById('productSearch').value = '';
                            searchResults.style.display = 'none';
                        }
                    });
                });
            });
            
            // Vider le panier
            document.getElementById('clearCartBtn').addEventListener('click', function() {
                if (cart.length > 0 && confirm('Vider le panier ?')) {
                    cart = [];
                    updateCartDisplay();
                }
            });
            
            // Finaliser la vente
            document.getElementById('completeSaleBtn').addEventListener('click', function() {
                if (cart.length === 0) {
                    alert('Le panier est vide !');
                    return;
                }
                
                // Vérifier les stocks
                const products = getProducts();
                let stockIssue = false;
                let warningMessage = '';
                
                cart.forEach(item => {
                    const product = products.find(p => p.id === item.id);
                    if (product && item.quantity > product.stock) {
                        stockIssue = true;
                        warningMessage += `Stock insuffisant pour ${product.name}. Stock disponible: ${product.stock}, Quantité demandée: ${item.quantity}\n`;
                    }
                });
                
                if (stockIssue) {
                    document.getElementById('warningMessage').textContent = warningMessage;
                    document.getElementById('stockWarning').style.display = 'flex';
                    return;
                }
                
                // Finaliser la vente
                const saleId = nextSaleId++;
                const invoiceNumber = `INV-2023-${nextInvoiceNumber.toString().padStart(3, '0')}`;
                nextInvoiceNumber++;
                
                // Créer la vente
                const sale = {
                    id: saleId,
                    date: new Date().toISOString().split('T')[0],
                    sellerId: currentUser.id,
                    sellerName: currentUser.name,
                    items: cart.map(item => ({
                        productId: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        discount: item.discountAmount || 0
                    })),
                    total: cart.reduce((sum, item) => sum + item.subtotal, 0),
                    invoiceNumber: invoiceNumber
                };
                
                // Mettre à jour les stocks
                cart.forEach(item => {
                    const productIndex = products.findIndex(p => p.id === item.id);
                    if (productIndex !== -1) {
                        products[productIndex].stock -= item.quantity;
                    }
                });
                
                // Sauvegarder les données
                const sales = getSales();
                sales.push(sale);
                saveSales(sales);
                saveProducts(products);
                
                // Générer la fiche de vente
                generateInvoice(sale);
                
                // Réinitialiser le panier
                cart = [];
                updateCartDisplay();
                
                // Afficher la fiche de vente
                showTab('invoiceTab');
            });
            
            // Initialiser l'historique des ventes
            initSalesHistory();
        }
        
        function addToCart(productId) {
            const products = getProducts();
            const product = products.find(p => p.id === productId);
            
            if (!product) return;
            
            // Vérifier si le produit est déjà dans le panier
            const existingItemIndex = cart.findIndex(item => item.id === productId);
            
            if (existingItemIndex !== -1) {
                // Augmenter la quantité
                if (cart[existingItemIndex].quantity < product.stock) {
                    cart[existingItemIndex].quantity++;
                } else {
                    alert(`Stock insuffisant. Maximum disponible: ${product.stock}`);
                    return;
                }
            } else {
                // Ajouter un nouvel élément
                if (product.stock > 0) {
                    cart.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        quantity: 1,
                        discountAmount: 0
                    });
                } else {
                    alert('Ce produit est en rupture de stock');
                    return;
                }
            }
            
            // Appliquer les remises
            applyDiscounts();
            
            updateCartDisplay();
        }
        
        function applyDiscounts() {
            const discounts = getDiscounts();
            const today = new Date().toISOString().split('T')[0];
            
            cart.forEach(item => {
                // Réinitialiser la remise
                item.discountAmount = 0;
                
                // Chercher des remises applicables
                const applicableDiscounts = discounts.filter(d => {
                    // Vérifier la date d'expiration
                    if (d.expiry && d.expiry < today) return false;
                    
                    // Vérifier si la remise s'applique à ce produit
                    return !d.productId || d.productId === item.id;
                });
                
                // Appliquer la remise la plus avantageuse
                if (applicableDiscounts.length > 0) {
                    // Pour simplifier, on prend la première remise
                    const discount = applicableDiscounts[0];
                    
                    if (discount.type === 'Pourcentage') {
                        item.discountAmount = (item.price * discount.value / 100) * item.quantity;
                    } else if (discount.type === 'Montant fixe') {
                        item.discountAmount = discount.value * item.quantity;
                    }
                    
                    // Limiter la remise au prix total de l'article
                    if (item.discountAmount > item.price * item.quantity) {
                        item.discountAmount = item.price * item.quantity;
                    }
                }
            });
        }
        
        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<tr><td colspan="6" style="text-align: center;">Le panier est vide</td></tr>';
                cartTotal.textContent = '0';
                return;
            }
            
            let total = 0;
            
            cart.forEach((item, index) => {
                const subtotal = (item.price * item.quantity) - (item.discountAmount || 0);
                total += subtotal;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.price.toLocaleString()} MGA</td>
                    <td>
                        <button class="btn btn-sm decrease-qty" data-index="${index}" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                        ${item.quantity}
                        <button class="btn btn-sm increase-qty" data-index="${index}">+</button>
                    </td>
                    <td>${item.discountAmount ? item.discountAmount.toLocaleString() + ' MGA' : 'Aucune'}</td>
                    <td>${subtotal.toLocaleString()} MGA</td>
                    <td><button class="btn btn-danger btn-sm remove-item" data-index="${index}">Retirer</button></td>
                `;
                cartItems.appendChild(row);
                
                // Mettre à jour le sous-total de l'élément
                item.subtotal = subtotal;
            });
            
            // Écouteurs pour les boutons de quantité
            document.querySelectorAll('.decrease-qty').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    if (cart[index].quantity > 1) {
                        cart[index].quantity--;
                        applyDiscounts();
                        updateCartDisplay();
                    }
                });
            });
            
            document.querySelectorAll('.increase-qty').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    
                    // Vérifier le stock
                    const products = getProducts();
                    const product = products.find(p => p.id === cart[index].id);
                    
                    if (product && cart[index].quantity < product.stock) {
                        cart[index].quantity++;
                        applyDiscounts();
                        updateCartDisplay();
                    } else {
                        alert(`Stock insuffisant. Maximum disponible: ${product ? product.stock : 0}`);
                    }
                });
            });
            
            // Écouteurs pour les boutons de retrait
            document.querySelectorAll('.remove-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    cart.splice(index, 1);
                    applyDiscounts();
                    updateCartDisplay();
                });
            });
            
            cartTotal.textContent = total.toLocaleString();
        }
        
        function initSalesHistory() {
            const sales = getSales();
            const salesHistory = document.getElementById('salesHistory');
            
            salesHistory.innerHTML = '';
            
            // Filtrer les ventes selon le rôle
            let userSales;
            if (currentRole === 'admin') {
                userSales = sales;
            } else {
                userSales = sales.filter(s => s.sellerId === currentUser.id);
            }
            
            if (userSales.length === 0) {
                salesHistory.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucune vente enregistrée</td></tr>';
                return;
            }
            
            // Trier par date (plus récent en premier)
            userSales.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            userSales.forEach(sale => {
                const productsList = sale.items.map(item => 
                    `${item.quantity}x ${item.name}`
                ).join(', ');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${sale.invoiceNumber}</td>
                    <td>${sale.date}</td>
                    <td>${productsList}</td>
                    <td>${sale.total.toLocaleString()} MGA</td>
                    <td>${sale.sellerName}</td>
                    <td>
                        <button class="btn btn-primary btn-sm view-invoice" data-id="${sale.id}">Voir fiche</button>
                    </td>
                `;
                salesHistory.appendChild(row);
            });
            
            // Écouteurs pour les boutons "Voir fiche"
            document.querySelectorAll('.view-invoice').forEach(btn => {
                btn.addEventListener('click', function() {
                    const saleId = parseInt(this.getAttribute('data-id'));
                    const sales = getSales();
                    const sale = sales.find(s => s.id === saleId);
                    
                    if (sale) {
                        generateInvoice(sale);
                        showTab('invoiceTab');
                    }
                });
            });
        }
        
        function generateInvoice(sale) {
            const invoiceContent = document.getElementById('invoiceContent');
            const today = new Date();
            const formattedDate = today.toLocaleDateString('fr-FR');
            const formattedTime = today.toLocaleTimeString('fr-FR');
            
            // Calculer le total des remises
            const totalDiscount = sale.items.reduce((sum, item) => sum + (item.discount || 0), 0);
            const subtotal = sale.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            let itemsHTML = '';
            sale.items.forEach(item => {
                const itemTotal = (item.price * item.quantity) - (item.discount || 0);
                itemsHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.price.toLocaleString()} MGA</td>
                        <td>${item.quantity}</td>
                        <td>${item.discount ? item.discount.toLocaleString() + ' MGA' : '0 MGA'}</td>
                        <td>${itemTotal.toLocaleString()} MGA</td>
                    </tr>
                `;
            });
            
            invoiceContent.innerHTML = `
                <div class="invoice-header">
                    <div class="company-info">
                        <h2>Miracle de Dieu Distribution</h2>
                        <p>Matériels électroniques, électroménagers et accessoires téléphone</p>
                        <p>Téléphone: 47 95 9272</p>
                        <p>Date: ${formattedDate} à ${formattedTime}</p>
                    </div>
                    <div class="invoice-details">
                        <h3>FICHE DE VENTE</h3>
                        <p><strong>N°:</strong> ${sale.invoiceNumber}</p>
                        <p><strong>Vendeur:</strong> ${sale.sellerName}</p>
                        <p><strong>Date vente:</strong> ${sale.date}</p>
                    </div>
                </div>
                
                <div class="invoice-items">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th style="padding: 10px; text-align: left;">Produit</th>
                                <th style="padding: 10px; text-align: left;">Prix unitaire</th>
                                <th style="padding: 10px; text-align: left;">Quantité</th>
                                <th style="padding: 10px; text-align: left;">Remise</th>
                                <th style="padding: 10px; text-align: left;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                    </table>
                </div>
                
                <div class="invoice-total">
                    <p><strong>Sous-total:</strong> ${subtotal.toLocaleString()} MGA</p>
                    <p><strong>Remise totale:</strong> ${totalDiscount.toLocaleString()} MGA</p>
                    <p><strong>Total à payer:</strong> ${sale.total.toLocaleString()} MGA</p>
                </div>
                
                <div style="margin-top: 40px; text-align: center; font-style: italic;">
                    <p>Merci pour votre confiance !</p>
                    <p>Miracle de Dieu Distribution - Téléphone: 47 95 9272</p>
                </div>
            `;
            
            // Écouteur pour le bouton d'impression
            document.getElementById('printInvoiceBtn').addEventListener('click', function() {
                window.print();
            }, { once: true });
            
            // Écouteur pour le bouton de fermeture
            document.getElementById('closeInvoiceBtn').addEventListener('click', function() {
                // Retourner à l'onglet des ventes
                const navTabs = document.querySelectorAll('[data-tab]');
                navTabs.forEach(tab => {
                    if (tab.getAttribute('data-tab') === 'salesTab') {
                        tab.classList.add('active');
                    } else {
                        tab.classList.remove('active');
                    }
                });
                
                showTab('salesTab');
            }, { once: true });
        }
        
        // Initialiser l'application
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            
            // Mettre à jour l'année dans le footer
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // Afficher la page de connexion par défaut
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        });
    </script>
</body>
</html>